<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wonton Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: #fff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-section {
            padding: 24px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #D84315;
        }

        .role-switcher {
            margin-top: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .role-switcher label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .role-switcher select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-menu {
            padding: 16px 0;
        }

        .menu-item {
            margin-bottom: 4px;
        }

        .menu-item-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item-main:hover {
            background: #f5f5f5;
        }

        .menu-item-main.active {
            background: #FF7043;
            color: white;
        }

        .menu-item-main.active-admin {
            background: #1976D2;
            color: white;
        }

        .menu-item-main.user-access {
            border-left: 3px solid #FF7043;
        }

        .menu-item-main.admin-access {
            border-left: 3px solid #1976D2;
        }

        .menu-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submenu-toggle {
            transition: transform 0.2s;
        }

        .submenu-toggle.expanded {
            transform: rotate(180deg);
        }

        .submenu {
            display: none;
            padding-left: 20px;
            background: #fafafa;
        }

        .submenu.show {
            display: block;
        }

        .submenu-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #666;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submenu-item:hover {
            background: #f0f0f0;
            color: #333;
        }

        .submenu-item.active {
            color: #D84315;
            background: #fff;
            font-weight: 500;
        }

        .submenu-item::before {
            content: '‚ñ™';
            margin-right: 12px;
            color: #999;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 24px;
        }

        .header {
            background: white;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .breadcrumb {
            font-size: 14px;
            color: #666;
        }

        .content-card {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .access-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .access-badge.user {
            background: #FFE0B2;
            color: #E65100;
        }

        .access-badge.admin {
            background: #BBDEFB;
            color: #0D47A1;
        }

        .info-message {
            background: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding: 16px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .info-message h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1565C0;
        }

        .info-message p {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        /* Color coding reference */
        .color-reference {
            display: flex;
            gap: 24px;
            margin-top: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .color-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .color-box.orange {
            background: #FF7043;
        }

        .color-box.blue {
            background: #1976D2;
        }

        /* Product Management Styles */
        .product-section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-edit {
            background: #FF9800;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-edit:hover {
            background: #F57C00;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon-danger {
            background: transparent;
            color: #f44336;
            border: 1px solid #f44336;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-icon-danger:hover {
            background: #f44336;
            color: white;
            transform: scale(1.1);
        }

        .product-form {
            background: #f9f9f9;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
        }

        .product-form.show {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #f44336;
            margin-left: 4px;
        }

        .form-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976D2;
        }

        .form-input:disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .form-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #1976D2;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .product-table thead {
            background: #f5f5f5;
        }

        .product-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-table td {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .product-table tr:hover {
            background: #fafafa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-inactive {
            background: #FFEBEE;
            color: #C62828;
        }

        .status-on-leave {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .status-resigned {
            background: #F5F5F5;
            color: #616161;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            color: #666;
        }

        /* Production Record Styles */
        .production-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 4px;
        }

        .date-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .round-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .round-btn {
            padding: 6px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .round-btn:hover {
            border-color: #1976D2;
            background: #E3F2FD;
        }

        .round-btn.active {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .round-btn.new-round {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .round-btn.new-round:hover {
            background: #45a049;
        }

        .day-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .day-status-badge.open {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .day-status-badge.closed {
            background: #FFEBEE;
            color: #C62828;
        }

        .btn-close-day {
            background: #F44336;
            color: white;
        }

        .btn-close-day:hover {
            background: #D32F2F;
        }

        .btn-reopen-day {
            background: #FF9800;
            color: white;
        }

        .btn-reopen-day:hover {
            background: #F57C00;
        }

        .entry-grid {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .entry-grid-header {
            display: grid;
            grid-template-columns: 80px 200px 200px 120px 200px 80px;
            gap: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }

        .entry-row {
            display: grid;
            grid-template-columns: 80px 200px 200px 120px 200px 80px;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .entry-row:hover {
            background: #fafafa;
        }

        .entry-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .entry-input:focus {
            outline: none;
            border-color: #1976D2;
        }

        .entry-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid;
        }

        .summary-card.total {
            border-left-color: #1976D2;
        }

        .summary-card.employee {
            border-left-color: #4CAF50;
        }

        .summary-card.product {
            border-left-color: #FF9800;
        }

        .summary-card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .summary-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .quality-status-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .quality-row {
            display: grid;
            grid-template-columns: 150px 150px 150px 150px 1fr;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .quality-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .quality-ok {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .quality-not-ok {
            background: #FFEBEE;
            color: #C62828;
        }

        .quality-pending {
            background: #FFF3E0;
            color: #EF6C00;
        }

        /* New Production Entry Styles */
        .production-sticky-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .production-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .production-header-row:last-child {
            margin-bottom: 0;
        }

        .header-controls-left,
        .header-controls-right {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .round-selector-inline {
            display: flex;
            flex-direction: row;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .round-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .round-status-badge.draft {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .round-status-badge.saved {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .round-status-badge.signed-off {
            background: #E3F2FD;
            color: #1565C0;
        }

        /* Compact sign-off status badge in header */
        .signoff-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .signoff-status-badge.not-signed {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .signoff-status-badge.signed {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .day-detail-view {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Two-column layout for entry area */
        .entry-content-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .entry-column-left {
            flex: 1;
            min-width: 0;
        }

        .entry-column-right {
            flex: 0 0 320px;
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        /* Responsive: stack on smaller screens */
        @media (max-width: 1024px) {
            .entry-content-wrapper {
                flex-direction: column;
            }

            .entry-column-right {
                flex: 1;
                width: 100%;
                position: static;
                max-height: none;
            }
        }

        .product-dashboard {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .product-dashboard h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .product-dashboard-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .product-card {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .product-card-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .product-card-value {
            font-size: 24px;
            font-weight: 700;
            color: #1976D2;
        }

        .product-card-label {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .draft-indicator {
            margin-top: 16px;
            padding: 8px 12px;
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            border-radius: 4px;
            font-size: 13px;
            color: #EF6C00;
            font-weight: 500;
        }

        /* Dropdown Menu Styles */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }

        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.15s;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        /* Required Field Highlighting */
        .required-field {
            border-color: #FFAB91 !important;
            background-color: #FFF3E0 !important;
        }

        .required-field:focus {
            border-color: #FF9800 !important;
            background-color: white !important;
        }

        .invalid-row {
            background-color: #FFEBEE;
        }

        .employee-accordion {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 80px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .accordion-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .accordion-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f9f9f9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: #f0f0f0;
        }

        .accordion-header.expanded {
            background: #E3F2FD;
        }

        .accordion-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-employee-name {
            font-weight: 600;
            font-size: 15px;
            color: #1a1a1a;
        }

        .accordion-employee-id {
            font-size: 13px;
            color: #666;
        }

        .accordion-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .accordion-subtotal {
            font-size: 14px;
            color: #666;
        }

        .accordion-subtotal-value {
            font-weight: 700;
            color: #1976D2;
            font-size: 16px;
        }

        .accordion-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #E8F5E9;
            color: #2E7D32;
        }

        .accordion-status.no-entries {
            background: #F5F5F5;
            color: #999;
        }

        .accordion-expand-icon {
            font-size: 18px;
            transition: transform 0.2s;
        }

        .accordion-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .accordion-content {
            display: none;
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .accordion-content.expanded {
            display: block;
        }

        .product-mini-table {
            margin-bottom: 20px;
        }

        .product-mini-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .product-mini-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .product-mini-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .quality-check-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .quality-check-section h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .quality-select-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .quality-toggles {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .quality-toggle-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 80px;
            text-align: center;
        }

        .quality-toggle-btn:hover:not(:disabled) {
            border-color: #999;
        }

        .quality-toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quality-toggle-btn.active.ok {
            background: #4CAF50;
            border-color: #4CAF50;
            color: white;
            font-weight: 600;
        }

        .quality-toggle-btn.active.not-ok {
            background: #F44336;
            border-color: #F44336;
            color: white;
            font-weight: 600;
        }

        .quality-check-section .quality-toggle-btn {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 64px;
        }

        .spreadsheet-container {
            overflow-x: auto;
        }

        .spreadsheet-grid {
            min-width: 600px;
        }

        .spreadsheet-grid table {
            width: 100%;
            border-collapse: collapse;
        }

        .spreadsheet-grid th {
            background: #1976D2;
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #1565C0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .spreadsheet-grid th.employee-col {
            text-align: left;
            background: #1565C0;
        }

        .spreadsheet-grid td {
            padding: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .spreadsheet-grid td.employee-name {
            text-align: left;
            font-weight: 600;
            background: #f9f9f9;
        }

        .spreadsheet-grid input[type="number"] {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .spreadsheet-quality-icon {
            cursor: pointer;
            font-size: 16px;
            margin-left: 8px;
        }

        .sticky-save-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            z-index: 99;
        }

        .btn-large {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .last-saved-info {
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .error-message {
            color: #C62828;
            font-size: 13px;
            padding: 8px 12px;
            background: #FFEBEE;
            border-radius: 4px;
            border-left: 4px solid #C62828;
        }

        .dashboard-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-chip {
            padding: 8px 16px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .nav-chip:hover {
            border-color: #1976D2;
            background: #E3F2FD;
        }

        .nav-chip.active {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .report-table {
            background: white;
            border-radius: 12px;
            overflow: visible;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .report-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th {
            background: #f5f5f5;
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .report-table td {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .report-table tr:hover {
            background: #fafafa;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #E3F2FD !important;
        }

        .search-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-note {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .modal-body {
            margin-bottom: 24px;
            color: #666;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .tab-container {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1976D2;
        }

        .tab-btn.active {
            color: #1976D2;
            border-bottom-color: #1976D2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .container {
                flex-direction: column;
            }

            .product-table {
                font-size: 12px;
            }

            .product-table th,
            .product-table td {
                padding: 12px 8px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .entry-grid-header,
            .entry-row {
                grid-template-columns: 1fr;
                font-size: 12px;
            }

            .production-controls {
                flex-direction: column;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo-section">
                <div class="logo">ü•ü Wonton</div>
                <div class="role-switcher">
                    <label for="roleSelect">Current Role:</label>
                    <select id="roleSelect" onchange="handleRoleChange()">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="nav-menu" id="navMenu">
                <!-- Menu items will be rendered here by JavaScript -->
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="header">
                <h1 id="pageTitle">Home</h1>
                <div class="breadcrumb" id="breadcrumb">Dashboard / Home</div>
            </div>
            <div class="content-card" id="mainContent">
                <h2>Welcome to Wonton Management System</h2>
                <div class="color-reference">
                    <div class="color-item">
                        <div class="color-box orange"></div>
                        <span>User Access</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box blue"></div>
                        <span>Admin Only</span>
                    </div>
                </div>
                <div class="info-message">
                    <h3>Role-Based Access Control</h3>
                    <p>
                        This system implements role-based menu access. Users with 'User' role can access Home, Product Inflow, and Product Outflow menus (highlighted in orange).
                        Admins have full access to all menus including Dashboard, Inventory, Sale, Wage, and SETUP (highlighted in blue).
                    </p>
                    <p style="margin-top: 12px;">
                        Use the role switcher in the sidebar to toggle between User and Admin views to see the difference in menu accessibility.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Menu configuration with role-based access
        const menuConfig = [
            {
                id: 'home',
                label: 'Home',
                icon: 'üè†',
                roles: ['user', 'admin'],
                colorClass: 'user-access'
            },
            {
                id: 'dashboard',
                label: 'Dashboard',
                icon: 'üìä',
                roles: ['admin'],
                colorClass: 'admin-access'
            },
            {
                id: 'product-inflow',
                label: 'Product inflow',
                icon: 'üì•',
                roles: ['user', 'admin'],
                colorClass: 'user-access',
                submenu: [
                    { id: 'dumpling-production', label: 'Dumpling production' },
                    { id: 'other-production', label: 'Other production' }
                ]
            },
            {
                id: 'product-outflow',
                label: 'Product outflow',
                icon: 'üì§',
                roles: ['user', 'admin'],
                colorClass: 'user-access'
            },
            {
                id: 'inventory',
                label: 'Inventory',
                icon: 'üì¶',
                roles: ['admin'],
                colorClass: 'admin-access',
                submenu: [
                    { id: 'inflow', label: 'Inflow' },
                    { id: 'outflow', label: 'Outflow' },
                    { id: 'net-change', label: 'Net change' }
                ]
            },
            {
                id: 'sale',
                label: 'Sale',
                icon: 'üí∞',
                roles: ['admin'],
                colorClass: 'admin-access'
            },
            {
                id: 'wage',
                label: 'Wage',
                icon: 'üíµ',
                roles: ['admin'],
                colorClass: 'admin-access'
            },
            {
                id: 'setup',
                label: 'SETUP',
                icon: '‚öôÔ∏è',
                roles: ['admin'],
                colorClass: 'admin-access'
            }
        ];

        // Page content configuration
        const pageContent = {
            'home': {
                title: 'Home',
                breadcrumb: 'Dashboard / Home',
                content: `
                    <h2>Welcome to Wonton Management System</h2>
                    <p style="margin-top: 16px; color: #666; line-height: 1.6;">
                        This is your central hub for managing all aspects of the wonton business.
                        Navigate through the menu to access different modules based on your role.
                    </p>
                `
            },
            'dashboard': {
                title: 'Dashboard',
                breadcrumb: 'Dashboard',
                content: `
                    <h2>Admin Dashboard</h2>
                    <p style="margin-top: 16px; color: #666;">
                        View overall business metrics, sales analytics, and key performance indicators.
                    </p>
                    <div style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666;">Total Sales</div>
                            <div style="font-size: 28px; font-weight: 700; color: #D84315; margin-top: 8px;">$12,847</div>
                        </div>
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666;">Orders Today</div>
                            <div style="font-size: 28px; font-weight: 700; color: #1976D2; margin-top: 8px;">247</div>
                        </div>
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666;">Inventory Items</div>
                            <div style="font-size: 28px; font-weight: 700; color: #388E3C; margin-top: 8px;">1,432</div>
                        </div>
                    </div>
                `
            },
            'product-inflow': {
                title: 'Product Inflow',
                breadcrumb: 'Product Management / Product Inflow',
                content: `
                    <h2>Product Inflow Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Track and manage incoming products from production facilities.
                    </p>
                `
            },
            'dumpling-production': {
                title: 'Dumpling Production Record',
                breadcrumb: 'Product Management / Product Inflow / Dumpling Production',
                content: `
                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchProductionTab('entry')">Entry</button>
                        <button class="tab-btn" onclick="switchProductionTab('reports')">Reports</button>
                        <button class="tab-btn" onclick="switchProductionTab('search')">Search</button>
                    </div>

                    <!-- Entry Tab -->
                    <div id="entry-tab" class="tab-content active">
                        <!-- Sticky Header -->
                        <div class="production-sticky-header" id="productionStickyHeader">
                            <div class="production-header-row">
                                <div class="header-controls-left">
                                    <div class="control-group">
                                        <label class="control-label">Date</label>
                                        <input type="date" id="productionDate" class="date-input" onchange="handleDateChange()">
                                    </div>
                                    <div class="control-group">
                                        <label class="control-label">Round</label>
                                        <div class="round-selector-inline" id="roundSelectorInline">
                                            <!-- Rounds will be rendered here -->
                                        </div>
                                    </div>
                                    <div class="control-group">
                                        <button id="addRoundBtn" class="btn btn-secondary btn-small" onclick="handleAddRound()">
                                            + Add Round
                                        </button>
                                    </div>
                                </div>
                                <div class="header-controls-right">
                                    <div class="control-group">
                                        <label class="control-label">Round Status</label>
                                        <span id="roundStatusBadge" class="round-status-badge draft">
                                            <span>‚óè</span> <span id="roundStatusText">Draft</span>
                                        </span>
                                    </div>
                                    <div class="control-group">
                                        <label class="control-label">Day Status</label>
                                        <span id="dayStatusBadge" class="day-status-badge open">
                                            <span>‚óè</span> Open
                                        </span>
                                    </div>
                                    <div class="control-group">
                                        <label class="control-label">Sign-off</label>
                                        <span id="signoffStatusBadge" class="signoff-status-badge not-signed">
                                            <span id="signoffStatusText">Not signed</span>
                                        </span>
                                    </div>
                                    <div class="control-group" id="closeDayBtnGroup">
                                        <button id="closeDayBtn" class="btn btn-close-day btn-small" onclick="closeDayModal()">
                                            üîí Close Day
                                        </button>
                                        <button id="reopenDayBtn" class="btn btn-reopen-day btn-small" onclick="reopenDay()" style="display: none;">
                                            üîì Reopen (Admin)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Note -->
                        <div class="info-note">
                            ‚ÑπÔ∏è <strong>Note:</strong> Only Dept 01 Active employees and products are shown. Changes are auto-saved as draft.
                        </div>

                        <!-- Two-column layout: Entry area + Summary -->
                        <div class="entry-content-wrapper">
                            <!-- Left Column: Production Entry by Employee -->
                            <div class="entry-column-left">
                                <h3 style="margin-bottom: 16px;">Production Entry by Employee</h3>
                                <div id="employeeAccordion" class="employee-accordion">
                                    <!-- Accordion items will be rendered here -->
                                </div>
                            </div>

                            <!-- Right Column: Current Round Summary -->
                            <div class="entry-column-right">
                                <div class="product-dashboard">
                                    <h3>Current Round Summary</h3>
                                    <div class="product-dashboard-cards" id="productDashboard">
                                        <!-- Per-product cards will be rendered here -->
                                    </div>
                                    <div id="draftIndicator" class="draft-indicator" style="display: none;">
                                        ‚ö†Ô∏è Unsaved changes
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sticky Save Button -->
                        <div class="sticky-save-container">
                            <button id="saveRoundBtn" class="btn btn-success btn-large" onclick="openInitialsModal()">
                                üíæ Save Round
                            </button>
                            <div id="lastSavedInfo" class="last-saved-info" style="display: none;">
                                Last saved: <span id="lastSavedTime">Never</span>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="reports-tab" class="tab-content">
                        <!-- Dashboard Navigation -->
                        <div class="dashboard-nav" id="dashboardNav">
                            <div class="nav-chip active" onclick="showReportView('year')">üìÖ Year View</div>
                            <div class="nav-chip" onclick="showReportView('month')">üìÜ Month View</div>
                            <div class="nav-chip" onclick="showReportView('day')">üìã Day View</div>
                        </div>

                        <!-- Year View -->
                        <div id="year-view" class="report-view" style="display: block;">
                            <h3 style="margin-bottom: 16px;">Yearly Summary</h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Year</th>
                                            <th>Product Breakdown</th>
                                            <th>Days Recorded</th>
                                            <th>Employees</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="yearViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Month View -->
                        <div id="month-view" class="report-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-small" onclick="showReportView('year')">‚Üê Back to Year View</button>
                            </div>
                            <h3 style="margin-bottom: 16px;">Monthly Summary - <span id="selectedYear"></span></h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Product Breakdown</th>
                                            <th>Days Recorded</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monthViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Day View -->
                        <div id="day-view" class="report-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-small" onclick="showReportView('month')">‚Üê Back to Month View</button>
                            </div>
                            <h3 style="margin-bottom: 16px;">Daily Summary - <span id="selectedMonth"></span></h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Product Breakdown</th>
                                            <th>Rounds</th>
                                            <th>Entries</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dayViewBody">
                                    </tbody>
                                </table>
                            </div>

                            <!-- Spreadsheet Detail View -->
                            <div id="dayDetailView" class="day-detail-view" style="display: none; margin-top: 24px;">
                                <div style="margin-bottom: 16px;">
                                    <button class="btn btn-secondary btn-small" onclick="closeDayDetailView()">‚Üê Back to Daily Summary</button>
                                </div>
                                <h3 style="margin-bottom: 16px;">Production Detail - <span id="detailViewDate"></span> - Round <span id="detailViewRound"></span></h3>
                                <div class="spreadsheet-container">
                                    <div id="reportSpreadsheetGrid" class="spreadsheet-grid">
                                        <!-- Spreadsheet will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Tab -->
                    <div id="search-tab" class="tab-content">
                        <div class="search-section">
                            <h3 style="margin-bottom: 16px;">Search Production Records</h3>
                            <div class="search-grid">
                                <div class="form-group">
                                    <label class="form-label">Date From</label>
                                    <input type="date" id="searchDateFrom" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date To</label>
                                    <input type="date" id="searchDateTo" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Employee</label>
                                    <select id="searchEmployee" class="form-select">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product</label>
                                    <select id="searchProduct" class="form-select">
                                        <option value="">All Products</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Day Status</label>
                                    <select id="searchDayStatus" class="form-select">
                                        <option value="">All</option>
                                        <option value="Open">Open</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quality Status</label>
                                    <select id="searchQualityStatus" class="form-select">
                                        <option value="">All</option>
                                        <option value="OK">OK</option>
                                        <option value="Not OK">Not OK</option>
                                        <option value="Pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" onclick="performSearch()">üîç Search</button>
                                <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="searchResults" style="display: none;">
                            <h3 style="margin-bottom: 16px;">Search Results</h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Round</th>
                                            <th>Employee</th>
                                            <th>Product</th>
                                            <th>Count</th>
                                            <th>Day Status</th>
                                            <th>Quality</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResultsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Modals -->
                    <div id="closeDayModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-title">Close Production Day</div>
                            <div class="modal-body">
                                Are you sure you want to close this production day? Once closed, normal users will not be able to edit entries. Only admins can reopen or edit closed days.
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="hideModal('closeDayModal')">Cancel</button>
                                <button class="btn btn-close-day" onclick="closeDay()">Close Day</button>
                            </div>
                        </div>
                    </div>

                    <div id="initialsModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-title">Inspector Sign-off Required</div>
                            <div class="modal-body">
                                <p><strong>Date:</strong> <span id="initialsModalDate"></span> | <strong>Round:</strong> <span id="initialsModalRound"></span></p>
                                <p style="margin-top: 12px;">Please enter your initials to sign-off and save this round.</p>
                                <div class="form-group" style="margin-top: 16px;">
                                    <label class="form-label">Inspector Initials *</label>
                                    <input type="text" id="inspectorInitials" class="form-input" placeholder="Enter your initials (e.g., AB)" maxlength="10" style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notes (Optional)</label>
                                    <textarea id="initialsNotes" class="form-input" rows="3" placeholder="Add any inspection notes"></textarea>
                                </div>
                                <div id="initialsError" class="error-message" style="display: none; margin-top: 12px;"></div>
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="hideModal('initialsModal')">Cancel</button>
                                <button class="btn btn-success" onclick="confirmInitialsAndSave()">Sign-off & Save</button>
                            </div>
                        </div>
                    </div>

                    <div id="signoffModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-title">Inspection Sign-off</div>
                            <div class="modal-body">
                                <p><strong>Date:</strong> <span id="signoffModalDate"></span> | <strong>Round:</strong> <span id="signoffModalRound"></span></p>
                                <p style="margin-top: 12px;">The round has been saved. Would you like to sign off now? This will lock the round for normal operators.</p>
                                <div class="form-group" style="margin-top: 16px;">
                                    <label class="form-label">Inspector Name</label>
                                    <input type="text" id="inspectorName" class="form-input" placeholder="Enter your name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sign-off Method</label>
                                    <select id="signoffMethod" class="form-select">
                                        <option value="typed_name">Typed Name</option>
                                        <option value="checkbox_confirm">Checkbox Confirmation</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notes (Optional)</label>
                                    <textarea id="signoffNotes" class="form-input" rows="3" placeholder="Add any inspection notes"></textarea>
                                </div>
                                <div id="signoffError" class="error-message" style="display: none; margin-top: 12px;"></div>
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="hideModal('signoffModal')">Not now</button>
                                <button class="btn btn-warning" onclick="confirmSignoff()">Sign Off</button>
                            </div>
                        </div>
                    </div>

                    <div id="navigationGuardModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-title">Unsaved Changes</div>
                            <div class="modal-body">
                                You have unsaved changes in the current round. What would you like to do?
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="handleNavigationGuard('cancel')">Cancel</button>
                                <button class="btn btn-danger" onclick="handleNavigationGuard('discard')">Discard</button>
                                <button class="btn btn-success" onclick="handleNavigationGuard('save')">Save Round</button>
                            </div>
                        </div>
                    </div>
                `
            },
            'other-production': {
                title: 'Other Production',
                breadcrumb: 'Product Management / Product Inflow / Other Production',
                content: `
                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchOtherProductionTab('entry')">Entry</button>
                        <button class="tab-btn" onclick="switchOtherProductionTab('reports')">Reports</button>
                        <button class="tab-btn" onclick="switchOtherProductionTab('search')">Search</button>
                    </div>

                    <!-- Entry Tab -->
                    <div id="other-entry-tab" class="tab-content active">
                        <!-- Header Controls -->
                        <div class="production-sticky-header" id="otherProductionStickyHeader">
                            <div class="production-header-row">
                                <div class="header-controls-left">
                                    <div class="control-group">
                                        <label class="control-label">Date</label>
                                        <input type="date" id="otherProductionDate" class="date-input" onchange="handleOtherDateChange()">
                                    </div>
                                </div>
                                <div class="header-controls-right">
                                    <div class="control-group">
                                        <label class="control-label">Status</label>
                                        <span id="otherStatusBadge" class="round-status-badge draft">
                                            <span>‚óè</span> <span id="otherStatusText">Draft</span>
                                        </span>
                                    </div>
                                    <div class="control-group">
                                        <label class="control-label">Day Status</label>
                                        <span id="otherDayStatusBadge" class="day-status-badge open">
                                            <span>‚óè</span> <span id="otherDayStatusText">Open</span>
                                        </span>
                                    </div>
                                    <div class="control-group" id="otherDayActions" style="display: none;">
                                        <button class="btn btn-close-day btn-small" onclick="closeOtherProductionDay()">üîí Close Day</button>
                                        <button class="btn btn-secondary btn-small" onclick="reopenOtherProductionDay()">üîì Reopen</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Note -->
                        <div class="info-note">
                            ‚ÑπÔ∏è <strong>Note:</strong> Add products as they are produced. Saved entries stay visible here for the full day. Admins close the day to lock edits.
                        </div>

                        <!-- Flat Table Entry -->
                        <div class="entry-content-wrapper">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h3 style="margin: 0;">Production Entry</h3>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="otherProductSelector" class="form-input" style="width: 300px;">
                                            <option value="">-- Select Product to Add --</option>
                                        </select>
                                        <button class="btn btn-primary" onclick="addOtherProductToEntry()" style="white-space: nowrap;">
                                            ‚ûï Add Product
                                        </button>
                                    </div>
                                </div>
                                <div class="report-table">
                                    <table id="otherProductionTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 21%;">Product</th>
                                                <th style="width: 8%;">Unit</th>
                                                <th style="width: 12%;">Batch</th>
                                                <th style="width: 12%;">Amount</th>
                                                <th style="width: 18%;">Quality Check</th>
                                                <th style="width: 21%;">Notes</th>
                                                <th style="width: 8%;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="otherProductionTableBody">
                                            <!-- Product rows will be rendered here -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Save Button -->
                                <div style="margin-top: 24px; display: flex; gap: 12px; align-items: center;">
                                    <button id="saveOtherProductionBtn" class="btn btn-success btn-large" onclick="saveOtherProduction()">
                                        üíæ Save Production
                                    </button>
                                    <div id="otherDraftIndicator" class="draft-indicator" style="display: none;">
                                        ‚ö†Ô∏è Unsaved changes
                                    </div>
                                    <div id="otherLastSavedInfo" class="last-saved-info" style="display: none;">
                                        Last saved: <span id="otherLastSavedTime">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="other-reports-tab" class="tab-content">
                        <!-- Dashboard Navigation -->
                        <div class="dashboard-nav" id="otherDashboardNav">
                            <div class="nav-chip active" onclick="showOtherReportView('year')">üìÖ Year View</div>
                            <div class="nav-chip" onclick="showOtherReportView('month')">üìÜ Month View</div>
                            <div class="nav-chip" onclick="showOtherReportView('day')">üìã Day View</div>
                        </div>

                        <!-- Year View -->
                        <div id="other-year-view" class="report-view" style="display: block;">
                            <h3 style="margin-bottom: 16px;">Yearly Summary</h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Year</th>
                                            <th>Product Breakdown</th>
                                            <th>Days Recorded</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="otherYearViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Month View -->
                        <div id="other-month-view" class="report-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-small" onclick="showOtherReportView('year')">‚Üê Back to Year View</button>
                            </div>
                            <h3 style="margin-bottom: 16px;">Monthly Summary - <span id="otherSelectedYear"></span></h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Product Breakdown</th>
                                            <th>Days Recorded</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="otherMonthViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Day View -->
                        <div id="other-day-view" class="report-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-small" onclick="showOtherReportView('month')">‚Üê Back to Month View</button>
                            </div>
                            <h3 style="margin-bottom: 16px;">Daily Summary - <span id="otherSelectedMonth"></span></h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Product</th>
                                            <th>Batch Breakdown</th>
                                            <th>Quality</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="otherDayViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Search Tab -->
                    <div id="other-search-tab" class="tab-content">
                        <div class="search-section">
                            <h3 style="margin-bottom: 16px;">Search Production Records</h3>
                            <div class="search-grid">
                                <div class="form-group">
                                    <label class="form-label">Date From</label>
                                    <input type="date" id="otherSearchDateFrom" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date To</label>
                                    <input type="date" id="otherSearchDateTo" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product</label>
                                    <select id="otherSearchProduct" class="form-select">
                                        <option value="">All Products</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quality Status</label>
                                    <select id="otherSearchQualityStatus" class="form-select">
                                        <option value="">All</option>
                                        <option value="OK">OK</option>
                                        <option value="Not OK">Not OK</option>
                                        <option value="Pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" onclick="performOtherSearch()">üîç Search</button>
                                <button class="btn btn-secondary" onclick="clearOtherSearch()">Clear</button>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="otherSearchResults" style="display: none;">
                            <h3 style="margin-bottom: 16px;">Search Results</h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Batch</th>
                                            <th>Product</th>
                                            <th>Amount</th>
                                            <th>Quality</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="otherSearchResultsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `
            },
            'product-outflow': {
                title: 'Product Outflow',
                breadcrumb: 'Product Management / Product Outflow',
                content: `
                    <h2>Product Outflow</h2>

                    <!-- Date and Status Controls -->
                    <div class="production-header">
                        <div class="header-controls">
                            <div class="control-group">
                                <label class="control-label">Date:</label>
                                <input type="date"
                                       id="outflowDate"
                                       class="form-input"
                                       style="width: 160px;"
                                       onchange="handleOutflowDateChange()">
                            </div>

                            <div class="status-group">
                                <div id="outflowDayStatusBadge" class="status-badge badge-open">Open</div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button id="closeOutflowDayBtn"
                                    class="btn btn-danger"
                                    onclick="closeOutflowDay()"
                                    style="display: none;">
                                üîí Close Day
                            </button>
                            <button id="reopenOutflowDayBtn"
                                    class="btn btn-warning"
                                    onclick="reopenOutflowDay()"
                                    style="display: none;">
                                üîì Reopen Day
                            </button>
                        </div>
                    </div>

                    <div class="info-note">
                        ‚ÑπÔ∏è <strong>Note:</strong> Record product outflow as they are sold or used. Save your work to finalize the entries. Admins can close the day to lock edits.
                    </div>

                    <!-- Outflow Entry Table -->
                    <div class="entry-content-wrapper">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0;">Outflow Entry</h3>
                                <button class="btn btn-primary" onclick="addOutflowRow()" id="addOutflowRowBtn">
                                    ‚ûï Add Row
                                </button>
                            </div>

                            <!-- Filters -->
                            <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                                <div>
                                    <input type="date"
                                           id="outflowFilterDateFrom"
                                           class="form-input"
                                           placeholder="Date From"
                                           onchange="applyOutflowFilters()"
                                           style="width: 150px;">
                                </div>
                                <div>
                                    <input type="date"
                                           id="outflowFilterDateTo"
                                           class="form-input"
                                           placeholder="Date To"
                                           onchange="applyOutflowFilters()"
                                           style="width: 150px;">
                                </div>
                                <div>
                                    <select id="outflowFilterCustomer"
                                            class="form-select"
                                            onchange="applyOutflowFilters()"
                                            style="width: 180px;">
                                        <option value="">All Customers</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="outflowFilterProduct"
                                            class="form-select"
                                            onchange="applyOutflowFilters()"
                                            style="width: 180px;">
                                        <option value="">All Products</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="text"
                                           id="outflowFilterSeller"
                                           class="form-input"
                                           placeholder="Filter by Seller"
                                           onchange="applyOutflowFilters()"
                                           style="width: 150px;">
                                </div>
                                <button class="btn btn-secondary" onclick="clearOutflowFilters()" style="white-space: nowrap;">
                                    Clear Filters
                                </button>
                            </div>

                            <div class="report-table">
                                <table id="outflowTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Date<span style="color: #F44336;">*</span></th>
                                            <th style="width: 15%;">Customer<span style="color: #F44336;">*</span></th>
                                            <th style="width: 12%;">Seller<span style="color: #F44336;">*</span></th>
                                            <th style="width: 15%;">Product<span style="color: #F44336;">*</span></th>
                                            <th style="width: 8%;">Unit</th>
                                            <th style="width: 10%;">Quantity<span style="color: #F44336;">*</span></th>
                                            <th style="width: 25%;">Note</th>
                                            <th style="width: 5%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="outflowTableBody">
                                        <!-- Outflow rows will be rendered here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Save Button -->
                            <div style="margin-top: 24px; display: flex; gap: 12px; align-items: center;">
                                <button id="saveOutflowBtn" class="btn btn-success btn-large" onclick="saveOutflow()">
                                    üíæ Save Outflow
                                </button>
                                <div id="outflowDraftIndicator" class="draft-indicator" style="display: none;">
                                    ‚ö†Ô∏è Unsaved changes
                                </div>
                                <div id="outflowLastSavedInfo" class="last-saved-info" style="display: none;">
                                    Last saved: <span id="outflowLastSavedTime">Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'inventory': {
                title: 'Inventory',
                breadcrumb: 'Inventory Management',
                content: `
                    <h2>Inventory Overview</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Comprehensive view of current inventory levels, stock alerts, and warehouse management.
                    </p>
                `
            },
            'inflow': {
                title: 'Inventory Inflow',
                breadcrumb: 'Inventory Management / Inflow',
                content: `
                    <h2>Inventory Inflow</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Record and track all incoming inventory items and raw materials.
                    </p>
                `
            },
            'outflow': {
                title: 'Product Outflow',
                breadcrumb: 'Inventory Management / Outflow',
                content: `
                    <h2>Product Outflow</h2>

                    <!-- Date and Status Controls -->
                    <div class="production-header">
                        <div class="header-controls">
                            <div class="control-group">
                                <label class="control-label">Date:</label>
                                <input type="date"
                                       id="outflowDate"
                                       class="form-input"
                                       style="width: 160px;"
                                       onchange="handleOutflowDateChange()">
                            </div>

                            <div class="status-group">
                                <div id="outflowDayStatusBadge" class="status-badge badge-open">Open</div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button id="closeOutflowDayBtn"
                                    class="btn btn-danger"
                                    onclick="closeOutflowDay()"
                                    style="display: none;">
                                üîí Close Day
                            </button>
                            <button id="reopenOutflowDayBtn"
                                    class="btn btn-warning"
                                    onclick="reopenOutflowDay()"
                                    style="display: none;">
                                üîì Reopen Day
                            </button>
                        </div>
                    </div>

                    <div class="info-note">
                        ‚ÑπÔ∏è <strong>Note:</strong> Record product outflow as they are sold or used. Save your work to finalize the entries. Admins can close the day to lock edits.
                    </div>

                    <!-- Outflow Entry Table -->
                    <div class="entry-content-wrapper">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0;">Outflow Entry</h3>
                                <button class="btn btn-primary" onclick="addOutflowRow()" id="addOutflowRowBtn">
                                    ‚ûï Add Row
                                </button>
                            </div>

                            <!-- Filters -->
                            <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                                <div>
                                    <input type="date"
                                           id="outflowFilterDateFrom"
                                           class="form-input"
                                           placeholder="Date From"
                                           onchange="applyOutflowFilters()"
                                           style="width: 150px;">
                                </div>
                                <div>
                                    <input type="date"
                                           id="outflowFilterDateTo"
                                           class="form-input"
                                           placeholder="Date To"
                                           onchange="applyOutflowFilters()"
                                           style="width: 150px;">
                                </div>
                                <div>
                                    <select id="outflowFilterCustomer"
                                            class="form-select"
                                            onchange="applyOutflowFilters()"
                                            style="width: 180px;">
                                        <option value="">All Customers</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="outflowFilterProduct"
                                            class="form-select"
                                            onchange="applyOutflowFilters()"
                                            style="width: 180px;">
                                        <option value="">All Products</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="text"
                                           id="outflowFilterSeller"
                                           class="form-input"
                                           placeholder="Filter by Seller"
                                           onchange="applyOutflowFilters()"
                                           style="width: 150px;">
                                </div>
                                <button class="btn btn-secondary" onclick="clearOutflowFilters()" style="white-space: nowrap;">
                                    Clear Filters
                                </button>
                            </div>

                            <div class="report-table">
                                <table id="outflowTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Date<span style="color: #F44336;">*</span></th>
                                            <th style="width: 15%;">Customer<span style="color: #F44336;">*</span></th>
                                            <th style="width: 12%;">Seller<span style="color: #F44336;">*</span></th>
                                            <th style="width: 15%;">Product<span style="color: #F44336;">*</span></th>
                                            <th style="width: 8%;">Unit</th>
                                            <th style="width: 10%;">Quantity<span style="color: #F44336;">*</span></th>
                                            <th style="width: 25%;">Note</th>
                                            <th style="width: 5%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="outflowTableBody">
                                        <!-- Outflow rows will be rendered here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Save Button -->
                            <div style="margin-top: 24px; display: flex; gap: 12px; align-items: center;">
                                <button id="saveOutflowBtn" class="btn btn-success btn-large" onclick="saveOutflow()">
                                    üíæ Save Outflow
                                </button>
                                <div id="outflowDraftIndicator" class="draft-indicator" style="display: none;">
                                    ‚ö†Ô∏è Unsaved changes
                                </div>
                                <div id="outflowLastSavedInfo" class="last-saved-info" style="display: none;">
                                    Last saved: <span id="outflowLastSavedTime">Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'net-change': {
                title: 'Net Change',
                breadcrumb: 'Inventory Management / Net Change',
                content: `
                    <h2>Inventory Net Change</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Analyze the net change in inventory levels over time periods.
                    </p>
                `
            },
            'sale': {
                title: 'Sales',
                breadcrumb: 'Sales Management',
                content: `
                    <h2>Sales Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        View sales transactions, generate reports, and analyze sales performance.
                    </p>
                `
            },
            'wage': {
                title: 'Wage Management',
                breadcrumb: 'HR / Wage Management',
                content: `
                    <h2>Wage Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Manage employee wages, payroll processing, and compensation records.
                    </p>
                `
            },
            'setup': {
                title: 'System Setup',
                breadcrumb: 'Administration / Setup',
                content: `
                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchSetupTab('product')">Product Management</button>
                        <button class="tab-btn" onclick="switchSetupTab('department')">Department Management</button>
                        <button class="tab-btn" onclick="switchSetupTab('employee')">Employee Management</button>
                        <button class="tab-btn" onclick="switchSetupTab('customer')">Customer Management</button>
                    </div>

                    <!-- Product Management Tab -->
                    <div id="product-tab" class="tab-content active">
                        <div class="product-section">
                            <div class="section-header">
                                <h2 class="section-title">Product Management</h2>
                                <button class="btn btn-primary" onclick="toggleProductForm()">
                                    <span>+</span> Add New Product
                                </button>
                            </div>

                            <!-- Product Form -->
                            <div id="productForm" class="product-form">
                                <h3 style="margin-bottom: 20px; font-size: 18px;" id="formTitle">Add New Product</h3>
                                <form onsubmit="saveProduct(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Product ID<span class="required">*</span></label>
                                            <input type="number" id="productId" class="form-input" disabled required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Product Name (Thai)<span class="required">*</span></label>
                                            <input type="text" id="productNameThai" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Product Name (English)<span class="required">*</span></label>
                                            <input type="text" id="productNameEn" class="form-input" placeholder="Product name" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Unit<span class="required">*</span></label>
                                            <input type="text" id="productUnit" class="form-input" placeholder="e.g., pieces, kg, boxes" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Department<span class="required">*</span></label>
                                            <select id="productDepartment" class="form-select" required>
                                                <option value="">Select Department</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Status<span class="required">*</span></label>
                                            <select id="productStatus" class="form-select" required>
                                                <option value="Active">Active</option>
                                                <option value="Inactive">Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="cancelProductForm()">Cancel</button>
                                        <button type="submit" class="btn btn-success" id="saveBtn">Save Product</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Product List -->
                            <div id="productListContainer">
                                <table class="product-table" id="productTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Product Name (Thai)</th>
                                            <th>Product Name (English)</th>
                                            <th>Unit</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productTableBody">
                                        <!-- Products will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Department Management Tab -->
                    <div id="department-tab" class="tab-content">
                        <div class="product-section">
                            <div class="section-header">
                                <h2 class="section-title">Department Management</h2>
                                <button class="btn btn-primary" onclick="toggleDepartmentForm()">
                                    <span>+</span> Add New Department
                                </button>
                            </div>

                            <!-- Department Form -->
                            <div id="departmentForm" class="product-form">
                                <h3 style="margin-bottom: 20px; font-size: 18px;" id="departmentFormTitle">Add New Department</h3>
                                <form onsubmit="saveDepartment(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Department ID<span class="required">*</span></label>
                                            <input type="number" id="departmentId" class="form-input" disabled required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Department Name<span class="required">*</span></label>
                                            <input type="text" id="departmentName" class="form-input" placeholder="Department name" required>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="cancelDepartmentForm()">Cancel</button>
                                        <button type="submit" class="btn btn-success" id="departmentSaveBtn">Save Department</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Department List -->
                            <div id="departmentListContainer">
                                <table class="product-table" id="departmentTable">
                                    <thead>
                                        <tr>
                                            <th>Department ID</th>
                                            <th>Department Name</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="departmentTableBody">
                                        <!-- Departments will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Management Tab -->
                    <div id="employee-tab" class="tab-content">
                        <div class="product-section">
                            <div class="section-header">
                                <h2 class="section-title">Employee Management</h2>
                                <button class="btn btn-primary" onclick="toggleEmployeeForm()">
                                    <span>+</span> Add New Employee
                                </button>
                            </div>

                            <!-- Employee Form -->
                            <div id="employeeForm" class="product-form">
                                <h3 style="margin-bottom: 20px; font-size: 18px;" id="employeeFormTitle">Add New Employee</h3>
                                <form onsubmit="saveEmployee(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Employee ID<span class="required">*</span></label>
                                            <input type="number" id="employeeId" class="form-input" disabled required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Name in Thai<span class="required">*</span></label>
                                            <input type="text" id="employeeNameThai" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Name in Other Language<span class="required">*</span></label>
                                            <input type="text" id="employeeNameOther" class="form-input" placeholder="Employee name" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Department<span class="required">*</span></label>
                                            <select id="employeeDepartment" class="form-select" required>
                                                <option value="">Select Department</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Status<span class="required">*</span></label>
                                            <select id="employeeStatus" class="form-select" required>
                                                <option value="Active">Active</option>
                                                <option value="On leave">On leave</option>
                                                <option value="Resigned">Resigned</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="cancelEmployeeForm()">Cancel</button>
                                        <button type="submit" class="btn btn-success" id="employeeSaveBtn">Save Employee</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Employee List -->
                            <div id="employeeListContainer">
                                <table class="product-table" id="employeeTable">
                                    <thead>
                                        <tr>
                                            <th>Employee ID</th>
                                            <th>Name (Thai)</th>
                                            <th>Name (Other Language)</th>
                                            <th>Department ID</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employeeTableBody">
                                        <!-- Employees will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Management Tab -->
                    <div id="customer-tab" class="tab-content">
                        <div class="product-section">
                            <div class="section-header">
                                <h2 class="section-title">Customer Management</h2>
                                <button class="btn btn-primary" onclick="toggleCustomerForm()">
                                    <span>+</span> Add New Customer
                                </button>
                            </div>

                            <!-- Customer Form -->
                            <div id="customerForm" class="product-form">
                                <h3 style="margin-bottom: 20px; font-size: 18px;" id="customerFormTitle">Add New Customer</h3>
                                <form onsubmit="saveCustomer(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Customer ID<span class="required">*</span></label>
                                            <input type="number" id="customerId" class="form-input" disabled required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Customer Name (Thai)<span class="required">*</span></label>
                                            <input type="text" id="customerNameThai" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Customer Name (Burmese)<span class="required">*</span></label>
                                            <input type="text" id="customerNameBurmese" class="form-input" placeholder="·Äñ·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ää·Ä∫·Ä°·Äô·Ää·Ä∫" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Client Type<span class="required">*</span></label>
                                            <select id="customerClientType" class="form-select" required>
                                                <option value="">Select Client Type</option>
                                                <option value="Retail">Retail</option>
                                                <option value="Wholesale">Wholesale</option>
                                                <option value="Distributor">Distributor</option>
                                                <option value="Corporate">Corporate</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Status<span class="required">*</span></label>
                                            <select id="customerStatus" class="form-select" required>
                                                <option value="">Select Status</option>
                                                <option value="Active">Active</option>
                                                <option value="Inactive">Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="cancelCustomerForm()">Cancel</button>
                                        <button type="submit" class="btn btn-success" id="customerSaveBtn">Save Customer</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Customer List -->
                            <div id="customerListContainer">
                                <table class="product-table" id="customerTable">
                                    <thead>
                                        <tr>
                                            <th>Customer ID</th>
                                            <th>Customer Name (Thai)</th>
                                            <th>Customer Name (Burmese)</th>
                                            <th>Client Type</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customerTableBody">
                                        <!-- Customers will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `
            }
        };

        // State management
        let currentRole = 'user';
        let currentPage = 'home';
        let expandedMenus = new Set();

        // Initialize the application
        function init() {
            renderMenu();
            navigateToPage('home');
        }

        // Handle role change
        function handleRoleChange() {
            currentRole = document.getElementById('roleSelect').value;
            renderMenu();

            // If current page is not accessible in new role, navigate to home
            const currentMenuItem = menuConfig.find(item => item.id === currentPage);
            if (currentMenuItem && !currentMenuItem.roles.includes(currentRole)) {
                navigateToPage('home');
            }

            if (currentPage === 'other-production') {
                updateOtherProductionStatusUI();
                renderOtherProductionTable(otherProductionDraft[currentOtherProductionDate] || []);
            }

            if (currentPage === 'product-outflow') {
                updateOutflowStatusUI();
                renderOutflowTable(outflowDraft[currentOutflowDate] || []);
            }
        }

        // Render menu based on current role
        function renderMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.innerHTML = '';

            menuConfig.forEach(item => {
                // Check if user has access to this menu item
                if (!item.roles.includes(currentRole)) {
                    return;
                }

                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';

                const hasSubmenu = item.submenu && item.submenu.length > 0;
                const isExpanded = expandedMenus.has(item.id);

                // Create main menu item
                const mainItem = document.createElement('div');
                mainItem.className = `menu-item-main ${item.colorClass}`;
                if (currentPage === item.id) {
                    mainItem.classList.add(item.roles.includes('admin') && !item.roles.includes('user') ? 'active-admin' : 'active');
                }

                mainItem.innerHTML = `
                    <div class="menu-label">
                        <span class="menu-icon">${item.icon}</span>
                        <span>${item.label}</span>
                    </div>
                    ${hasSubmenu ? '<span class="submenu-toggle ' + (isExpanded ? 'expanded' : '') + '">‚ñº</span>' : ''}
                `;

                mainItem.onclick = () => {
                    if (hasSubmenu) {
                        toggleSubmenu(item.id);
                    } else {
                        navigateToPage(item.id);
                    }
                };

                menuItem.appendChild(mainItem);

                // Create submenu if exists
                if (hasSubmenu) {
                    const submenu = document.createElement('div');
                    submenu.className = 'submenu' + (isExpanded ? ' show' : '');

                    item.submenu.forEach(subItem => {
                        const submenuItem = document.createElement('div');
                        submenuItem.className = 'submenu-item';
                        if (currentPage === subItem.id) {
                            submenuItem.classList.add('active');
                        }
                        submenuItem.textContent = subItem.label;
                        submenuItem.onclick = (e) => {
                            e.stopPropagation();
                            navigateToPage(subItem.id);
                        };
                        submenu.appendChild(submenuItem);
                    });

                    menuItem.appendChild(submenu);
                }

                navMenu.appendChild(menuItem);
            });
        }

        // Toggle submenu
        function toggleSubmenu(menuId) {
            if (expandedMenus.has(menuId)) {
                expandedMenus.delete(menuId);
            } else {
                expandedMenus.add(menuId);
            }
            renderMenu();
        }

        // Navigate to page
        function navigateToPage(pageId) {
            currentPage = pageId;

            const page = pageContent[pageId];
            if (page) {
                document.getElementById('pageTitle').textContent = page.title;
                document.getElementById('breadcrumb').textContent = page.breadcrumb;
                document.getElementById('mainContent').innerHTML = page.content;
            }

            // Expand parent menu if navigating to submenu item
            menuConfig.forEach(item => {
                if (item.submenu && item.submenu.some(sub => sub.id === pageId)) {
                    expandedMenus.add(item.id);
                }
            });

            renderMenu();
        }

        // Product Management Functions
        let products = [];
        let editingProductId = null;

        // Load products from localStorage
        function loadProducts() {
            const stored = localStorage.getItem('wontonProducts');
            if (stored) {
                products = JSON.parse(stored);
            }
        }

        // Save products to localStorage
        function saveProductsToStorage() {
            localStorage.setItem('wontonProducts', JSON.stringify(products));
        }

        // Get next product ID
        function getNextProductId() {
            if (products.length === 0) return 11;
            return Math.max(...products.map(p => p.id)) + 1;
        }

        // Format product ID as 2-digit string
        function formatProductId(id) {
            return String(id).padStart(2, '0');
        }

        // Toggle product form
        function toggleProductForm() {
            const form = document.getElementById('productForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetProductForm();
                updateProductDepartmentDropdown();
                form.classList.add('show');
                editingProductId = null;
                document.getElementById('formTitle').textContent = 'Add New Product';
                document.getElementById('saveBtn').textContent = 'Save Product';
                document.getElementById('productId').value = formatProductId(getNextProductId());
            }
        }

        // Reset product form
        function resetProductForm() {
            document.getElementById('productId').value = '';
            document.getElementById('productNameThai').value = '';
            document.getElementById('productNameEn').value = '';
            document.getElementById('productUnit').value = '';
            document.getElementById('productDepartment').value = '';
            document.getElementById('productStatus').value = 'Active';
        }

        // Cancel product form
        function cancelProductForm() {
            document.getElementById('productForm').classList.remove('show');
            resetProductForm();
            editingProductId = null;
        }

        // Save product
        function saveProduct(event) {
            event.preventDefault();

            const departmentId = parseInt(document.getElementById('productDepartment').value);

            const product = {
                id: parseInt(document.getElementById('productId').value),
                nameThai: document.getElementById('productNameThai').value,
                nameEn: document.getElementById('productNameEn').value,
                unit: document.getElementById('productUnit').value,
                departmentId: departmentId,
                departmentName: getDepartmentNameById(departmentId),
                status: document.getElementById('productStatus').value
            };

            if (editingProductId !== null) {
                // Update existing product
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    products[index] = product;
                }
            } else {
                // Add new product
                products.push(product);
            }

            saveProductsToStorage();
            renderProductTable();
            cancelProductForm();
        }

        // Edit product
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('saveBtn').textContent = 'Update Product';

            document.getElementById('productId').value = formatProductId(product.id);
            document.getElementById('productNameThai').value = product.nameThai;
            document.getElementById('productNameEn').value = product.nameEn;
            document.getElementById('productUnit').value = product.unit;
            updateProductDepartmentDropdown();
            document.getElementById('productDepartment').value = product.departmentId;
            document.getElementById('productStatus').value = product.status;

            document.getElementById('productForm').classList.add('show');

            // Scroll to form
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Update product department dropdown
        function updateProductDepartmentDropdown() {
            const select = document.getElementById('productDepartment');
            if (!select) return;

            const currentValue = select.value;

            // Clear and rebuild options
            select.innerHTML = '<option value="">Select Department</option>';

            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = `${formatDepartmentId(dept.id)} - ${dept.name}`;
                select.appendChild(option);
            });

            // Restore selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Render product table
        function renderProductTable() {
            const tbody = document.getElementById('productTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <div class="empty-state-text">No products yet. Click "Add New Product" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${formatProductId(product.id)}</td>
                    <td>${product.nameThai}</td>
                    <td>${product.nameEn}</td>
                    <td>${product.unit}</td>
                    <td>${product.departmentName || 'N/A'}</td>
                    <td>
                        <span class="status-badge status-${product.status.toLowerCase()}">
                            ${product.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editProduct(${product.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Department Management Functions
        let departments = [];
        let editingDepartmentId = null;

        // Load departments from localStorage
        function loadDepartments() {
            const stored = localStorage.getItem('wontonDepartments');
            if (stored) {
                departments = JSON.parse(stored);
            }
        }

        // Save departments to localStorage
        function saveDepartmentsToStorage() {
            localStorage.setItem('wontonDepartments', JSON.stringify(departments));
        }

        // Get next department ID
        function getNextDepartmentId() {
            if (departments.length === 0) return 1;
            return Math.max(...departments.map(d => d.id)) + 1;
        }

        // Format department ID as 2-digit string
        function formatDepartmentId(id) {
            return String(id).padStart(2, '0');
        }

        // Toggle department form
        function toggleDepartmentForm() {
            const form = document.getElementById('departmentForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetDepartmentForm();
                form.classList.add('show');
                editingDepartmentId = null;
                document.getElementById('departmentFormTitle').textContent = 'Add New Department';
                document.getElementById('departmentSaveBtn').textContent = 'Save Department';
                document.getElementById('departmentId').value = formatDepartmentId(getNextDepartmentId());
            }
        }

        // Reset department form
        function resetDepartmentForm() {
            document.getElementById('departmentId').value = '';
            document.getElementById('departmentName').value = '';
        }

        // Cancel department form
        function cancelDepartmentForm() {
            document.getElementById('departmentForm').classList.remove('show');
            resetDepartmentForm();
            editingDepartmentId = null;
        }

        // Save department
        function saveDepartment(event) {
            event.preventDefault();

            const department = {
                id: parseInt(document.getElementById('departmentId').value),
                name: document.getElementById('departmentName').value
            };

            if (editingDepartmentId !== null) {
                // Update existing department
                const index = departments.findIndex(d => d.id === editingDepartmentId);
                if (index !== -1) {
                    departments[index] = department;
                }
            } else {
                // Add new department
                departments.push(department);
            }

            saveDepartmentsToStorage();
            renderDepartmentTable();
            updateEmployeeDepartmentDropdown();
            updateProductDepartmentDropdown();
            cancelDepartmentForm();
        }

        // Edit department
        function editDepartment(departmentId) {
            const department = departments.find(d => d.id === departmentId);
            if (!department) return;

            editingDepartmentId = departmentId;
            document.getElementById('departmentFormTitle').textContent = 'Edit Department';
            document.getElementById('departmentSaveBtn').textContent = 'Update Department';

            document.getElementById('departmentId').value = formatDepartmentId(department.id);
            document.getElementById('departmentName').value = department.name;

            document.getElementById('departmentForm').classList.add('show');

            // Scroll to form
            document.getElementById('departmentForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Render department table
        function renderDepartmentTable() {
            const tbody = document.getElementById('departmentTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (departments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3">
                            <div class="empty-state">
                                <div class="empty-state-icon">üè¢</div>
                                <div class="empty-state-text">No departments yet. Click "Add New Department" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = departments.map(department => `
                <tr>
                    <td>${formatDepartmentId(department.id)}</td>
                    <td>${department.name}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editDepartment(${department.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Employee Management Functions
        let employees = [];
        let editingEmployeeId = null;

        // Load employees from localStorage
        function loadEmployees() {
            const stored = localStorage.getItem('wontonEmployees');
            if (stored) {
                employees = JSON.parse(stored);
            }
        }

        // Save employees to localStorage
        function saveEmployeesToStorage() {
            localStorage.setItem('wontonEmployees', JSON.stringify(employees));
        }

        // Get next employee ID
        function getNextEmployeeId() {
            if (employees.length === 0) return 1;
            return Math.max(...employees.map(e => e.id)) + 1;
        }

        // Format employee ID as 2-digit string
        function formatEmployeeId(id) {
            return String(id).padStart(2, '0');
        }

        // Update employee department dropdown
        function updateEmployeeDepartmentDropdown() {
            const select = document.getElementById('employeeDepartment');
            if (!select) return;

            const currentValue = select.value;

            // Clear and rebuild options
            select.innerHTML = '<option value="">Select Department</option>';

            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = `${formatDepartmentId(dept.id)} - ${dept.name}`;
                select.appendChild(option);
            });

            // Restore selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Get department name by ID
        function getDepartmentNameById(deptId) {
            const dept = departments.find(d => d.id === deptId);
            return dept ? dept.name : 'N/A';
        }

        // Toggle employee form
        function toggleEmployeeForm() {
            const form = document.getElementById('employeeForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetEmployeeForm();
                updateEmployeeDepartmentDropdown();
                form.classList.add('show');
                editingEmployeeId = null;
                document.getElementById('employeeFormTitle').textContent = 'Add New Employee';
                document.getElementById('employeeSaveBtn').textContent = 'Save Employee';
                document.getElementById('employeeId').value = formatEmployeeId(getNextEmployeeId());
            }
        }

        // Reset employee form
        function resetEmployeeForm() {
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeNameThai').value = '';
            document.getElementById('employeeNameOther').value = '';
            document.getElementById('employeeDepartment').value = '';
            document.getElementById('employeeStatus').value = 'Active';
        }

        // Cancel employee form
        function cancelEmployeeForm() {
            document.getElementById('employeeForm').classList.remove('show');
            resetEmployeeForm();
            editingEmployeeId = null;
        }

        // Save employee
        function saveEmployee(event) {
            event.preventDefault();

            const departmentId = parseInt(document.getElementById('employeeDepartment').value);

            const employee = {
                id: parseInt(document.getElementById('employeeId').value),
                nameThai: document.getElementById('employeeNameThai').value,
                nameOther: document.getElementById('employeeNameOther').value,
                departmentId: departmentId,
                departmentName: getDepartmentNameById(departmentId),
                status: document.getElementById('employeeStatus').value
            };

            if (editingEmployeeId !== null) {
                // Update existing employee
                const index = employees.findIndex(e => e.id === editingEmployeeId);
                if (index !== -1) {
                    employees[index] = employee;
                }
            } else {
                // Add new employee
                employees.push(employee);
            }

            saveEmployeesToStorage();
            renderEmployeeTable();
            cancelEmployeeForm();
        }

        // Edit employee
        function editEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            editingEmployeeId = employeeId;
            document.getElementById('employeeFormTitle').textContent = 'Edit Employee';
            document.getElementById('employeeSaveBtn').textContent = 'Update Employee';

            document.getElementById('employeeId').value = formatEmployeeId(employee.id);
            document.getElementById('employeeNameThai').value = employee.nameThai;
            document.getElementById('employeeNameOther').value = employee.nameOther;
            updateEmployeeDepartmentDropdown();
            document.getElementById('employeeDepartment').value = employee.departmentId;
            document.getElementById('employeeStatus').value = employee.status;

            document.getElementById('employeeForm').classList.add('show');

            // Scroll to form
            document.getElementById('employeeForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Render employee table
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (employees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div class="empty-state-text">No employees yet. Click "Add New Employee" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = employees.map(employee => `
                <tr>
                    <td>${formatEmployeeId(employee.id)}</td>
                    <td>${employee.nameThai}</td>
                    <td>${employee.nameOther}</td>
                    <td>${formatDepartmentId(employee.departmentId)}</td>
                    <td>${employee.departmentName}</td>
                    <td>
                        <span class="status-badge status-${employee.status.toLowerCase().replace(' ', '-')}">
                            ${employee.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editEmployee(${employee.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Customer Management Functions
        let customers = [];
        let editingCustomerId = null;

        // Load customers from localStorage
        function loadCustomers() {
            const stored = localStorage.getItem('wontonCustomers');
            if (stored) {
                customers = JSON.parse(stored);
            }
        }

        // Save customers to localStorage
        function saveCustomersToStorage() {
            localStorage.setItem('wontonCustomers', JSON.stringify(customers));
        }

        // Get next customer ID
        function getNextCustomerId() {
            if (customers.length === 0) return 1;
            return Math.max(...customers.map(c => c.id)) + 1;
        }

        // Format customer ID as 2-digit string
        function formatCustomerId(id) {
            return String(id).padStart(2, '0');
        }

        // Toggle customer form
        function toggleCustomerForm() {
            const form = document.getElementById('customerForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetCustomerForm();
                form.classList.add('show');
                editingCustomerId = null;
                document.getElementById('customerFormTitle').textContent = 'Add New Customer';
                document.getElementById('customerSaveBtn').textContent = 'Save Customer';
                document.getElementById('customerId').value = formatCustomerId(getNextCustomerId());
            }
        }

        // Reset customer form
        function resetCustomerForm() {
            document.getElementById('customerId').value = '';
            document.getElementById('customerNameThai').value = '';
            document.getElementById('customerNameBurmese').value = '';
            document.getElementById('customerClientType').value = '';
            document.getElementById('customerStatus').value = '';
        }

        // Cancel customer form
        function cancelCustomerForm() {
            document.getElementById('customerForm').classList.remove('show');
            resetCustomerForm();
            editingCustomerId = null;
        }

        // Save customer
        function saveCustomer(event) {
            event.preventDefault();

            const customer = {
                id: parseInt(document.getElementById('customerId').value),
                nameThai: document.getElementById('customerNameThai').value,
                nameBurmese: document.getElementById('customerNameBurmese').value,
                clientType: document.getElementById('customerClientType').value,
                status: document.getElementById('customerStatus').value
            };

            if (editingCustomerId !== null) {
                // Update existing customer
                const index = customers.findIndex(c => c.id === editingCustomerId);
                if (index !== -1) {
                    customers[index] = customer;
                }
            } else {
                // Add new customer
                customers.push(customer);
            }

            saveCustomersToStorage();
            renderCustomerTable();
            cancelCustomerForm();
        }

        // Edit customer
        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            editingCustomerId = customerId;
            document.getElementById('customerFormTitle').textContent = 'Edit Customer';
            document.getElementById('customerSaveBtn').textContent = 'Update Customer';

            document.getElementById('customerId').value = formatCustomerId(customer.id);
            document.getElementById('customerNameThai').value = customer.nameThai;
            document.getElementById('customerNameBurmese').value = customer.nameBurmese;
            document.getElementById('customerClientType').value = customer.clientType;
            document.getElementById('customerStatus').value = customer.status || 'Active';

            document.getElementById('customerForm').classList.add('show');

            // Scroll to form
            document.getElementById('customerForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Render customer table
        function renderCustomerTable() {
            const tbody = document.getElementById('customerTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë§</div>
                                <div class="empty-state-text">No customers yet. Click "Add New Customer" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td>${formatCustomerId(customer.id)}</td>
                    <td>${customer.nameThai}</td>
                    <td>${customer.nameBurmese}</td>
                    <td>
                        <span class="status-badge status-${customer.clientType.toLowerCase()}">
                            ${customer.clientType}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${(customer.status || 'Active').toLowerCase()}">
                            ${customer.status || 'Active'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editCustomer(${customer.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Modified navigateToPage function to render products when navigating to setup
        const originalNavigateToPage = navigateToPage;
        navigateToPage = function(pageId) {
            originalNavigateToPage(pageId);

            // If navigating to setup page, render the product table
            if (pageId === 'setup') {
                setTimeout(() => {
                    renderProductTable();
                    renderDepartmentTable();
                    renderEmployeeTable();
                    renderCustomerTable();
                }, 10);
            }

            // If navigating to dumpling production page, initialize it
            if (pageId === 'dumpling-production') {
                setTimeout(() => {
                    initProductionPage();
                }, 10);
            }

            // If navigating to other production page, initialize it
            if (pageId === 'other-production') {
                setTimeout(() => {
                    initOtherProductionPage();
                }, 10);
            }

            // If navigating to product outflow page, initialize it
            if (pageId === 'product-outflow') {
                setTimeout(() => {
                    initOutflowPage();
                }, 10);
            }
        };

        // ========== DUMPLING PRODUCTION FEATURE ==========
        
        // Production state
        let productionRecords = [];
        let dayStatus = {};
        let auditLog = [];
        let qualityStatus = [];  // Now stores per round per employee
        let roundSignoffs = [];  // New: sign-off data per round
        let roundStates = {};    // New: track round states (Draft/Saved/Signed-off)
        let currentProductionDate = '';
        let currentRound = 1;
        let draftData = {};  // Draft entries not yet saved
        let isDirty = false;  // Track unsaved changes
        let pendingNavigation = null;  // For navigation guards
        let reportContext = { selectedYear: null, selectedMonth: null };
        
        // Load production data from localStorage
        function loadProductionData() {
            const storedRecords = localStorage.getItem('wontonProductionRecords');
            if (storedRecords) {
                productionRecords = JSON.parse(storedRecords);
            }
        
            const storedDayStatus = localStorage.getItem('wontonDayStatus');
            if (storedDayStatus) {
                dayStatus = JSON.parse(storedDayStatus);
            }
        
            const storedAudit = localStorage.getItem('wontonProductionAudit');
            if (storedAudit) {
                auditLog = JSON.parse(storedAudit);
            }
        
            const storedQuality = localStorage.getItem('wontonQualityStatus');
            if (storedQuality) {
                qualityStatus = JSON.parse(storedQuality);
            }
        
            const storedSignoffs = localStorage.getItem('wontonRoundSignoffs');
            if (storedSignoffs) {
                roundSignoffs = JSON.parse(storedSignoffs);
            }
        
            const storedRoundStates = localStorage.getItem('wontonRoundStates');
            if (storedRoundStates) {
                roundStates = JSON.parse(storedRoundStates);
            }
        
            // Load draft from localStorage
            const storedDraft = localStorage.getItem('wontonDraftData');
            if (storedDraft) {
                draftData = JSON.parse(storedDraft);
            }
        }
        
        // Save production data to localStorage
        function saveProductionRecords() {
            localStorage.setItem('wontonProductionRecords', JSON.stringify(productionRecords));
        }
        
        function saveDayStatus() {
            localStorage.setItem('wontonDayStatus', JSON.stringify(dayStatus));
        }
        
        function saveAuditLog() {
            localStorage.setItem('wontonProductionAudit', JSON.stringify(auditLog));
        }
        
        function saveQualityStatus() {
            localStorage.setItem('wontonQualityStatus', JSON.stringify(qualityStatus));
        }
        
        function saveRoundSignoffs() {
            localStorage.setItem('wontonRoundSignoffs', JSON.stringify(roundSignoffs));
        }
        
        function saveRoundStates() {
            localStorage.setItem('wontonRoundStates', JSON.stringify(roundStates));
        }
        
        function saveDraftData() {
            localStorage.setItem('wontonDraftData', JSON.stringify(draftData));
        }
        
        // Initialize production page
        function initProductionPage() {
            loadProductionData();
        
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('productionDate').value = today;
            currentProductionDate = today;
        
            // Load the production day
            loadProductionDay();
        
            // Initialize search dropdowns
            populateSearchDropdowns();
        
            // Load year view for reports
            loadYearView();
        
            // Set up input change listeners for draft mode
            setupDraftListeners();
        }
        
        // Get eligible employees (Dept 01 + Active)
        function getEligibleEmployees() {
            return employees.filter(e => e.departmentId === 1 && e.status === 'Active');
        }
        
        // Get eligible products (Dept 01 + Active)
        function getEligibleProducts() {
            return products.filter(p => p.departmentId === 1 && p.status === 'Active');
        }
        
        // Get employee by ID (including historical)
        function getEmployeeById(id) {
            return employees.find(e => e.id === id);
        }
        
        // Get product by ID (including historical)
        function getProductById(id) {
            return products.find(p => p.id === id);
        }
        
        // Get rounds for a specific date
        function getDateRounds(date) {
            const savedRounds = productionRecords.filter(r => r.date === date);
            const uniqueRounds = [...new Set(savedRounds.map(r => r.round))];
        
            // Also check if there's a draft round
            const draftKey = `${date}_${currentRound}`;
            if (draftData[draftKey] && !uniqueRounds.includes(currentRound)) {
                // Draft exists for a round not yet saved
                uniqueRounds.push(currentRound);
            }
        
            return uniqueRounds.sort((a, b) => a - b);
        }
        
        // Get round state
        function getRoundState(date, round) {
            const key = `${date}_${round}`;
        
            // Check if signed off
            const signoff = roundSignoffs.find(s => s.date === date && s.round === round);
            if (signoff) return 'signed-off';
        
            // Check if saved
            const savedRecords = productionRecords.filter(r => r.date === date && r.round === round);
            if (savedRecords.length > 0) return 'saved';
        
            // Check if has draft data
            if (draftData[key]) return 'draft';
        
            return 'draft'; // Default for new rounds
        }
        
        // Load production day
        function loadProductionDay() {
            const date = document.getElementById('productionDate').value;
            currentProductionDate = date;

            // Get rounds for this date
            const rounds = getDateRounds(date);
            if (rounds.length === 0) {
                currentRound = 1;
            } else if (!rounds.includes(currentRound)) {
                // Check if currentRound is a new round (next in sequence)
                const maxRound = Math.max(...rounds);
                const isNewRound = currentRound === maxRound + 1;

                // Only reset to latest round if we're not explicitly adding a new round
                if (!isNewRound) {
                    currentRound = rounds[rounds.length - 1]; // Latest round
                }
                // Otherwise, keep currentRound as is (for new rounds)
            }

            // Load draft for current round
            loadDraftForCurrentRound();

            // Render UI
            renderRounds(rounds);
            updateDayStatusUI();
            updateRoundStatusUI();
            updateSignoffUI();
            renderProductDashboard();
            renderCurrentView();
        }
        
        // Load draft data for current round
        function loadDraftForCurrentRound() {
            const key = `${currentProductionDate}_${currentRound}`;
            const draft = draftData[key];
        
            if (draft) {
                // Draft exists, mark as dirty
                isDirty = true;
            } else {
                // No draft, not dirty
                isDirty = false;
            }
        }
        
        // Handle date change with navigation guard
        function handleDateChange() {
            if (isDirty) {
                pendingNavigation = { type: 'date', action: () => {
                    isDirty = false;
                    clearDraftForCurrentRound();
                    loadProductionDay();
                }};
                showModal('navigationGuardModal');
            } else {
                loadProductionDay();
            }
        }
        
        // Handle add round
        function handleAddRound() {
            if (isDirty) {
                pendingNavigation = { type: 'round', action: () => {
                    isDirty = false;
                    clearDraftForCurrentRound();
                    addNewRound();
                }};
                showModal('navigationGuardModal');
            } else {
                addNewRound();
            }
        }
        
        // Add new round
        function addNewRound() {
            const rounds = getDateRounds(currentProductionDate);
            const nextRound = rounds.length > 0 ? Math.max(...rounds) + 1 : 1;
            currentRound = nextRound;
            isDirty = false; // New round starts clean
            loadProductionDay();
        }
        
        // Select a round with navigation guard
        function selectRound(round) {
            if (round === currentRound) return; // Same round, do nothing
        
            if (isDirty) {
                pendingNavigation = { type: 'round', targetRound: round, action: () => {
                    isDirty = false;
                    clearDraftForCurrentRound();
                    currentRound = round;
                    loadProductionDay();
                }};
                showModal('navigationGuardModal');
            } else {
                currentRound = round;
                loadProductionDay();
            }
        }
        
        // Handle navigation guard modal actions
        function handleNavigationGuard(action) {
            hideModal('navigationGuardModal');
        
            if (action === 'cancel') {
                pendingNavigation = null;
                return;
            }
        
            if (action === 'discard') {
                clearDraftForCurrentRound();
                isDirty = false;
                if (pendingNavigation && pendingNavigation.action) {
                    pendingNavigation.action();
                }
                pendingNavigation = null;
            } else if (action === 'save') {
                openInitialsModal(() => {
                    isDirty = false;
                    if (pendingNavigation && pendingNavigation.action) {
                        pendingNavigation.action();
                    }
                    pendingNavigation = null;
                });
            }
        }
        
        // Clear draft for current round
        function clearDraftForCurrentRound() {
            const key = `${currentProductionDate}_${currentRound}`;
            delete draftData[key];
            saveDraftData();
        }
        
        // Render rounds selector
        function renderRounds(rounds) {
            const container = document.getElementById('roundSelectorInline');
            if (!container) return;
        
            container.innerHTML = '';
        
            // Render existing rounds
            rounds.forEach(round => {
                const btn = document.createElement('button');
                btn.className = 'round-btn' + (round === currentRound ? ' active' : '');
        
                // Add state indicator
                const state = getRoundState(currentProductionDate, round);
                let stateIcon = '';
                if (state === 'signed-off') stateIcon = '‚úì';
                else if (state === 'saved') stateIcon = 'üíæ';
                else if (state === 'draft') stateIcon = 'üìù';
        
                btn.textContent = `${stateIcon} Round ${round}`;
                btn.onclick = () => selectRound(round);
                container.appendChild(btn);
            });
        
            // Update add round button visibility
            const addRoundBtn = document.getElementById('addRoundBtn');
            const dayStatusValue = dayStatus[currentProductionDate] || 'Open';
            if (addRoundBtn) {
                addRoundBtn.style.display = (dayStatusValue === 'Open' || currentRole === 'admin') ? 'block' : 'none';
            }
        }
        
        // Update day status UI
        function updateDayStatusUI() {
            const status = dayStatus[currentProductionDate] || 'Open';
            const badge = document.getElementById('dayStatusBadge');
            const closeDayBtn = document.getElementById('closeDayBtn');
            const reopenDayBtn = document.getElementById('reopenDayBtn');
            const closeDayBtnGroup = document.getElementById('closeDayBtnGroup');

            if (badge) {
                badge.className = `day-status-badge ${status.toLowerCase()}`;
                badge.innerHTML = status === 'Open'
                    ? '<span>‚óè</span> Open'
                    : '<span>‚óè</span> Closed';
            }

            // Only show Close Day controls for admin
            if (closeDayBtnGroup) {
                closeDayBtnGroup.style.display = currentRole === 'admin' ? 'flex' : 'none';
            }

            if (closeDayBtn && reopenDayBtn) {
                if (status === 'Open') {
                    closeDayBtn.style.display = 'inline-block';
                    reopenDayBtn.style.display = 'none';
                } else {
                    closeDayBtn.style.display = 'none';
                    reopenDayBtn.style.display = 'inline-block';
                }
            }
        }
        
        // Update round status UI
        function updateRoundStatusUI() {
            const state = getRoundState(currentProductionDate, currentRound);
            const badge = document.getElementById('roundStatusBadge');
            const text = document.getElementById('roundStatusText');
        
            if (badge && text) {
                badge.className = `round-status-badge ${state}`;
        
                if (state === 'signed-off') {
                    badge.innerHTML = '<span>‚óè</span> <span id="roundStatusText">Signed Off</span>';
                } else if (state === 'saved') {
                    badge.innerHTML = '<span>‚óè</span> <span id="roundStatusText">Saved</span>';
                } else {
                    badge.innerHTML = '<span>‚óè</span> <span id="roundStatusText">Draft</span>';
                }
            }
        }
        
        // Update sign-off UI (using new compact badge)
        function updateSignoffUI() {
            const signoff = roundSignoffs.find(s =>
                s.date === currentProductionDate && s.round === currentRound
            );

            const statusText = document.getElementById('signoffStatusText');
            const statusBadge = document.getElementById('signoffStatusBadge');

            if (statusText && statusBadge) {
                if (signoff) {
                    const inspector = getEmployeeById(signoff.inspectedBy) || { nameThai: 'Unknown' };
                    statusText.textContent = `‚úì ${inspector.nameThai}`;
                    statusBadge.className = 'signoff-status-badge signed';
                    statusBadge.title = `Signed at ${new Date(signoff.signedOffAt).toLocaleString('th-TH')}`;
                } else {
                    statusText.textContent = 'Not signed';
                    statusBadge.className = 'signoff-status-badge not-signed';
                    statusBadge.title = '';
                }
            }
        }
        
        // Render current view (only accordion now)
        function renderCurrentView() {
            renderAccordionView();
        }
        
        // Render accordion view
        function renderAccordionView() {
            const container = document.getElementById('employeeAccordion');
            if (!container) return;
        
            container.innerHTML = '';
        
            const eligibleEmployees = getEligibleEmployees();
            const eligibleProducts = getEligibleProducts();
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};
        
            // Get saved entries
            const savedEntries = productionRecords.filter(
                r => r.date === currentProductionDate && r.round === currentRound
            );
        
            // Check if editable
            const roundState = getRoundState(currentProductionDate, currentRound);
            const dayStatusValue = dayStatus[currentProductionDate] || 'Open';
            const isEditable = (roundState !== 'signed-off' || currentRole === 'admin') &&
                               (dayStatusValue === 'Open' || currentRole === 'admin');
        
            eligibleEmployees.forEach(emp => {
                // Calculate employee subtotal (draft + saved)
                let subtotal = 0;
                eligibleProducts.forEach(prod => {
                    const entryKey = `${emp.id}_${prod.id}`;
                    if (currentDraft[entryKey]?.count !== undefined) {
                        subtotal += parseInt(currentDraft[entryKey].count) || 0;
                    } else {
                        const saved = savedEntries.find(e => e.employeeId === emp.id && e.productId === prod.id);
                        if (saved) subtotal += saved.count;
                    }
                });
        
                // Check if employee has any entries
                const hasEntries = subtotal > 0 || currentDraft[`quality_${emp.id}`];
                const statusClass = hasEntries ? 'has-entries' : 'no-entries';
                const statusText = hasEntries ? 'Has entries' : 'No entries';
        
                // Create accordion item
                const item = document.createElement('div');
                item.className = 'accordion-item';
                item.innerHTML = `
                    <div class="accordion-header" onclick="toggleAccordion(${emp.id})">
                        <div class="accordion-header-left">
                            <span class="accordion-employee-name">${emp.nameThai}${emp.nameOther ? ' / ' + emp.nameOther : ''}</span>
                            <span class="accordion-employee-id">(ID: ${emp.id})</span>
                        </div>
                        <div class="accordion-header-right">
                            <div class="accordion-subtotal">
                                Subtotal: <span class="accordion-subtotal-value">${subtotal}</span> packs
                            </div>
                            <span class="accordion-status ${statusClass}">${statusText}</span>
                            <span class="accordion-expand-icon" id="expand_${emp.id}">‚ñ∂</span>
                        </div>
                    </div>
                    <div class="accordion-content" id="content_${emp.id}">
                        <div class="product-mini-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Count</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${eligibleProducts.map(prod => {
                                        const entryKey = `${emp.id}_${prod.id}`;
                                        let count = '';
                                        let notes = '';
        
                                        if (currentDraft[entryKey]) {
                                            count = currentDraft[entryKey].count || '';
                                            notes = currentDraft[entryKey].notes || '';
                                        } else {
                                            const saved = savedEntries.find(e => e.employeeId === emp.id && e.productId === prod.id);
                                            if (saved) {
                                                count = saved.count;
                                                notes = saved.notes || '';
                                            }
                                        }
        
                                        return `
                                            <tr>
                                                <td>${prod.nameThai}${prod.nameEn ? ' / ' + prod.nameEn : ''}</td>
                                                <td>
                                                    <input type="number"
                                                        class="entry-input"
                                                        id="acc_count_${emp.id}_${prod.id}"
                                                        value="${count}"
                                                        min="0"
                                                        ${!isEditable ? 'disabled' : ''}
                                                        onchange="updateDraft(${emp.id}, ${prod.id})"
                                                        placeholder="0">
                                                </td>
                                                <td>
                                                    <input type="text"
                                                        class="entry-input"
                                                        id="acc_notes_${emp.id}_${prod.id}"
                                                        value="${notes}"
                                                        ${!isEditable ? 'disabled' : ''}
                                                        onchange="updateDraft(${emp.id}, ${prod.id})"
                                                        placeholder="Optional">
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="quality-check-section">
                            <h4>Quality Check for this Employee (Current Round)</h4>
                            <div class="quality-select-row">
                                <label>Status:</label>
                                <div class="quality-toggles">
                                    <button type="button" class="quality-toggle-btn ok ${getQualityStatus(emp.id) === 'OK' ? 'active' : ''}"
                                        id="quality_ok_${emp.id}"
                                        onclick="setQualityStatus(${emp.id}, 'OK')"
                                        ${!isEditable ? 'disabled' : ''}>
                                        ‚úì OK
                                    </button>
                                    <button type="button" class="quality-toggle-btn not-ok ${getQualityStatus(emp.id) === 'Not OK' ? 'active' : ''}"
                                        id="quality_notok_${emp.id}"
                                        onclick="setQualityStatus(${emp.id}, 'Not OK')"
                                        ${!isEditable ? 'disabled' : ''}>
                                        ‚úó Not OK
                                    </button>
                                </div>
                                <label style="margin-left: 16px;">Notes:</label>
                                <input type="text" class="entry-input" id="quality_notes_${emp.id}"
                                    value="${getQualityNotes(emp.id)}"
                                    onchange="updateQualityDraft(${emp.id})"
                                    ${!isEditable ? 'disabled' : ''}
                                    placeholder="Optional notes"
                                    style="flex: 1;">
                            </div>
                        </div>
                    </div>
                `;
        
                container.appendChild(item);
            });
        }
        
        // Toggle accordion
        function toggleAccordion(employeeId) {
            const content = document.getElementById(`content_${employeeId}`);
            const icon = document.getElementById(`expand_${employeeId}`);
            const header = content.previousElementSibling;
        
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                header.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                header.classList.add('expanded');
            }
        }
        
        // Get quality status for employee
        function getQualityStatus(employeeId) {
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};

            let status = 'Pending';
            if (currentDraft[`quality_${employeeId}`]) {
                status = currentDraft[`quality_${employeeId}`].status;
            } else {
                const saved = qualityStatus.find(q =>
                    q.date === currentProductionDate &&
                    q.round === currentRound &&
                    q.employeeId === employeeId
                );
                if (saved) status = saved.status;
            }

            return status;
        }

        // Set quality status for employee (for toggle buttons)
        function setQualityStatus(employeeId, newStatus) {
            const okBtn = document.getElementById(`quality_ok_${employeeId}`);
            const notOkBtn = document.getElementById(`quality_notok_${employeeId}`);

            // Toggle the clicked button
            if (newStatus === 'OK') {
                if (okBtn.classList.contains('active')) {
                    // Clicking active OK button sets to Pending
                    okBtn.classList.remove('active');
                    newStatus = 'Pending';
                } else {
                    // Set to OK
                    okBtn.classList.add('active');
                    notOkBtn.classList.remove('active');
                }
            } else if (newStatus === 'Not OK') {
                if (notOkBtn.classList.contains('active')) {
                    // Clicking active Not OK button sets to Pending
                    notOkBtn.classList.remove('active');
                    newStatus = 'Pending';
                } else {
                    // Set to Not OK
                    notOkBtn.classList.add('active');
                    okBtn.classList.remove('active');
                }
            }

            // Update the draft data
            const notesInput = document.getElementById(`quality_notes_${employeeId}`);
            const draftKey = `${currentProductionDate}_${currentRound}`;
            if (!draftData[draftKey]) draftData[draftKey] = {};

            draftData[draftKey][`quality_${employeeId}`] = {
                status: newStatus,
                notes: notesInput ? notesInput.value : ''
            };

            isDirty = true;
            saveDraftData();
            updateDraftIndicator();
        }
        
        // Get quality notes for employee
        function getQualityNotes(employeeId) {
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};
        
            if (currentDraft[`quality_${employeeId}`]) {
                return currentDraft[`quality_${employeeId}`].notes || '';
            }
        
            const saved = qualityStatus.find(q =>
                q.date === currentProductionDate &&
                q.round === currentRound &&
                q.employeeId === employeeId
            );
        
            return saved ? (saved.notes || '') : '';
        }
        
        // Update draft when user changes input
        function updateDraft(employeeId, productId) {
            const countInput = document.getElementById(`acc_count_${employeeId}_${productId}`) ||
                               document.getElementById(`spr_count_${employeeId}_${productId}`);
            const notesInput = document.getElementById(`acc_notes_${employeeId}_${productId}`) ||
                               document.getElementById(`spr_notes_${employeeId}_${productId}`);
        
            const draftKey = `${currentProductionDate}_${currentRound}`;
            if (!draftData[draftKey]) draftData[draftKey] = {};
        
            const entryKey = `${employeeId}_${productId}`;
            draftData[draftKey][entryKey] = {
                count: countInput ? countInput.value : '',
                notes: notesInput ? notesInput.value : ''
            };
        
            isDirty = true;
            saveDraftData();
            updateDraftIndicator();
            renderProductDashboard(); // Update dashboard to reflect draft changes
        
            // Update accordion subtotal if in accordion view
            if (currentView === 'accordion') {
                updateAccordionSubtotal(employeeId);
            }
        }
        
        // Update accordion subtotal
        function updateAccordionSubtotal(employeeId) {
            const eligibleProducts = getEligibleProducts();
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};
            const savedEntries = productionRecords.filter(
                r => r.date === currentProductionDate && r.round === currentRound && r.employeeId === employeeId
            );
        
            let subtotal = 0;
            eligibleProducts.forEach(prod => {
                const entryKey = `${employeeId}_${prod.id}`;
                if (currentDraft[entryKey]?.count !== undefined) {
                    subtotal += parseInt(currentDraft[entryKey].count) || 0;
                } else {
                    const saved = savedEntries.find(e => e.productId === prod.id);
                    if (saved) subtotal += saved.count;
                }
            });
        
            // Find and update the subtotal display
            const subtotalElem = document.querySelector(`#content_${employeeId}`).previousElementSibling.querySelector('.accordion-subtotal-value');
            if (subtotalElem) {
                subtotalElem.textContent = subtotal;
            }
        }
        
        // Update quality draft
        function updateQualityDraft(employeeId) {
            // Get current status from buttons
            const okBtn = document.getElementById(`quality_ok_${employeeId}`);
            const notOkBtn = document.getElementById(`quality_notok_${employeeId}`);
            const notesInput = document.getElementById(`quality_notes_${employeeId}`);

            let status = 'Pending';
            if (okBtn && okBtn.classList.contains('active')) {
                status = 'OK';
            } else if (notOkBtn && notOkBtn.classList.contains('active')) {
                status = 'Not OK';
            }

            const draftKey = `${currentProductionDate}_${currentRound}`;
            if (!draftData[draftKey]) draftData[draftKey] = {};

            draftData[draftKey][`quality_${employeeId}`] = {
                status: status,
                notes: notesInput ? notesInput.value : ''
            };

            isDirty = true;
            saveDraftData();
            updateDraftIndicator();
        }
        
        // Update draft indicator
        function updateDraftIndicator() {
            const indicator = document.getElementById('draftIndicator');
            if (indicator) {
                indicator.style.display = isDirty ? 'block' : 'none';
            }
        }
        
        // Render spreadsheet view
        function renderSpreadsheetView() {
            const container = document.getElementById('spreadsheetGrid');
            if (!container) return;
        
            const eligibleEmployees = getEligibleEmployees();
            const eligibleProducts = getEligibleProducts();
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};
        
            // Get saved entries
            const savedEntries = productionRecords.filter(
                r => r.date === currentProductionDate && r.round === currentRound
            );
        
            // Check if editable
            const roundState = getRoundState(currentProductionDate, currentRound);
            const dayStatusValue = dayStatus[currentProductionDate] || 'Open';
            const isEditable = (roundState !== 'signed-off' || currentRole === 'admin') &&
                               (dayStatusValue === 'Open' || currentRole === 'admin');
        
            let html = '<table><thead><tr>';
            html += '<th class="employee-col">Employee</th>';
            eligibleProducts.forEach(prod => {
                html += `<th>${prod.nameThai}${prod.nameEn ? ' / ' + prod.nameEn : ''}</th>`;
            });
            html += '<th>Quality</th>';
            html += '</tr></thead><tbody>';
        
            eligibleEmployees.forEach(emp => {
                html += '<tr>';
                html += `<td class="employee-name">${emp.nameThai} (${emp.id})`;
        
                // Quality icon/status
                const qualityStatus = getQualityStatusForEmployee(emp.id);
                const qualityIcon = qualityStatus === 'OK' ? '‚úì' : qualityStatus === 'Not OK' ? '‚úó' : '‚óã';
                const qualityColor = qualityStatus === 'OK' ? '#4CAF50' : qualityStatus === 'Not OK' ? '#F44336' : '#FF9800';
                html += `<span class="spreadsheet-quality-icon" style="color: ${qualityColor}"
                            title="${qualityStatus}" onclick="openQualityModal(${emp.id})">${qualityIcon}</span>`;
                html += '</td>';
        
                eligibleProducts.forEach(prod => {
                    const entryKey = `${emp.id}_${prod.id}`;
                    let count = '';
        
                    if (currentDraft[entryKey]) {
                        count = currentDraft[entryKey].count || '';
                    } else {
                        const saved = savedEntries.find(e => e.employeeId === emp.id && e.productId === prod.id);
                        if (saved) count = saved.count;
                    }
        
                    html += `<td>
                        <input type="number"
                            id="spr_count_${emp.id}_${prod.id}"
                            value="${count}"
                            min="0"
                            ${!isEditable ? 'disabled' : ''}
                            onchange="updateDraft(${emp.id}, ${prod.id})"
                            placeholder="0">
                    </td>`;
                });
        
                // Quality status cell
                html += `<td style="text-align: center;">
                    <select class="entry-select" id="spr_quality_${emp.id}"
                        onchange="updateQualityDraftSpreadsheet(${emp.id})"
                        ${!isEditable ? 'disabled' : ''}
                        style="width: 100px;">
                        ${getQualityOptionsSpreadsheet(emp.id)}
                    </select>
                </td>`;
        
                html += '</tr>';
            });
        
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Get quality status for employee
        function getQualityStatusForEmployee(employeeId) {
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};
        
            if (currentDraft[`quality_${employeeId}`]) {
                return currentDraft[`quality_${employeeId}`].status;
            }
        
            const saved = qualityStatus.find(q =>
                q.date === currentProductionDate &&
                q.round === currentRound &&
                q.employeeId === employeeId
            );
        
            return saved ? saved.status : 'Pending';
        }
        
        // Get quality options for spreadsheet
        function getQualityOptionsSpreadsheet(employeeId) {
            const status = getQualityStatusForEmployee(employeeId);
            return `
                <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="OK" ${status === 'OK' ? 'selected' : ''}>OK</option>
                <option value="Not OK" ${status === 'Not OK' ? 'selected' : ''}>Not OK</option>
            `;
        }
        
        // Update quality draft from spreadsheet
        function updateQualityDraftSpreadsheet(employeeId) {
            const statusSelect = document.getElementById(`spr_quality_${employeeId}`);
        
            const draftKey = `${currentProductionDate}_${currentRound}`;
            if (!draftData[draftKey]) draftData[draftKey] = {};
        
            // Get existing notes if any
            const existingNotes = draftData[draftKey][`quality_${employeeId}`]?.notes || '';
        
            draftData[draftKey][`quality_${employeeId}`] = {
                status: statusSelect ? statusSelect.value : 'Pending',
                notes: existingNotes
            };
        
            isDirty = true;
            saveDraftData();
            updateDraftIndicator();
        }
        
        // Render per-product dashboard
        function renderProductDashboard() {
            const container = document.getElementById('productDashboard');
            if (!container) return;
        
            const eligibleProducts = getEligibleProducts();
            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};
        
            // Get saved entries for current round
            const savedEntries = productionRecords.filter(
                r => r.date === currentProductionDate && r.round === currentRound
            );
        
            container.innerHTML = '';
        
            eligibleProducts.forEach(prod => {
                // Calculate total for this product (draft + saved)
                let total = 0;
                const eligibleEmployees = getEligibleEmployees();
        
                eligibleEmployees.forEach(emp => {
                    const entryKey = `${emp.id}_${prod.id}`;
                    if (currentDraft[entryKey]?.count !== undefined) {
                        total += parseInt(currentDraft[entryKey].count) || 0;
                    } else {
                        const saved = savedEntries.find(e => e.employeeId === emp.id && e.productId === prod.id);
                        if (saved) total += saved.count;
                    }
                });
        
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-card-name">${prod.nameThai}${prod.nameEn ? ' / ' + prod.nameEn : ''}</div>
                    <div class="product-card-value">${total}</div>
                    <div class="product-card-label">packs (this round)</div>
                `;
                container.appendChild(card);
            });
        
            updateDraftIndicator();
        }
        
        // Save current round
        function saveCurrentRound(callback) {
            const roundState = getRoundState(currentProductionDate, currentRound);
            const dayStatusValue = dayStatus[currentProductionDate] || 'Open';

            // Check if round is signed off
            if (roundState === 'signed-off' && currentRole !== 'admin') {
                alert('This round is signed off. Only admins can edit signed-off rounds.');
                return;
            }

            // Check if day is closed
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can edit closed days.');
                return;
            }

            const draftKey = `${currentProductionDate}_${currentRound}`;
            const currentDraft = draftData[draftKey] || {};

            // Save production entries
            const eligibleEmployees = getEligibleEmployees();
            const eligibleProducts = getEligibleProducts();

            eligibleEmployees.forEach(emp => {
                eligibleProducts.forEach(prod => {
                    const entryKey = `${emp.id}_${prod.id}`;
                    if (currentDraft[entryKey]) {
                        const count = parseInt(currentDraft[entryKey].count) || 0;
                        const notes = currentDraft[entryKey].notes || '';

                        if (count > 0 || notes) {
                            saveEntry(emp.id, prod.id, count, notes);
                        }
                    }
                });

                // Save quality status for this employee
                if (currentDraft[`quality_${emp.id}`]) {
                    saveQualityForEmployee(emp.id, currentDraft[`quality_${emp.id}`]);
                }
            });

            // Save to localStorage
            saveProductionRecords();
            saveQualityStatus();

            // Clear draft
            delete draftData[draftKey];
            saveDraftData();
            isDirty = false;

            // Update last saved time
            const lastSavedInfo = document.getElementById('lastSavedInfo');
            const lastSavedTime = document.getElementById('lastSavedTime');
            if (lastSavedInfo && lastSavedTime) {
                lastSavedTime.textContent = new Date().toLocaleTimeString('th-TH');
                lastSavedInfo.style.display = 'block';
            }

            if (callback) callback();
        }
        
        // Save individual entry
        function saveEntry(employeeId, productId, count, notes) {
            const key = {
                date: currentProductionDate,
                round: currentRound,
                employeeId: employeeId,
                productId: productId
            };
        
            // Find existing entry
            const existingIndex = productionRecords.findIndex(r =>
                r.date === key.date &&
                r.round === key.round &&
                r.employeeId === key.employeeId &&
                r.productId === key.productId
            );
        
            const now = Date.now();
        
            if (existingIndex !== -1) {
                // Update existing entry
                const oldEntry = { ...productionRecords[existingIndex] };
                productionRecords[existingIndex].count = count;
                productionRecords[existingIndex].notes = notes;
                productionRecords[existingIndex].updatedAt = now;
        
                // Add audit log
                addAuditLog(key, oldEntry.count, count, 'Updated');
            } else {
                // Create new entry
                const entry = {
                    id: Date.now() + Math.random(),
                    ...key,
                    count: count,
                    notes: notes,
                    createdAt: now,
                    updatedAt: now
                };
                productionRecords.push(entry);
        
                // Add audit log
                addAuditLog(key, null, count, 'Created');
            }
        }
        
        // Save quality status for employee
        function saveQualityForEmployee(employeeId, qualityData) {
            // Find existing quality status
            const existingIndex = qualityStatus.findIndex(q =>
                q.date === currentProductionDate &&
                q.round === currentRound &&
                q.employeeId === employeeId
            );
        
            const qualityEntry = {
                date: currentProductionDate,
                round: currentRound,
                employeeId: employeeId,
                status: qualityData.status,
                notes: qualityData.notes || '',
                updatedAt: Date.now()
            };
        
            if (existingIndex !== -1) {
                qualityStatus[existingIndex] = qualityEntry;
            } else {
                qualityStatus.push(qualityEntry);
            }
        }
        
        // Add audit log entry
        function addAuditLog(key, oldValue, newValue, action) {
            const status = dayStatus[key.date] || 'Open';
        
            auditLog.push({
                id: Date.now() + Math.random(),
                date: key.date,
                round: key.round,
                employeeId: key.employeeId,
                productId: key.productId,
                oldValue: oldValue,
                newValue: newValue,
                action: action,
                dayStatus: status,
                editedBy: currentRole,
                timestamp: Date.now()
            });
        
            saveAuditLog();
        }
        
        // Variable to store callback after save
        let saveCallback = null;

        // Open initials modal before save
        function openInitialsModal(callback) {
            const roundState = getRoundState(currentProductionDate, currentRound);
            const dayStatusValue = dayStatus[currentProductionDate] || 'Open';

            // Check if round is signed off
            if (roundState === 'signed-off' && currentRole !== 'admin') {
                alert('This round is signed off. Only admins can edit signed-off rounds.');
                return;
            }

            // Check if day is closed
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can edit closed days.');
                return;
            }

            // Store callback for later
            saveCallback = callback;

            // Populate date and round info
            document.getElementById('initialsModalDate').textContent = currentProductionDate;
            document.getElementById('initialsModalRound').textContent = currentRound;

            // Clear previous inputs
            document.getElementById('inspectorInitials').value = '';
            document.getElementById('initialsNotes').value = '';
            document.getElementById('initialsError').style.display = 'none';

            showModal('initialsModal');
        }

        // Confirm initials and save round with sign-off
        function confirmInitialsAndSave() {
            const initials = document.getElementById('inspectorInitials').value.trim().toUpperCase();
            const notes = document.getElementById('initialsNotes').value.trim();
            const errorDiv = document.getElementById('initialsError');

            if (!initials) {
                errorDiv.textContent = 'Please enter your initials to sign-off.';
                errorDiv.style.display = 'block';
                return;
            }

            if (initials.length < 2) {
                errorDiv.textContent = 'Initials must be at least 2 characters.';
                errorDiv.style.display = 'block';
                return;
            }

            // Hide modal
            hideModal('initialsModal');

            // Create sign-off record with initials
            const signoff = {
                date: currentProductionDate,
                round: currentRound,
                inspectorInitials: initials,
                signedOffAt: Date.now(),
                notes: notes
            };

            roundSignoffs.push(signoff);
            saveRoundSignoffs();

            // Save the round
            saveCurrentRound(() => {
                alert('Round saved and signed-off successfully!');

                // Execute callback if provided (for navigation guard)
                if (saveCallback) {
                    saveCallback();
                    saveCallback = null;
                } else {
                    // Normal flow - reload the page
                    loadProductionDay();
                }
            });
        }

        // Open sign-off modal after save (called automatically)
        function openSignoffModalAfterSave() {
            // Populate date and round info
            document.getElementById('signoffModalDate').textContent = currentProductionDate;
            document.getElementById('signoffModalRound').textContent = currentRound;

            // Clear previous inputs
            document.getElementById('inspectorName').value = '';
            document.getElementById('signoffNotes').value = '';
            document.getElementById('signoffMethod').value = 'typed_name';
            document.getElementById('signoffError').style.display = 'none';

            showModal('signoffModal');
        }

        // Open sign-off modal (for manual trigger - kept for compatibility)
        function openSignoffModal() {
            const roundState = getRoundState(currentProductionDate, currentRound);

            if (roundState === 'draft') {
                alert('Please save the round before signing off.');
                return;
            }

            if (isDirty) {
                alert('Please save the round before signing off.');
                return;
            }

            openSignoffModalAfterSave();
        }
        
        // Confirm sign-off
        function confirmSignoff() {
            const inspectorName = document.getElementById('inspectorName').value.trim();
            const signoffMethod = document.getElementById('signoffMethod').value;
            const signoffNotes = document.getElementById('signoffNotes').value.trim();
            const errorDiv = document.getElementById('signoffError');
        
            if (!inspectorName) {
                errorDiv.textContent = 'Please enter inspector name.';
                errorDiv.style.display = 'block';
                return;
            }
        
            // Find employee by name (simple match)
            const inspector = employees.find(e => e.nameThai.includes(inspectorName));
            const inspectorId = inspector ? inspector.id : null;
        
            if (!inspectorId) {
                errorDiv.textContent = 'Inspector not found in employee list. Please use exact name.';
                errorDiv.style.display = 'block';
                return;
            }
        
            // Create sign-off record
            const signoff = {
                date: currentProductionDate,
                round: currentRound,
                inspectedBy: inspectorId,
                signedOffAt: Date.now(),
                signatureMethod: signoffMethod,
                signatureValue: inspectorName,
                notes: signoffNotes
            };
        
            roundSignoffs.push(signoff);
            saveRoundSignoffs();
        
            hideModal('signoffModal');
            alert('Round signed off successfully!');
            loadProductionDay();
        }
        
        // Close day
        function closeDay() {
            dayStatus[currentProductionDate] = 'Closed';
            saveDayStatus();
        
            // Add audit log
            auditLog.push({
                id: Date.now() + Math.random(),
                date: currentProductionDate,
                action: 'Day Closed',
                editedBy: currentRole,
                timestamp: Date.now()
            });
            saveAuditLog();
        
            hideModal('closeDayModal');
            updateDayStatusUI();
            renderCurrentView();
        
            alert(`Production day ${currentProductionDate} has been closed.`);
        }
        
        // Reopen day
        function reopenDay() {
            if (currentRole !== 'admin') {
                alert('Only admins can reopen closed days.');
                return;
            }
        
            dayStatus[currentProductionDate] = 'Open';
            saveDayStatus();
        
            // Add audit log
            auditLog.push({
                id: Date.now() + Math.random(),
                date: currentProductionDate,
                action: 'Day Reopened',
                editedBy: currentRole,
                timestamp: Date.now()
            });
            saveAuditLog();
        
            updateDayStatusUI();
            renderCurrentView();
        
            alert(`Production day ${currentProductionDate} has been reopened.`);
        }
        
        // Setup draft listeners
        function setupDraftListeners() {
            // This function can be used to set up global input listeners if needed
            // For now, we're using onchange handlers directly in the HTML
        }
        
        // Close day modal
        function closeDayModal() {
            showModal('closeDayModal');
        }
        
        // Show modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
            }
        }
        
        // Hide modal
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        // Switch production tab
        function switchProductionTab(tabName) {
            // Update tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'reports') {
                loadYearView();
            } else if (tabName === 'search') {
                populateSearchDropdowns();
            }
        }

        // Switch setup tab
        function switchSetupTab(tabName) {
            // Update tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // ========== REPORTS ==========
        
        // Show report view
        function showReportView(view) {
            // Update nav
            document.querySelectorAll('.nav-chip').forEach(chip => chip.classList.remove('active'));
            event.target.classList.add('active');
        
            // Hide all views
            document.querySelectorAll('.report-view').forEach(v => v.style.display = 'none');
        
            // Show selected view
            document.getElementById(`${view}-view`).style.display = 'block';
        
            // Load data
            if (view === 'year') {
                loadYearView();
            } else if (view === 'month') {
                loadMonthView(reportContext.selectedYear);
            } else if (view === 'day') {
                loadDayView(reportContext.selectedYear, reportContext.selectedMonth);
            }
        }
        
        // Load year view
        function loadYearView() {
            const tbody = document.getElementById('yearViewBody');
            if (!tbody) return;

            // Group records by year
            const yearData = {};
            productionRecords.forEach(r => {
                const year = r.date.substring(0, 4);
                if (!yearData[year]) {
                    yearData[year] = {
                        productCounts: {},
                        dates: new Set(),
                        employees: new Set()
                    };
                }
                // Group by product
                if (!yearData[year].productCounts[r.productId]) {
                    yearData[year].productCounts[r.productId] = 0;
                }
                yearData[year].productCounts[r.productId] += r.count;
                yearData[year].dates.add(r.date);
                yearData[year].employees.add(r.employeeId);
            });

            // Render table
            const years = Object.keys(yearData).sort((a, b) => b - a);

            if (years.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No production records yet.</td></tr>';
                return;
            }

            tbody.innerHTML = years.map(year => {
                // Format product breakdown
                const productBreakdown = Object.entries(yearData[year].productCounts)
                    .map(([productId, count]) => {
                        const product = getProductById(parseInt(productId));
                        const productName = product ? product.nameThai : `Product ${productId}`;
                        return `${productName}: ${count.toLocaleString()}`;
                    })
                    .join('<br>');

                // Calculate total
                const totalPacks = Object.values(yearData[year].productCounts).reduce((sum, count) => sum + count, 0);
                const productBreakdownWithTotal = `${productBreakdown}<br><strong>Total: ${totalPacks.toLocaleString()} packs</strong>`;

                return `
                <tr class="clickable-row" onclick="drillDownToMonth('${year}')">
                    <td><strong>${year}</strong></td>
                    <td style="line-height: 1.6;">${productBreakdownWithTotal}</td>
                    <td>${yearData[year].dates.size} days</td>
                    <td>${yearData[year].employees.size} employees</td>
                    <td><button class="btn btn-primary btn-small" onclick="event.stopPropagation(); drillDownToMonth('${year}')">View Details ‚Üí</button></td>
                </tr>
            `;
            }).join('');
        }
        
        // Drill down to month view
        function drillDownToMonth(year) {
            reportContext.selectedYear = year;
            document.getElementById('selectedYear').textContent = year;
            showReportView('month');
            loadMonthView(year);
        }
        
        // Load month view
        function loadMonthView(year) {
            const tbody = document.getElementById('monthViewBody');
            if (!tbody) return;

            // Group records by month
            const monthData = {};
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            productionRecords
                .filter(r => r.date.startsWith(year))
                .forEach(r => {
                    const month = r.date.substring(5, 7);
                    if (!monthData[month]) {
                        monthData[month] = {
                            productCounts: {},
                            dates: new Set()
                        };
                    }
                    // Group by product
                    if (!monthData[month].productCounts[r.productId]) {
                        monthData[month].productCounts[r.productId] = 0;
                    }
                    monthData[month].productCounts[r.productId] += r.count;
                    monthData[month].dates.add(r.date);
                });

            // Render table
            const months = Object.keys(monthData).sort();

            if (months.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No production records for this year.</td></tr>';
                return;
            }

            tbody.innerHTML = months.map(month => {
                const monthNum = parseInt(month);

                // Format product breakdown
                const productBreakdown = Object.entries(monthData[month].productCounts)
                    .map(([productId, count]) => {
                        const product = getProductById(parseInt(productId));
                        const productName = product ? product.nameThai : `Product ${productId}`;
                        return `${productName}: ${count.toLocaleString()}`;
                    })
                    .join('<br>');

                // Calculate total
                const totalPacks = Object.values(monthData[month].productCounts).reduce((sum, count) => sum + count, 0);
                const productBreakdownWithTotal = `${productBreakdown}<br><strong>Total: ${totalPacks.toLocaleString()} packs</strong>`;

                return `
                    <tr class="clickable-row" onclick="drillDownToDay('${year}', '${month}')">
                        <td><strong>${monthNames[monthNum - 1]} ${year}</strong></td>
                        <td style="line-height: 1.6;">${productBreakdownWithTotal}</td>
                        <td>${monthData[month].dates.size} days</td>
                        <td><button class="btn btn-primary btn-small" onclick="event.stopPropagation(); drillDownToDay('${year}', '${month}')">View Details ‚Üí</button></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Drill down to day view
        function drillDownToDay(year, month) {
            reportContext.selectedYear = year;
            reportContext.selectedMonth = month;
            document.getElementById('selectedMonth').textContent = `${['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][parseInt(month) - 1]} ${year}`;
            showReportView('day');
            loadDayView(year, month);
        }
        
        // Load day view
        function loadDayView(year, month) {
            const tbody = document.getElementById('dayViewBody');
            if (!tbody) return;

            // Group records by date
            const dateData = {};

            productionRecords
                .filter(r => r.date.startsWith(`${year}-${month}`))
                .forEach(r => {
                    if (!dateData[r.date]) {
                        dateData[r.date] = {
                            productCounts: {},
                            rounds: new Set(),
                            entries: 0
                        };
                    }
                    // Group by product
                    if (!dateData[r.date].productCounts[r.productId]) {
                        dateData[r.date].productCounts[r.productId] = 0;
                    }
                    dateData[r.date].productCounts[r.productId] += r.count;
                    dateData[r.date].rounds.add(r.round);
                    dateData[r.date].entries++;
                });

            // Render table
            const dates = Object.keys(dateData).sort((a, b) => b.localeCompare(a));

            if (dates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No production records for this month.</td></tr>';
                return;
            }

            tbody.innerHTML = dates.map(date => {
                const status = dayStatus[date] || 'Open';
                const statusBadge = status === 'Open'
                    ? '<span style="color: #4CAF50;">‚óè Open</span>'
                    : '<span style="color: #666;">‚óè Closed</span>';

                // Format product breakdown
                const productBreakdown = Object.entries(dateData[date].productCounts)
                    .map(([productId, count]) => {
                        const product = getProductById(parseInt(productId));
                        const productName = product ? product.nameThai : `Product ${productId}`;
                        return `${productName}: ${count.toLocaleString()}`;
                    })
                    .join('<br>');

                // Calculate total
                const totalPacks = Object.values(dateData[date].productCounts).reduce((sum, count) => sum + count, 0);
                const productBreakdownWithTotal = `${productBreakdown}<br><strong>Total: ${totalPacks.toLocaleString()} packs</strong>`;

                // Create buttons for each round
                const roundButtons = Array.from(dateData[date].rounds).sort((a, b) => a - b).map(round => {
                    return `<button class="btn btn-primary btn-small" onclick="showDayDetailSpreadsheet('${date}', ${round})" style="margin: 2px;">Round ${round}</button>`;
                }).join('');

                return `
                    <tr>
                        <td><strong>${date}</strong></td>
                        <td>${statusBadge}</td>
                        <td style="line-height: 1.6;">${productBreakdownWithTotal}</td>
                        <td>${dateData[date].rounds.size} rounds</td>
                        <td>${dateData[date].entries} entries</td>
                        <td style="line-height: 2;">${roundButtons}<br><button class="btn btn-secondary btn-small" onclick="jumpToDate('${date}')" style="margin-top: 4px;">Edit ‚Üí</button></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Jump to specific date
        function jumpToDate(date) {
            document.getElementById('productionDate').value = date;
            currentProductionDate = date;
            loadProductionDay();
            switchProductionTab('entry');
        }

        // Show day detail with spreadsheet view
        function showDayDetailSpreadsheet(date, round) {
            // Hide the day view table
            document.querySelector('#day-view .report-table').style.display = 'none';

            // Show detail view
            const detailView = document.getElementById('dayDetailView');
            detailView.style.display = 'block';

            // Update header
            document.getElementById('detailViewDate').textContent = date;
            document.getElementById('detailViewRound').textContent = round;

            // Render spreadsheet for this date/round
            renderReportSpreadsheet(date, round);
        }

        // Close day detail view
        function closeDayDetailView() {
            document.getElementById('dayDetailView').style.display = 'none';
            document.querySelector('#day-view .report-table').style.display = 'block';
        }

        // Render spreadsheet in reports tab
        function renderReportSpreadsheet(date, round) {
            const container = document.getElementById('reportSpreadsheetGrid');
            if (!container) return;

            const eligibleEmployees = employees.filter(e => e.departmentId === 1 && e.status === 'Active');
            const eligibleProducts = products.filter(p => p.departmentId === 1);

            // Get saved entries for this date/round
            const savedEntries = productionRecords.filter(
                r => r.date === date && r.round === round
            );

            // Check if editable (read-only in reports view)
            const isEditable = false;

            let html = '<table><thead><tr>';
            html += '<th class="employee-col">Employee</th>';
            eligibleProducts.forEach(prod => {
                html += `<th>${prod.nameThai}${prod.nameEn ? ' / ' + prod.nameEn : ''}</th>`;
            });
            html += '<th>Quality</th>';
            html += '</tr></thead><tbody>';

            eligibleEmployees.forEach(emp => {
                html += '<tr>';
                html += `<td class="employee-name">${emp.nameThai}${emp.nameOther ? ' / ' + emp.nameOther : ''} (${emp.id})`;

                // Quality icon/status
                const qualityData = qualityStatus.find(q => q.date === date && q.round === round && q.employeeId === emp.id);
                const qualityValue = qualityData ? qualityData.status : '';
                const qualityIcon = qualityValue === 'OK' ? '‚úì' : qualityValue === 'Not OK' ? '‚úó' : '‚óã';
                const qualityColor = qualityValue === 'OK' ? '#4CAF50' : qualityValue === 'Not OK' ? '#F44336' : '#FF9800';
                html += `<span class="spreadsheet-quality-icon" style="color: ${qualityColor}"
                            title="${qualityValue}">${qualityIcon}</span>`;
                html += '</td>';

                eligibleProducts.forEach(prod => {
                    const saved = savedEntries.find(e => e.employeeId === emp.id && e.productId === prod.id);
                    const count = saved ? saved.count : '';
                    html += `<td><input type="text" value="${count}" readonly style="background: #f5f5f5;"></td>`;
                });

                // Quality cell (read-only)
                html += `<td><span class="quality-display">${qualityValue || '-'}</span></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ========== SEARCH ==========
        
        // Populate search dropdowns
        function populateSearchDropdowns() {
            const employeeSelect = document.getElementById('searchEmployee');
            const productSelect = document.getElementById('searchProduct');
        
            if (!employeeSelect || !productSelect) return;
        
            // Clear existing options (keep "All" option)
            employeeSelect.innerHTML = '<option value="">All Employees</option>';
            productSelect.innerHTML = '<option value="">All Products</option>';
        
            // Add employees
            const eligibleEmployees = employees.filter(e => e.departmentId === 1);
            eligibleEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.nameThai} (${emp.id})`;
                employeeSelect.appendChild(option);
            });
        
            // Add products
            const eligibleProducts = products.filter(p => p.departmentId === 1);
            eligibleProducts.forEach(prod => {
                const option = document.createElement('option');
                option.value = prod.id;
                option.textContent = `${prod.nameThai} (${prod.id})`;
                productSelect.appendChild(option);
            });
        }
        
        // Perform search
        function performSearch() {
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;
            const employeeId = document.getElementById('searchEmployee').value;
            const productId = document.getElementById('searchProduct').value;
            const dayStatusFilter = document.getElementById('searchDayStatus').value;
            const qualityFilter = document.getElementById('searchQualityStatus').value;
        
            // Filter records
            let filtered = productionRecords;
        
            if (dateFrom) {
                filtered = filtered.filter(r => r.date >= dateFrom);
            }
        
            if (dateTo) {
                filtered = filtered.filter(r => r.date <= dateTo);
            }
        
            if (employeeId) {
                filtered = filtered.filter(r => r.employeeId == employeeId);
            }
        
            if (productId) {
                filtered = filtered.filter(r => r.productId == productId);
            }
        
            if (dayStatusFilter) {
                filtered = filtered.filter(r => {
                    const status = dayStatus[r.date] || 'Open';
                    return status === dayStatusFilter;
                });
            }
        
            if (qualityFilter) {
                filtered = filtered.filter(r => {
                    const quality = qualityStatus.find(q =>
                        q.date === r.date &&
                        q.round === r.round &&
                        q.employeeId === r.employeeId
                    );
                    return quality && quality.status === qualityFilter;
                });
            }
        
            // Render results
            renderSearchResults(filtered);
        }
        
        // Render search results
        function renderSearchResults(records) {
            const resultsDiv = document.getElementById('searchResults');
            const tbody = document.getElementById('searchResultsBody');
        
            if (!resultsDiv || !tbody) return;
        
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No results found.</td></tr>';
                resultsDiv.style.display = 'block';
                return;
            }
        
            tbody.innerHTML = records.map(r => {
                const emp = getEmployeeById(r.employeeId);
                const prod = getProductById(r.productId);
                const status = dayStatus[r.date] || 'Open';
                const quality = qualityStatus.find(q =>
                    q.date === r.date &&
                    q.round === r.round &&
                    q.employeeId === r.employeeId
                );
                const qualityText = quality ? quality.status : '-';
        
                return `
                    <tr>
                        <td>${r.date}</td>
                        <td>Round ${r.round}</td>
                        <td>${emp ? emp.nameThai : 'Unknown'}</td>
                        <td>${prod ? prod.nameThai : 'Unknown'}</td>
                        <td><strong>${r.count}</strong> packs</td>
                        <td>${status === 'Open' ? '<span style="color: #4CAF50;">Open</span>' : '<span style="color: #666;">Closed</span>'}</td>
                        <td>${qualityText}</td>
                    </tr>
                `;
            }).join('');
        
            resultsDiv.style.display = 'block';
        }
        
        // Clear search
        function clearSearch() {
            document.getElementById('searchDateFrom').value = '';
            document.getElementById('searchDateTo').value = '';
            document.getElementById('searchEmployee').value = '';
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchDayStatus').value = '';
            document.getElementById('searchQualityStatus').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }
        
        // ========== END DUMPLING PRODUCTION FEATURE ==========

        // ========== OTHER PRODUCTION FEATURE ==========

        // Other production state
        let otherProductionRecords = [];
        let otherProductionDraft = {};
        let otherProductionDayStatus = {};
        let currentOtherProductionDate = '';
        let otherIsDirty = false;
        let otherReportContext = { selectedYear: null, selectedMonth: null };

        // Load other production data from localStorage
        function loadOtherProductionData() {
            const storedRecords = localStorage.getItem('otherProductionRecords');
            if (storedRecords) {
                otherProductionRecords = JSON.parse(storedRecords);
            }

            const storedDraft = localStorage.getItem('otherProductionDraft');
            if (storedDraft) {
                otherProductionDraft = JSON.parse(storedDraft);
            }

            const storedDayStatus = localStorage.getItem('otherProductionDayStatus');
            if (storedDayStatus) {
                otherProductionDayStatus = JSON.parse(storedDayStatus);
            }
        }

        // Save other production data to localStorage
        function saveOtherProductionRecords() {
            localStorage.setItem('otherProductionRecords', JSON.stringify(otherProductionRecords));
        }

        function saveOtherProductionDraft() {
            localStorage.setItem('otherProductionDraft', JSON.stringify(otherProductionDraft));
        }

        function saveOtherProductionDayStatus() {
            localStorage.setItem('otherProductionDayStatus', JSON.stringify(otherProductionDayStatus));
        }

        // Get eligible products for other production (all except Dept 01)
        function getOtherProductionEligibleProducts() {
            return products.filter(p => p.departmentId !== 1 && p.status === 'Active')
                .sort((a, b) => {
                    // Sort by department first, then by product name
                    if (a.departmentId !== b.departmentId) {
                        return a.departmentId - b.departmentId;
                    }
                    return a.nameThai.localeCompare(b.nameThai);
                });
        }

        // Initialize other production page
        function initOtherProductionPage() {
            loadOtherProductionData();

            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otherProductionDate').value = today;
            currentOtherProductionDate = today;

            // Load the production day
            loadOtherProductionDay();

            // Initialize search dropdowns
            populateOtherSearchDropdowns();

            // Load year view for reports
            loadOtherYearView();
        }

        // Load other production day
        function loadOtherProductionDay() {
            const date = document.getElementById('otherProductionDate').value;
            currentOtherProductionDate = date;

            const entries = buildOtherProductionEntriesForDate(date);

            // Render the table
            renderOtherProductionTable(entries);

            // Update UI status
            updateOtherProductionStatusUI();
        }

        // Normalize draft entries (supports legacy object format)
        function normalizeOtherProductionDraftEntries(draft) {
            if (Array.isArray(draft)) {
                return draft.map(entry => ({
                    ...entry,
                    recordId: entry.recordId || null,
                    isSaved: entry.isSaved || false
                }));
            }
            if (!draft || typeof draft !== 'object') {
                return [];
            }

            return Object.keys(draft).map(productId => {
                const entry = draft[productId] || {};
                return {
                    id: Date.now() + Math.random(),
                    productId: parseInt(productId),
                    batch: entry.batch || '',
                    count: entry.count || 0,
                    quality: entry.quality || 'Pending',
                    notes: entry.notes || '',
                    recordId: entry.recordId || null,
                    isSaved: entry.isSaved || false
                };
            });
        }

        function getOtherProductionDraftEntries(draftKey) {
            const rawDraft = otherProductionDraft[draftKey];
            const entries = normalizeOtherProductionDraftEntries(rawDraft);

            if (!Array.isArray(rawDraft)) {
                if (entries.length > 0) {
                    otherProductionDraft[draftKey] = entries;
                } else {
                    delete otherProductionDraft[draftKey];
                }
                saveOtherProductionDraft();
            }

            return entries;
        }

        function buildOtherProductionEntriesForDate(date) {
            const savedRecords = otherProductionRecords.filter(record => record.date === date);
            const draftEntries = getOtherProductionDraftEntries(date);
            const mergedEntries = [];
            const usedSavedIds = new Set();

            draftEntries.forEach(entry => {
                if (entry.recordId) {
                    const record = savedRecords.find(r => r.id === entry.recordId);
                    if (record) {
                        usedSavedIds.add(record.id);
                        mergedEntries.push({
                            ...entry,
                            productId: record.productId,
                            batch: entry.batch ?? record.batch,
                            count: entry.count ?? record.count,
                            quality: entry.quality || record.quality,
                            notes: entry.notes ?? record.notes,
                            recordId: record.id,
                            isSaved: true
                        });
                        return;
                    }
                }

                const match = savedRecords.find(r => r.productId === entry.productId && r.batch === entry.batch);
                if (match) {
                    usedSavedIds.add(match.id);
                    mergedEntries.push({
                        ...entry,
                        recordId: match.id,
                        isSaved: true
                    });
                } else {
                    mergedEntries.push({
                        ...entry,
                        recordId: entry.recordId || null,
                        isSaved: entry.isSaved || false
                    });
                }
            });

            savedRecords.forEach(record => {
                if (usedSavedIds.has(record.id)) {
                    return;
                }
                mergedEntries.push({
                    id: record.id,
                    recordId: record.id,
                    productId: record.productId,
                    batch: record.batch,
                    count: record.count,
                    quality: record.quality || 'Pending',
                    notes: record.notes || '',
                    isSaved: true
                });
            });

            if (mergedEntries.length > 0) {
                otherProductionDraft[date] = mergedEntries;
                saveOtherProductionDraft();
            }

            return mergedEntries;
        }

        // Render other production table
        function renderOtherProductionTable(draftEntries = []) {
            const tbody = document.getElementById('otherProductionTableBody');
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            const isEditable = dayStatusValue === 'Open' || currentRole === 'admin';

            if (!draftEntries || draftEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px; color: #999;">No products added yet. Use the dropdown above to add products as they are produced.</td></tr>';
                populateOtherProductSelector();
                return;
            }

            const sortedEntries = draftEntries
                .map((entry, index) => {
                    const product = products.find(p => p.id === entry.productId);
                    return { entry, product, index };
                })
                .filter(item => item.product)
                .sort((a, b) => {
                    if (a.product.departmentId !== b.product.departmentId) {
                        return a.product.departmentId - b.product.departmentId;
                    }
                    const nameCompare = a.product.nameThai.localeCompare(b.product.nameThai);
                    if (nameCompare !== 0) {
                        return nameCompare;
                    }
                    return a.index - b.index;
                });

            tbody.innerHTML = sortedEntries.map(({ entry, product }) => {
                const batch = entry.batch || '';
                const count = entry.count || '';
                const quality = entry.quality || 'Pending';
                const notes = entry.notes || '';

                const canDelete = isEditable && (currentRole === 'admin' || !entry.isSaved);
                const savedTag = entry.isSaved ? '<span style="display: inline-block; margin-top: 6px; padding: 2px 6px; background: #E3F2FD; color: #1976D2; border-radius: 10px; font-size: 11px;">Saved</span>' : '';

                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${product.nameThai}</div>
                            <div style="font-size: 12px; color: #666;">${product.nameEn}</div>
                            <div style="font-size: 11px; color: #999;">Dept ${String(product.departmentId).padStart(2, '0')}</div>
                            ${savedTag}
                        </td>
                        <td>${product.unit}</td>
                        <td>
                            <input type="text"
                                   id="other-batch-${entry.id}"
                                   class="form-input"
                                   value="${batch}"
                                   placeholder="Batch #"
                                   onchange="handleOtherProductionChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td>
                            <input type="number"
                                   id="other-count-${entry.id}"
                                   class="form-input"
                                   value="${count}"
                                   min="0"
                                   placeholder="0"
                                   onchange="handleOtherProductionChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td>
                            <div class="quality-toggle-group">
                                <button class="quality-toggle-btn ${quality === 'Pending' ? 'active pending' : ''}"
                                        onclick="setOtherQualityStatus(${entry.id}, 'Pending')"
                                        ${isEditable ? '' : 'disabled'}>
                                    ‚è± Pending
                                </button>
                                <button class="quality-toggle-btn ${quality === 'OK' ? 'active ok' : ''}"
                                        onclick="setOtherQualityStatus(${entry.id}, 'OK')"
                                        ${isEditable ? '' : 'disabled'}>
                                    ‚úì Pass
                                </button>
                                <button class="quality-toggle-btn ${quality === 'Not OK' ? 'active not-ok' : ''}"
                                        onclick="setOtherQualityStatus(${entry.id}, 'Not OK')"
                                        ${isEditable ? '' : 'disabled'}>
                                    ‚úó Not Pass
                                </button>
                            </div>
                        </td>
                        <td>
                            <input type="text"
                                   id="other-notes-${entry.id}"
                                   class="form-input"
                                   value="${notes}"
                                   placeholder="Optional notes"
                                   onchange="handleOtherProductionChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td style="text-align: center;">
                            ${canDelete
                                ? `<button class="btn-icon-danger"
                                           onclick="removeOtherProductFromEntry(${entry.id})"
                                           title="Remove product">
                                       üóëÔ∏è
                                   </button>`
                                : `<span title="${isEditable ? 'Saved entries can only be removed by admins.' : 'Day is closed.'}" style="color: #999;">üîí</span>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');

            // Update the product selector dropdown
            populateOtherProductSelector();
        }

        // Populate product selector dropdown with all eligible products
        function populateOtherProductSelector() {
            const selector = document.getElementById('otherProductSelector');
            const eligibleProducts = getOtherProductionEligibleProducts();
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            const isEditable = dayStatusValue === 'Open' || currentRole === 'admin';

            // Build options
            const options = eligibleProducts.map(product => {
                return `<option value="${product.id}">${product.nameThai} (${product.nameEn})</option>`;
            }).join('');

            selector.innerHTML = '<option value="">-- Select Product to Add --</option>' + options;
            selector.disabled = !isEditable;
        }

        // Add a product to the entry
        function addOtherProductToEntry() {
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can add products.');
                return;
            }
            const selector = document.getElementById('otherProductSelector');
            const productId = parseInt(selector.value);

            if (!productId) {
                alert('Please select a product to add.');
                return;
            }

            // Get current draft for this date
            const draftKey = currentOtherProductionDate;
            const draftEntries = getOtherProductionDraftEntries(draftKey);

            // Add product to draft with default values
            draftEntries.push({
                id: Date.now() + Math.random(),
                productId: productId,
                batch: '',
                count: 0,
                quality: 'Pending',
                notes: '',
                recordId: null,
                isSaved: false
            });

            // Save to localStorage
            otherProductionDraft[draftKey] = draftEntries;
            localStorage.setItem('otherProductionDraft', JSON.stringify(otherProductionDraft));

            // Re-render table
            renderOtherProductionTable(otherProductionDraft[draftKey]);

            // Mark as dirty
            otherIsDirty = true;
            updateOtherProductionStatusUI();

            // Reset selector
            selector.value = '';
        }

        // Remove a product from the entry
        function removeOtherProductFromEntry(entryId) {
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can remove entries.');
                return;
            }
            const draftKey = currentOtherProductionDate;
            const draftEntries = getOtherProductionDraftEntries(draftKey);
            const entry = draftEntries.find(item => item.id === entryId);
            if (!entry) return;

            if (entry.isSaved && currentRole !== 'admin') {
                alert('Saved entries can only be removed by admins.');
                return;
            }

            const product = products.find(p => p.id === entry.productId);
            if (!product) return;

            if (!confirm(`Remove ${product.nameThai} from this entry?`)) {
                return;
            }

            if (entry.isSaved && entry.recordId) {
                otherProductionRecords = otherProductionRecords.filter(record => record.id !== entry.recordId);
                saveOtherProductionRecords();
            }

            const remainingEntries = draftEntries.filter(item => item.id !== entryId);
            if (remainingEntries.length === 0) {
                delete otherProductionDraft[draftKey];
            } else {
                otherProductionDraft[draftKey] = remainingEntries;
            }

            // Save to localStorage
            localStorage.setItem('otherProductionDraft', JSON.stringify(otherProductionDraft));

            // Re-render table
            renderOtherProductionTable(otherProductionDraft[draftKey] || []);

            // Update status UI
            otherIsDirty = true;
            updateOtherProductionStatusUI();
        }

        // Handle other production entry changes
        function handleOtherProductionChange(entryId) {
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can edit entries.');
                return;
            }
            const batchInput = document.getElementById(`other-batch-${entryId}`);
            const countInput = document.getElementById(`other-count-${entryId}`);
            const notesInput = document.getElementById(`other-notes-${entryId}`);

            const batch = batchInput ? batchInput.value.trim() : '';
            const count = parseInt(countInput.value) || 0;
            const notes = notesInput.value.trim();

            // Get current draft for this date
            const draftKey = currentOtherProductionDate;
            const draftEntries = getOtherProductionDraftEntries(draftKey);
            if (!otherProductionDraft[draftKey]) {
                otherProductionDraft[draftKey] = draftEntries;
            }

            const entry = draftEntries.find(item => item.id === entryId);
            if (!entry) {
                return;
            }
            entry.batch = batch;
            entry.count = count;
            entry.notes = notes;
            if (!entry.quality) {
                entry.quality = 'Pending';
            }

            // Save draft
            otherProductionDraft[draftKey] = draftEntries;
            saveOtherProductionDraft();

            // Mark as dirty
            otherIsDirty = true;
            updateOtherProductionStatusUI();
        }

        // Set other production quality status
        function setOtherQualityStatus(entryId, status) {
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can edit entries.');
                return;
            }
            // Get current draft for this date
            const draftKey = currentOtherProductionDate;
            const draftEntries = getOtherProductionDraftEntries(draftKey);
            // Update quality status
            const entry = draftEntries.find(item => item.id === entryId);
            if (!entry) {
                return;
            }
            entry.quality = status;

            // Save draft
            otherProductionDraft[draftKey] = draftEntries;
            saveOtherProductionDraft();

            // Re-render table to update button states
            renderOtherProductionTable(otherProductionDraft[draftKey]);

            // Mark as dirty
            otherIsDirty = true;
            updateOtherProductionStatusUI();
        }

        // Update other production status UI
        function updateOtherProductionStatusUI() {
            const statusBadge = document.getElementById('otherStatusBadge');
            const statusText = document.getElementById('otherStatusText');
            const draftIndicator = document.getElementById('otherDraftIndicator');
            const dayStatusBadge = document.getElementById('otherDayStatusBadge');
            const dayStatusText = document.getElementById('otherDayStatusText');
            const dayActions = document.getElementById('otherDayActions');
            const saveBtn = document.getElementById('saveOtherProductionBtn');
            const selector = document.getElementById('otherProductSelector');
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';

            if (otherIsDirty) {
                statusBadge.className = 'round-status-badge draft';
                statusText.textContent = 'Draft';
                draftIndicator.style.display = 'block';
            } else {
                statusBadge.className = 'round-status-badge saved';
                statusText.textContent = 'Saved';
                draftIndicator.style.display = 'none';
            }

            dayStatusBadge.className = `day-status-badge ${dayStatusValue.toLowerCase()}`;
            dayStatusText.textContent = dayStatusValue;
            dayActions.style.display = currentRole === 'admin' ? 'flex' : 'none';
            saveBtn.disabled = dayStatusValue === 'Closed' && currentRole !== 'admin';
            selector.disabled = dayStatusValue === 'Closed' && currentRole !== 'admin';
        }

        // Save other production
        function saveOtherProduction() {
            const dayStatusValue = otherProductionDayStatus[currentOtherProductionDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can save changes.');
                return;
            }
            const date = document.getElementById('otherProductionDate').value;

            const draftKey = date;
            const draftEntries = getOtherProductionDraftEntries(draftKey);

            // Check if there are any entries
            const hasEntries = draftEntries.some(entry => {
                return entry.count > 0;
            });

            if (!hasEntries) {
                alert('Please enter at least one product quantity before saving.');
                return;
            }

            const missingBatchEntry = draftEntries.find(entry => entry.count > 0 && !entry.batch);

            if (missingBatchEntry) {
                const product = getProductById(missingBatchEntry.productId);
                const productName = product ? product.nameThai : 'selected product';
                alert(`Please enter a batch number for ${productName} before saving.`);
                const batchInput = document.getElementById(`other-batch-${missingBatchEntry.id}`);
                if (batchInput) {
                    batchInput.focus();
                }
                return;
            }

            const zeroedSavedEntry = draftEntries.find(entry => entry.isSaved && entry.count === 0);
            if (zeroedSavedEntry && currentRole !== 'admin') {
                const product = getProductById(zeroedSavedEntry.productId);
                const productName = product ? product.nameThai : 'saved product';
                alert(`"${productName}" is already saved. Set a positive amount or ask an admin to remove it.`);
                return;
            }

            // Create/update production records from draft
            const timestamp = Date.now();
            const recordIndexMap = new Map();
            otherProductionRecords.forEach((record, index) => {
                recordIndexMap.set(record.id, index);
            });

            draftEntries.forEach(entry => {
                if (entry.recordId && recordIndexMap.has(entry.recordId)) {
                    const recordIndex = recordIndexMap.get(entry.recordId);
                    otherProductionRecords[recordIndex] = {
                        ...otherProductionRecords[recordIndex],
                        batch: entry.batch,
                        count: entry.count,
                        quality: entry.quality || 'Pending',
                        notes: entry.notes || '',
                        updatedAt: timestamp
                    };
                    entry.isSaved = true;
                } else if (entry.count > 0) {
                    const newId = timestamp + Math.random();
                    otherProductionRecords.push({
                        id: newId,
                        date: date,
                        batch: entry.batch,
                        productId: entry.productId,
                        count: entry.count,
                        quality: entry.quality || 'Pending',
                        notes: entry.notes || '',
                        createdAt: timestamp,
                        updatedAt: timestamp
                    });
                    entry.recordId = newId;
                    entry.isSaved = true;
                }
            });

            // Save to localStorage
            saveOtherProductionRecords();

            // Save draft for this date (keep entries visible)
            otherProductionDraft[draftKey] = draftEntries;
            saveOtherProductionDraft();

            // Update UI
            otherIsDirty = false;
            updateOtherProductionStatusUI();

            // Show success message
            const lastSavedInfo = document.getElementById('otherLastSavedInfo');
            const lastSavedTime = document.getElementById('otherLastSavedTime');
            lastSavedTime.textContent = new Date().toLocaleTimeString();
            lastSavedInfo.style.display = 'block';

            alert('Production saved successfully!');

            // Re-render table
            renderOtherProductionTable(otherProductionDraft[draftKey]);
        }

        // Handle other production date change
        function handleOtherDateChange() {
            if (otherIsDirty) {
                const confirmChange = confirm('You have unsaved changes. Do you want to discard them and change the date?');
                if (!confirmChange) {
                    // Revert date back
                    document.getElementById('otherProductionDate').value = currentOtherProductionDate;
                    return;
                }
            }

            otherIsDirty = false;
            loadOtherProductionDay();
        }

        function closeOtherProductionDay() {
            if (currentRole !== 'admin') {
                alert('Only admins can close the day.');
                return;
            }
            if (!confirm('Close this production day? Entries will be locked for normal users.')) {
                return;
            }
            otherProductionDayStatus[currentOtherProductionDate] = 'Closed';
            saveOtherProductionDayStatus();
            updateOtherProductionStatusUI();
            renderOtherProductionTable(otherProductionDraft[currentOtherProductionDate] || []);
        }

        function reopenOtherProductionDay() {
            if (currentRole !== 'admin') {
                alert('Only admins can reopen the day.');
                return;
            }
            otherProductionDayStatus[currentOtherProductionDate] = 'Open';
            saveOtherProductionDayStatus();
            updateOtherProductionStatusUI();
            renderOtherProductionTable(otherProductionDraft[currentOtherProductionDate] || []);
        }

        // Switch other production tab
        function switchOtherProductionTab(tab) {
            // Hide all tabs
            document.querySelectorAll('#other-entry-tab, #other-reports-tab, #other-search-tab').forEach(el => {
                el.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`other-${tab}-tab`).classList.add('active');

            // Set active button
            event.target.classList.add('active');

            // Initialize tab-specific content
            if (tab === 'reports') {
                loadOtherYearView();
            } else if (tab === 'search') {
                populateOtherSearchDropdowns();
            }
        }

        // ========== PRODUCT OUTFLOW ==========

        // Product Outflow Data
        let outflowRecords = [];
        let outflowDraft = {};
        let outflowDayStatus = {};
        let currentOutflowDate = '';
        let outflowIsDirty = false;

        // Load outflow records from localStorage
        function loadOutflowRecords() {
            const stored = localStorage.getItem('wontonOutflowRecords');
            if (stored) {
                outflowRecords = JSON.parse(stored);
            }
        }

        // Save outflow records to localStorage
        function saveOutflowRecords() {
            localStorage.setItem('wontonOutflowRecords', JSON.stringify(outflowRecords));
        }

        // Load outflow draft from localStorage
        function loadOutflowDraft() {
            const stored = localStorage.getItem('wontonOutflowDraft');
            if (stored) {
                outflowDraft = JSON.parse(stored);
            }
        }

        // Save outflow draft to localStorage
        function saveOutflowDraft() {
            localStorage.setItem('wontonOutflowDraft', JSON.stringify(outflowDraft));
        }

        // Load outflow day status from localStorage
        function loadOutflowDayStatus() {
            const stored = localStorage.getItem('wontonOutflowDayStatus');
            if (stored) {
                outflowDayStatus = JSON.parse(stored);
            }
        }

        // Save outflow day status to localStorage
        function saveOutflowDayStatus() {
            localStorage.setItem('wontonOutflowDayStatus', JSON.stringify(outflowDayStatus));
        }

        // Get outflow draft entries for a date
        function getOutflowDraftEntries(dateKey) {
            if (!outflowDraft[dateKey]) {
                outflowDraft[dateKey] = [];
            }
            return outflowDraft[dateKey];
        }

        // Initialize outflow page
        function initOutflowPage() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('outflowDate').value = today;
            currentOutflowDate = today;

            // Load outflow data
            loadOutflowDay();
        }

        // Load outflow day
        function loadOutflowDay() {
            const date = document.getElementById('outflowDate').value;
            currentOutflowDate = date;

            // Get draft entries for this date
            const draftKey = date;
            const draftEntries = getOutflowDraftEntries(draftKey);

            // Render table
            renderOutflowTable(draftEntries);

            // Update status UI
            updateOutflowStatusUI();

            // Populate filter dropdowns
            populateOutflowFilterDropdowns();
        }

        // Render outflow table
        function renderOutflowTable(entries = []) {
            const tbody = document.getElementById('outflowTableBody');
            const dayStatusValue = outflowDayStatus[currentOutflowDate] || 'Open';
            const isEditable = dayStatusValue === 'Open' || currentRole === 'admin';

            if (!entries || entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 24px; color: #999;">No outflow entries yet. Click "Add Row" to record outflow.</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map((entry) => {
                const customer = customers.find(c => c.id === entry.customerId);
                const product = products.find(p => p.id === entry.productId);
                const unit = product ? product.unit : '';

                const isValid = validateOutflowEntry(entry);
                const rowClass = !isValid && entry.transactionDate ? 'invalid-row' : '';

                const savedTag = entry.isSaved ? '<span style="display: inline-block; margin-top: 4px; padding: 2px 6px; background: #E3F2FD; color: #1976D2; border-radius: 10px; font-size: 11px;">Saved</span>' : '';

                const canDelete = isEditable && (currentRole === 'admin' || !entry.isSaved);

                return `
                    <tr class="${rowClass}">
                        <td>
                            <input type="date"
                                   id="outflow-date-${entry.id}"
                                   class="form-input ${!entry.transactionDate ? 'required-field' : ''}"
                                   value="${entry.transactionDate || ''}"
                                   onchange="handleOutflowChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td>
                            <div style="position: relative;">
                                <input type="text"
                                       id="outflow-customer-search-${entry.id}"
                                       class="form-input ${!entry.customerId ? 'required-field' : ''}"
                                       placeholder="Search customer..."
                                       onkeyup="filterCustomerDropdown(${entry.id})"
                                       onfocus="showCustomerDropdown(${entry.id})"
                                       onblur="hideCustomerDropdown(${entry.id})"
                                       ${isEditable ? '' : 'disabled'}
                                       value="${customer ? customer.nameThai + ' / ' + customer.nameBurmese : ''}"
                                       style="width: 100%;">
                                <div id="customer-dropdown-${entry.id}" class="dropdown-menu" style="display: none;">
                                    <!-- Customer options will be populated here -->
                                </div>
                                ${savedTag}
                            </div>
                        </td>
                        <td>
                            <input type="text"
                                   id="outflow-seller-${entry.id}"
                                   class="form-input ${!entry.sellerId ? 'required-field' : ''}"
                                   value="${entry.sellerId || ''}"
                                   placeholder="Seller name"
                                   onchange="handleOutflowChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td>
                            <div style="position: relative;">
                                <input type="text"
                                       id="outflow-product-search-${entry.id}"
                                       class="form-input ${!entry.productId ? 'required-field' : ''}"
                                       placeholder="Search product..."
                                       onkeyup="filterProductDropdown(${entry.id})"
                                       onfocus="showProductDropdown(${entry.id})"
                                       onblur="hideProductDropdown(${entry.id})"
                                       ${isEditable ? '' : 'disabled'}
                                       value="${product ? product.nameThai + ' / ' + product.nameEn : ''}"
                                       style="width: 100%;">
                                <div id="product-dropdown-${entry.id}" class="dropdown-menu" style="display: none;">
                                    <!-- Product options will be populated here -->
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type="text"
                                   class="form-input"
                                   value="${unit}"
                                   disabled
                                   style="width: 100%; background: #f5f5f5; color: #666;">
                        </td>
                        <td>
                            <input type="number"
                                   id="outflow-quantity-${entry.id}"
                                   class="form-input ${!entry.quantity || entry.quantity <= 0 ? 'required-field' : ''}"
                                   value="${entry.quantity || ''}"
                                   min="0"
                                   step="0.1"
                                   placeholder="0.0"
                                   onchange="handleOutflowChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td>
                            <input type="text"
                                   id="outflow-note-${entry.id}"
                                   class="form-input"
                                   value="${entry.note || ''}"
                                   placeholder="Optional note"
                                   onchange="handleOutflowChange(${entry.id})"
                                   ${isEditable ? '' : 'disabled'}
                                   style="width: 100%;">
                        </td>
                        <td style="text-align: center;">
                            ${canDelete
                                ? `<button class="btn-icon-danger"
                                           onclick="removeOutflowRow(${entry.id})"
                                           title="Delete row">
                                       üóëÔ∏è
                                   </button>`
                                : `<span title="${isEditable ? 'Saved entries can only be removed by admins.' : 'Day is closed.'}" style="color: #999;">üîí</span>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');

            // Initialize customer and product dropdowns for each row
            entries.forEach(entry => {
                setTimeout(() => {
                    initializeCustomerDropdown(entry.id);
                    initializeProductDropdown(entry.id);
                }, 0);
            });
        }

        // Validate outflow entry
        function validateOutflowEntry(entry) {
            return entry.transactionDate &&
                   entry.customerId &&
                   entry.sellerId &&
                   entry.productId &&
                   entry.quantity &&
                   entry.quantity > 0;
        }

        // Initialize customer dropdown
        function initializeCustomerDropdown(entryId) {
            const dropdown = document.getElementById(`customer-dropdown-${entryId}`);
            if (!dropdown) return;

            const activeCustomers = customers.filter(c => c.status === 'Active');

            dropdown.innerHTML = activeCustomers.map(customer => {
                return `<div class="dropdown-item" onmousedown="selectCustomer(${entryId}, ${customer.id})">
                    <div style="font-weight: 600;">${customer.nameThai}</div>
                    <div style="font-size: 12px; color: #666;">${customer.nameBurmese}</div>
                    <div style="font-size: 11px; color: #999;">${customer.clientType}</div>
                </div>`;
            }).join('');
        }

        // Initialize product dropdown
        function initializeProductDropdown(entryId) {
            const dropdown = document.getElementById(`product-dropdown-${entryId}`);
            if (!dropdown) return;

            const activeProducts = products.filter(p => p.status === 'Active');

            dropdown.innerHTML = activeProducts.map(product => {
                return `<div class="dropdown-item" onmousedown="selectProduct(${entryId}, ${product.id})">
                    <div style="font-weight: 600;">${product.nameThai}</div>
                    <div style="font-size: 12px; color: #666;">${product.nameEn}</div>
                    <div style="font-size: 11px; color: #999;">${product.unit} - Dept ${String(product.departmentId).padStart(2, '0')}</div>
                </div>`;
            }).join('');
        }

        // Show customer dropdown
        function showCustomerDropdown(entryId) {
            const dropdown = document.getElementById(`customer-dropdown-${entryId}`);
            if (dropdown) {
                dropdown.style.display = 'block';
                filterCustomerDropdown(entryId);
            }
        }

        // Hide customer dropdown
        function hideCustomerDropdown(entryId) {
            setTimeout(() => {
                const dropdown = document.getElementById(`customer-dropdown-${entryId}`);
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 200);
        }

        // Filter customer dropdown
        function filterCustomerDropdown(entryId) {
            const searchInput = document.getElementById(`outflow-customer-search-${entryId}`);
            const dropdown = document.getElementById(`customer-dropdown-${entryId}`);

            if (!searchInput || !dropdown) return;

            const searchText = searchInput.value.toLowerCase();
            const activeCustomers = customers.filter(c => c.status === 'Active');

            const filteredCustomers = activeCustomers.filter(customer => {
                return customer.nameThai.toLowerCase().includes(searchText) ||
                       customer.nameBurmese.toLowerCase().includes(searchText) ||
                       customer.clientType.toLowerCase().includes(searchText);
            });

            dropdown.innerHTML = filteredCustomers.map(customer => {
                return `<div class="dropdown-item" onmousedown="selectCustomer(${entryId}, ${customer.id})">
                    <div style="font-weight: 600;">${customer.nameThai}</div>
                    <div style="font-size: 12px; color: #666;">${customer.nameBurmese}</div>
                    <div style="font-size: 11px; color: #999;">${customer.clientType}</div>
                </div>`;
            }).join('');
        }

        // Show product dropdown
        function showProductDropdown(entryId) {
            const dropdown = document.getElementById(`product-dropdown-${entryId}`);
            if (dropdown) {
                dropdown.style.display = 'block';
                filterProductDropdown(entryId);
            }
        }

        // Hide product dropdown
        function hideProductDropdown(entryId) {
            setTimeout(() => {
                const dropdown = document.getElementById(`product-dropdown-${entryId}`);
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 200);
        }

        // Filter product dropdown
        function filterProductDropdown(entryId) {
            const searchInput = document.getElementById(`outflow-product-search-${entryId}`);
            const dropdown = document.getElementById(`product-dropdown-${entryId}`);

            if (!searchInput || !dropdown) return;

            const searchText = searchInput.value.toLowerCase();
            const activeProducts = products.filter(p => p.status === 'Active');

            const filteredProducts = activeProducts.filter(product => {
                return product.nameThai.toLowerCase().includes(searchText) ||
                       product.nameEn.toLowerCase().includes(searchText) ||
                       product.unit.toLowerCase().includes(searchText);
            });

            dropdown.innerHTML = filteredProducts.map(product => {
                return `<div class="dropdown-item" onmousedown="selectProduct(${entryId}, ${product.id})">
                    <div style="font-weight: 600;">${product.nameThai}</div>
                    <div style="font-size: 12px; color: #666;">${product.nameEn}</div>
                    <div style="font-size: 11px; color: #999;">${product.unit} - Dept ${String(product.departmentId).padStart(2, '0')}</div>
                </div>`;
            }).join('');
        }

        // Select customer
        function selectCustomer(entryId, customerId) {
            const draftKey = currentOutflowDate;
            const draftEntries = getOutflowDraftEntries(draftKey);
            const entry = draftEntries.find(e => e.id === entryId);

            if (!entry) return;

            entry.customerId = customerId;

            // Update draft and re-render
            outflowDraft[draftKey] = draftEntries;
            saveOutflowDraft();

            outflowIsDirty = true;
            updateOutflowStatusUI();

            renderOutflowTable(draftEntries);
        }

        // Select product
        function selectProduct(entryId, productId) {
            const draftKey = currentOutflowDate;
            const draftEntries = getOutflowDraftEntries(draftKey);
            const entry = draftEntries.find(e => e.id === entryId);

            if (!entry) return;

            entry.productId = productId;

            // Update draft and re-render
            outflowDraft[draftKey] = draftEntries;
            saveOutflowDraft();

            outflowIsDirty = true;
            updateOutflowStatusUI();

            renderOutflowTable(draftEntries);
        }

        // Handle outflow change
        function handleOutflowChange(entryId) {
            const dayStatusValue = outflowDayStatus[currentOutflowDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can edit entries.');
                return;
            }

            const draftKey = currentOutflowDate;
            const draftEntries = getOutflowDraftEntries(draftKey);
            const entry = draftEntries.find(e => e.id === entryId);

            if (!entry) return;

            // Update entry fields
            const dateInput = document.getElementById(`outflow-date-${entryId}`);
            const sellerInput = document.getElementById(`outflow-seller-${entryId}`);
            const quantityInput = document.getElementById(`outflow-quantity-${entryId}`);
            const noteInput = document.getElementById(`outflow-note-${entryId}`);

            if (dateInput) entry.transactionDate = dateInput.value;
            if (sellerInput) entry.sellerId = sellerInput.value;
            if (quantityInput) entry.quantity = parseFloat(quantityInput.value) || 0;
            if (noteInput) entry.note = noteInput.value;

            // Save to localStorage
            outflowDraft[draftKey] = draftEntries;
            saveOutflowDraft();

            // Mark as dirty
            outflowIsDirty = true;
            updateOutflowStatusUI();
        }

        // Add outflow row
        function addOutflowRow() {
            const dayStatusValue = outflowDayStatus[currentOutflowDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can add rows.');
                return;
            }

            const draftKey = currentOutflowDate;
            const draftEntries = getOutflowDraftEntries(draftKey);

            // Add new entry with default values
            draftEntries.push({
                id: Date.now() + Math.random(),
                transactionDate: currentOutflowDate,
                customerId: null,
                sellerId: '',
                productId: null,
                quantity: 0,
                note: '',
                recordId: null,
                isSaved: false
            });

            // Save to localStorage
            outflowDraft[draftKey] = draftEntries;
            saveOutflowDraft();

            // Re-render table
            renderOutflowTable(draftEntries);

            // Mark as dirty
            outflowIsDirty = true;
            updateOutflowStatusUI();
        }

        // Remove outflow row
        function removeOutflowRow(entryId) {
            const dayStatusValue = outflowDayStatus[currentOutflowDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can remove entries.');
                return;
            }

            const draftKey = currentOutflowDate;
            const draftEntries = getOutflowDraftEntries(draftKey);
            const entry = draftEntries.find(e => e.id === entryId);

            if (!entry) return;

            if (entry.isSaved && currentRole !== 'admin') {
                alert('Saved entries can only be removed by admins.');
                return;
            }

            if (!confirm('Remove this outflow entry?')) {
                return;
            }

            // Remove entry
            const index = draftEntries.findIndex(e => e.id === entryId);
            if (index !== -1) {
                draftEntries.splice(index, 1);
            }

            // If entry was saved, also remove from outflowRecords
            if (entry.recordId) {
                const recordIndex = outflowRecords.findIndex(r => r.id === entry.recordId);
                if (recordIndex !== -1) {
                    outflowRecords.splice(recordIndex, 1);
                    saveOutflowRecords();
                }
            }

            // Save to localStorage
            outflowDraft[draftKey] = draftEntries;
            saveOutflowDraft();

            // Re-render table
            renderOutflowTable(draftEntries);

            // Mark as dirty
            outflowIsDirty = true;
            updateOutflowStatusUI();
        }

        // Save outflow
        function saveOutflow() {
            const dayStatusValue = outflowDayStatus[currentOutflowDate] || 'Open';
            if (dayStatusValue === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can save changes.');
                return;
            }

            const draftKey = currentOutflowDate;
            const draftEntries = getOutflowDraftEntries(draftKey);

            // Validate entries
            const invalidEntries = draftEntries.filter(entry => !validateOutflowEntry(entry));

            if (draftEntries.length === 0) {
                alert('Please add at least one outflow entry before saving.');
                return;
            }

            if (invalidEntries.length > 0) {
                alert('Please fill in all required fields (Date, Customer, Seller, Product, and Quantity > 0) before saving.');
                return;
            }

            // Create/update outflow records from draft
            const timestamp = Date.now();
            const recordIndexMap = new Map();
            outflowRecords.forEach((record, index) => {
                recordIndexMap.set(record.id, index);
            });

            draftEntries.forEach(entry => {
                if (entry.recordId && recordIndexMap.has(entry.recordId)) {
                    // Update existing record
                    const recordIndex = recordIndexMap.get(entry.recordId);
                    outflowRecords[recordIndex] = {
                        ...outflowRecords[recordIndex],
                        transactionDate: entry.transactionDate,
                        customerId: entry.customerId,
                        sellerId: entry.sellerId,
                        productId: entry.productId,
                        quantity: entry.quantity,
                        note: entry.note || '',
                        updatedAt: timestamp
                    };
                    entry.isSaved = true;
                } else {
                    // Create new record
                    const newId = timestamp + Math.random();
                    outflowRecords.push({
                        id: newId,
                        transactionDate: entry.transactionDate,
                        customerId: entry.customerId,
                        sellerId: entry.sellerId,
                        productId: entry.productId,
                        quantity: entry.quantity,
                        note: entry.note || '',
                        createdAt: timestamp,
                        updatedAt: timestamp
                    });
                    entry.recordId = newId;
                    entry.isSaved = true;
                }
            });

            // Save to localStorage
            saveOutflowRecords();

            // Save draft for this date (keep entries visible)
            outflowDraft[draftKey] = draftEntries;
            saveOutflowDraft();

            // Update UI
            outflowIsDirty = false;
            updateOutflowStatusUI();

            // Show success message
            const lastSavedInfo = document.getElementById('outflowLastSavedInfo');
            const lastSavedTime = document.getElementById('outflowLastSavedTime');
            lastSavedTime.textContent = new Date().toLocaleTimeString();
            lastSavedInfo.style.display = 'block';

            alert('Outflow saved successfully!');

            // Re-render table
            renderOutflowTable(draftEntries);
        }

        // Update outflow status UI
        function updateOutflowStatusUI() {
            const dayStatusValue = outflowDayStatus[currentOutflowDate] || 'Open';
            const statusBadge = document.getElementById('outflowDayStatusBadge');
            const closeBtn = document.getElementById('closeOutflowDayBtn');
            const reopenBtn = document.getElementById('reopenOutflowDayBtn');
            const draftIndicator = document.getElementById('outflowDraftIndicator');
            const saveBtn = document.getElementById('saveOutflowBtn');
            const addRowBtn = document.getElementById('addOutflowRowBtn');

            // Update status badge
            if (statusBadge) {
                if (dayStatusValue === 'Closed') {
                    statusBadge.className = 'status-badge badge-closed';
                    statusBadge.textContent = 'Closed';
                } else {
                    statusBadge.className = 'status-badge badge-open';
                    statusBadge.textContent = 'Open';
                }
            }

            // Show/hide buttons based on role and status
            if (currentRole === 'admin') {
                if (closeBtn) closeBtn.style.display = dayStatusValue === 'Open' ? 'block' : 'none';
                if (reopenBtn) reopenBtn.style.display = dayStatusValue === 'Closed' ? 'block' : 'none';
            } else {
                if (closeBtn) closeBtn.style.display = 'none';
                if (reopenBtn) reopenBtn.style.display = 'none';
            }

            // Show/hide draft indicator
            if (draftIndicator) {
                draftIndicator.style.display = outflowIsDirty ? 'block' : 'none';
            }

            // Enable/disable save button
            const isEditable = dayStatusValue === 'Open' || currentRole === 'admin';
            if (saveBtn) saveBtn.disabled = !isEditable;
            if (addRowBtn) addRowBtn.disabled = !isEditable;
        }

        // Handle outflow date change
        function handleOutflowDateChange() {
            if (outflowIsDirty) {
                const confirmChange = confirm('You have unsaved changes. Do you want to discard them and change the date?');
                if (!confirmChange) {
                    // Revert date back
                    document.getElementById('outflowDate').value = currentOutflowDate;
                    return;
                }
            }

            outflowIsDirty = false;
            loadOutflowDay();
        }

        // Close outflow day
        function closeOutflowDay() {
            if (currentRole !== 'admin') {
                alert('Only admins can close the day.');
                return;
            }
            if (!confirm('Close this outflow day? Entries will be locked for normal users.')) {
                return;
            }
            outflowDayStatus[currentOutflowDate] = 'Closed';
            saveOutflowDayStatus();
            updateOutflowStatusUI();
            renderOutflowTable(outflowDraft[currentOutflowDate] || []);
        }

        // Reopen outflow day
        function reopenOutflowDay() {
            if (currentRole !== 'admin') {
                alert('Only admins can reopen the day.');
                return;
            }
            outflowDayStatus[currentOutflowDate] = 'Open';
            saveOutflowDayStatus();
            updateOutflowStatusUI();
            renderOutflowTable(outflowDraft[currentOutflowDate] || []);
        }

        // Populate outflow filter dropdowns
        function populateOutflowFilterDropdowns() {
            const customerFilter = document.getElementById('outflowFilterCustomer');
            const productFilter = document.getElementById('outflowFilterProduct');

            if (customerFilter) {
                const activeCustomers = customers.filter(c => c.status === 'Active');
                customerFilter.innerHTML = '<option value="">All Customers</option>' +
                    activeCustomers.map(c => `<option value="${c.id}">${c.nameThai} / ${c.nameBurmese}</option>`).join('');
            }

            if (productFilter) {
                const activeProducts = products.filter(p => p.status === 'Active');
                productFilter.innerHTML = '<option value="">All Products</option>' +
                    activeProducts.map(p => `<option value="${p.id}">${p.nameThai} / ${p.nameEn}</option>`).join('');
            }
        }

        // Apply outflow filters
        function applyOutflowFilters() {
            const dateFrom = document.getElementById('outflowFilterDateFrom').value;
            const dateTo = document.getElementById('outflowFilterDateTo').value;
            const customerFilter = document.getElementById('outflowFilterCustomer').value;
            const productFilter = document.getElementById('outflowFilterProduct').value;
            const sellerFilter = document.getElementById('outflowFilterSeller').value.toLowerCase();

            const draftKey = currentOutflowDate;
            let entries = getOutflowDraftEntries(draftKey);

            // Apply filters
            if (dateFrom) {
                entries = entries.filter(e => e.transactionDate >= dateFrom);
            }
            if (dateTo) {
                entries = entries.filter(e => e.transactionDate <= dateTo);
            }
            if (customerFilter) {
                entries = entries.filter(e => e.customerId === parseInt(customerFilter));
            }
            if (productFilter) {
                entries = entries.filter(e => e.productId === parseInt(productFilter));
            }
            if (sellerFilter) {
                entries = entries.filter(e => e.sellerId && e.sellerId.toLowerCase().includes(sellerFilter));
            }

            renderOutflowTable(entries);
        }

        // Clear outflow filters
        function clearOutflowFilters() {
            document.getElementById('outflowFilterDateFrom').value = '';
            document.getElementById('outflowFilterDateTo').value = '';
            document.getElementById('outflowFilterCustomer').value = '';
            document.getElementById('outflowFilterProduct').value = '';
            document.getElementById('outflowFilterSeller').value = '';

            const draftKey = currentOutflowDate;
            renderOutflowTable(getOutflowDraftEntries(draftKey));
        }

        // ========== OTHER PRODUCTION REPORTS ==========

        // Show other report view
        function showOtherReportView(view) {
            // Hide all views
            document.querySelectorAll('#other-year-view, #other-month-view, #other-day-view').forEach(el => {
                el.style.display = 'none';
            });

            // Remove active class from nav chips
            document.querySelectorAll('#otherDashboardNav .nav-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            // Show selected view
            document.getElementById(`other-${view}-view`).style.display = 'block';

            // Set active nav chip
            event.target.classList.add('active');

            // Load data for view
            if (view === 'year') {
                loadOtherYearView();
            }
        }

        // Load other year view
        function loadOtherYearView() {
            const yearData = {};

            otherProductionRecords.forEach(record => {
                const year = record.date.substring(0, 4);
                if (!yearData[year]) {
                    yearData[year] = {
                        products: {},
                        dates: new Set()
                    };
                }

                const product = getProductById(record.productId);
                const productKey = product ? product.nameThai : 'Unknown';
                if (!yearData[year].products[productKey]) {
                    yearData[year].products[productKey] = { count: 0, unit: product?.unit || '' };
                }
                yearData[year].products[productKey].count += record.count;
                yearData[year].dates.add(record.date);
            });

            const tbody = document.getElementById('otherYearViewBody');
            const years = Object.keys(yearData).sort().reverse();

            if (years.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #999;">No production records found</td></tr>';
                return;
            }

            tbody.innerHTML = years.map(year => {
                const data = yearData[year];
                const productBreakdown = Object.entries(data.products)
                    .sort((a, b) => b[1].count - a[1].count)
                    .map(([name, info]) => `${name}: ${info.count} ${info.unit}`.trim())
                    .join('<br>');

                return `
                    <tr>
                        <td><strong>${year}</strong></td>
                        <td>${productBreakdown}</td>
                        <td>${data.dates.size} days</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="loadOtherMonthView('${year}')">View Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load other month view
        function loadOtherMonthView(year) {
            otherReportContext.selectedYear = year;
            document.getElementById('otherSelectedYear').textContent = year;

            const monthData = {};
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            otherProductionRecords
                .filter(r => r.date.startsWith(year))
                .forEach(record => {
                    const month = record.date.substring(5, 7);
                    if (!monthData[month]) {
                        monthData[month] = {
                            products: {},
                            dates: new Set()
                        };
                    }

                    const product = getProductById(record.productId);
                    const productKey = product ? product.nameThai : 'Unknown';
                    if (!monthData[month].products[productKey]) {
                        monthData[month].products[productKey] = { count: 0, unit: product?.unit || '' };
                    }
                    monthData[month].products[productKey].count += record.count;
                    monthData[month].dates.add(record.date);
                });

            const tbody = document.getElementById('otherMonthViewBody');
            const months = Object.keys(monthData).sort();

            if (months.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #999;">No production records found for this year</td></tr>';
                showOtherReportView('month');
                return;
            }

            tbody.innerHTML = months.map(month => {
                const data = monthData[month];
                const monthName = monthNames[parseInt(month) - 1];
                const productBreakdown = Object.entries(data.products)
                    .sort((a, b) => b[1].count - a[1].count)
                    .map(([name, info]) => `${name}: ${info.count} ${info.unit}`.trim())
                    .join('<br>');

                return `
                    <tr>
                        <td><strong>${monthName} ${year}</strong></td>
                        <td>${productBreakdown}</td>
                        <td>${data.dates.size} days</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="loadOtherDayView('${year}', '${month}')">View Details</button>
                        </td>
                    </tr>
                `;
            }).join('');

            showOtherReportView('month');
        }

        // Load other day view
        function loadOtherDayView(year, month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            otherReportContext.selectedMonth = `${monthNames[parseInt(month) - 1]} ${year}`;
            document.getElementById('otherSelectedMonth').textContent = otherReportContext.selectedMonth;

            const dayData = {};

            otherProductionRecords
                .filter(r => r.date.startsWith(`${year}-${month}`))
                .forEach(record => {
                    const key = `${record.date}_${record.productId}`;
                    if (!dayData[key]) {
                        const product = getProductById(record.productId);
                        dayData[key] = {
                            date: record.date,
                            productId: record.productId,
                            productName: product ? product.nameThai : 'Unknown',
                            productUnit: product?.unit || '',
                            batches: {},
                            qualityStatuses: new Set()
                        };
                    }

                    const batchKey = record.batch || 'Unassigned';
                    dayData[key].batches[batchKey] = (dayData[key].batches[batchKey] || 0) + record.count;
                    dayData[key].qualityStatuses.add(record.quality);
                });

            const tbody = document.getElementById('otherDayViewBody');
            const entries = Object.values(dayData).sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return a.productName.localeCompare(b.productName);
            });

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px; color: #999;">No production records found for this month</td></tr>';
                showOtherReportView('day');
                return;
            }

            tbody.innerHTML = entries.map(data => {
                const batchBreakdown = Object.entries(data.batches)
                    .map(([batch, count]) => `<div><strong>${batch}</strong>: ${count} ${data.productUnit}`.trim() + '</div>')
                    .join('');

                const qualityBadges = Array.from(data.qualityStatuses)
                    .map(q => {
                        const color = q === 'OK' ? '#4CAF50' : q === 'Not OK' ? '#f44336' : '#FF9800';
                        return `<span style="padding: 2px 8px; background: ${color}; color: white; border-radius: 4px; font-size: 11px; margin-right: 4px;">${q}</span>`;
                    })
                    .join('');

                return `
                    <tr>
                        <td>${data.date}</td>
                        <td><strong>${data.productName}</strong></td>
                        <td>${batchBreakdown}</td>
                        <td>${qualityBadges}</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="viewOtherDayDetail('${data.date}', '${data.productId}')">View Detail</button>
                        </td>
                    </tr>
                `;
            }).join('');

            showOtherReportView('day');
        }

        // View other day detail
        function viewOtherDayDetail(date, productId) {
            const records = otherProductionRecords.filter(r => r.date === date && r.productId === parseInt(productId));

            if (records.length === 0) {
                alert('No records found for this date and product.');
                return;
            }

            const product = getProductById(parseInt(productId));
            const productName = product ? `${product.nameThai} (${product.nameEn})` : 'Unknown';
            let detail = `Production Detail for ${date} - ${productName}\n\n`;

            const batchSummary = {};
            records.forEach(record => {
                const batchKey = record.batch || 'Unassigned';
                if (!batchSummary[batchKey]) {
                    batchSummary[batchKey] = { count: 0, quality: new Set(), notes: [] };
                }
                batchSummary[batchKey].count += record.count;
                batchSummary[batchKey].quality.add(record.quality);
                if (record.notes) {
                    batchSummary[batchKey].notes.push(record.notes);
                }
            });

            Object.entries(batchSummary).forEach(([batch, info]) => {
                detail += `Batch ${batch}: ${info.count} ${product?.unit || ''}\n`;
                detail += `Quality: ${Array.from(info.quality).join(', ')}\n`;
                if (info.notes.length) {
                    detail += `Notes: ${info.notes.join(' | ')}\n`;
                }
                detail += '\n';
            });

            alert(detail);
        }

        // ========== OTHER PRODUCTION SEARCH ==========

        // Populate other search dropdowns
        function populateOtherSearchDropdowns() {
            const productSelect = document.getElementById('otherSearchProduct');
            const eligibleProducts = getOtherProductionEligibleProducts();

            productSelect.innerHTML = '<option value="">All Products</option>' +
                eligibleProducts.map(p => `<option value="${p.id}">${p.nameThai} (${p.nameEn})</option>`).join('');
        }

        // Perform other production search
        function performOtherSearch() {
            const dateFrom = document.getElementById('otherSearchDateFrom').value;
            const dateTo = document.getElementById('otherSearchDateTo').value;
            const productId = document.getElementById('otherSearchProduct').value;
            const qualityStatus = document.getElementById('otherSearchQualityStatus').value;

            let results = otherProductionRecords;

            // Filter by date range
            if (dateFrom) {
                results = results.filter(r => r.date >= dateFrom);
            }
            if (dateTo) {
                results = results.filter(r => r.date <= dateTo);
            }

            // Filter by product
            if (productId) {
                results = results.filter(r => r.productId === parseInt(productId));
            }

            // Filter by quality status
            if (qualityStatus) {
                results = results.filter(r => r.quality === qualityStatus);
            }

            // Sort by date descending
            results.sort((a, b) => b.date.localeCompare(a.date));

            // Display results
            const tbody = document.getElementById('otherSearchResultsBody');
            const resultsDiv = document.getElementById('otherSearchResults');

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: #999;">No records found</td></tr>';
            } else {
                tbody.innerHTML = results.map(record => {
                    const product = getProductById(record.productId);
                    const productName = product ? `${product.nameThai} (${product.nameEn})` : 'Unknown';
                    const qualityColor = record.quality === 'OK' ? '#4CAF50' : record.quality === 'Not OK' ? '#f44336' : '#FF9800';

                    return `
                        <tr>
                            <td>${record.date}</td>
                            <td>${record.batch}</td>
                            <td>${productName}</td>
                            <td>${record.count} ${product?.unit || ''}</td>
                            <td><span style="padding: 4px 12px; background: ${qualityColor}; color: white; border-radius: 4px; font-size: 12px;">${record.quality}</span></td>
                            <td>${record.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }

            resultsDiv.style.display = 'block';
        }

        // Clear other production search
        function clearOtherSearch() {
            document.getElementById('otherSearchDateFrom').value = '';
            document.getElementById('otherSearchDateTo').value = '';
            document.getElementById('otherSearchProduct').value = '';
            document.getElementById('otherSearchQualityStatus').value = '';
            document.getElementById('otherSearchResults').style.display = 'none';
        }

        // ========== END OTHER PRODUCTION FEATURE ==========

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadDepartments();
            loadEmployees();
            loadCustomers();
            loadOutflowRecords();
            loadOutflowDraft();
            loadOutflowDayStatus();
            init();
        });
    </script>
</body>
</html>
