<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wonton Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: #fff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-section {
            padding: 24px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #D84315;
        }

        .role-switcher {
            margin-top: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .role-switcher label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .role-switcher select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-menu {
            padding: 16px 0;
        }

        .menu-item {
            margin-bottom: 4px;
        }

        .menu-item-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item-main:hover {
            background: #f5f5f5;
        }

        .menu-item-main.active {
            background: #FF7043;
            color: white;
        }

        .menu-item-main.active-admin {
            background: #1976D2;
            color: white;
        }

        .menu-item-main.user-access {
            border-left: 3px solid #FF7043;
        }

        .menu-item-main.admin-access {
            border-left: 3px solid #1976D2;
        }

        .menu-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submenu-toggle {
            transition: transform 0.2s;
        }

        .submenu-toggle.expanded {
            transform: rotate(180deg);
        }

        .submenu {
            display: none;
            padding-left: 20px;
            background: #fafafa;
        }

        .submenu.show {
            display: block;
        }

        .submenu-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #666;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submenu-item:hover {
            background: #f0f0f0;
            color: #333;
        }

        .submenu-item.active {
            color: #D84315;
            background: #fff;
            font-weight: 500;
        }

        .submenu-item::before {
            content: '‚ñ™';
            margin-right: 12px;
            color: #999;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 24px;
        }

        .header {
            background: white;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .breadcrumb {
            font-size: 14px;
            color: #666;
        }

        .content-card {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .access-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .access-badge.user {
            background: #FFE0B2;
            color: #E65100;
        }

        .access-badge.admin {
            background: #BBDEFB;
            color: #0D47A1;
        }

        .info-message {
            background: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding: 16px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .info-message h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1565C0;
        }

        .info-message p {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        /* Color coding reference */
        .color-reference {
            display: flex;
            gap: 24px;
            margin-top: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .color-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .color-box.orange {
            background: #FF7043;
        }

        .color-box.blue {
            background: #1976D2;
        }

        /* Product Management Styles */
        .product-section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-edit {
            background: #FF9800;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-edit:hover {
            background: #F57C00;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .product-form {
            background: #f9f9f9;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
        }

        .product-form.show {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #f44336;
            margin-left: 4px;
        }

        .form-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976D2;
        }

        .form-input:disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .form-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #1976D2;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .product-table thead {
            background: #f5f5f5;
        }

        .product-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-table td {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .product-table tr:hover {
            background: #fafafa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-inactive {
            background: #FFEBEE;
            color: #C62828;
        }

        .status-on-leave {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .status-resigned {
            background: #F5F5F5;
            color: #616161;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            color: #666;
        }

        /* Production Record Styles */
        .production-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .date-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .round-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .round-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .round-btn:hover {
            border-color: #1976D2;
            background: #E3F2FD;
        }

        .round-btn.active {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .round-btn.new-round {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .round-btn.new-round:hover {
            background: #45a049;
        }

        .day-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .day-status-badge.open {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .day-status-badge.closed {
            background: #FFEBEE;
            color: #C62828;
        }

        .btn-close-day {
            background: #F44336;
            color: white;
        }

        .btn-close-day:hover {
            background: #D32F2F;
        }

        .btn-reopen-day {
            background: #FF9800;
            color: white;
        }

        .btn-reopen-day:hover {
            background: #F57C00;
        }

        .entry-grid {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .entry-grid-header {
            display: grid;
            grid-template-columns: 80px 200px 200px 120px 200px 80px;
            gap: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }

        .entry-row {
            display: grid;
            grid-template-columns: 80px 200px 200px 120px 200px 80px;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .entry-row:hover {
            background: #fafafa;
        }

        .entry-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .entry-input:focus {
            outline: none;
            border-color: #1976D2;
        }

        .entry-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid;
        }

        .summary-card.total {
            border-left-color: #1976D2;
        }

        .summary-card.employee {
            border-left-color: #4CAF50;
        }

        .summary-card.product {
            border-left-color: #FF9800;
        }

        .summary-card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .summary-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .quality-status-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .quality-row {
            display: grid;
            grid-template-columns: 150px 150px 150px 150px 1fr;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .quality-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .quality-ok {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .quality-not-ok {
            background: #FFEBEE;
            color: #C62828;
        }

        .quality-pending {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .dashboard-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-chip {
            padding: 8px 16px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .nav-chip:hover {
            border-color: #1976D2;
            background: #E3F2FD;
        }

        .nav-chip.active {
            background: #1976D2;
            color: white;
            border-color: #1976D2;
        }

        .report-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .report-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th {
            background: #f5f5f5;
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .report-table td {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .report-table tr:hover {
            background: #fafafa;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #E3F2FD !important;
        }

        .search-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-note {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .modal-body {
            margin-bottom: 24px;
            color: #666;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .tab-container {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1976D2;
        }

        .tab-btn.active {
            color: #1976D2;
            border-bottom-color: #1976D2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .container {
                flex-direction: column;
            }

            .product-table {
                font-size: 12px;
            }

            .product-table th,
            .product-table td {
                padding: 12px 8px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .entry-grid-header,
            .entry-row {
                grid-template-columns: 1fr;
                font-size: 12px;
            }

            .production-controls {
                flex-direction: column;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo-section">
                <div class="logo">ü•ü Wonton</div>
                <div class="role-switcher">
                    <label for="roleSelect">Current Role:</label>
                    <select id="roleSelect" onchange="handleRoleChange()">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="nav-menu" id="navMenu">
                <!-- Menu items will be rendered here by JavaScript -->
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="header">
                <h1 id="pageTitle">Home</h1>
                <div class="breadcrumb" id="breadcrumb">Dashboard / Home</div>
            </div>
            <div class="content-card" id="mainContent">
                <h2>Welcome to Wonton Management System</h2>
                <div class="color-reference">
                    <div class="color-item">
                        <div class="color-box orange"></div>
                        <span>User Access</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box blue"></div>
                        <span>Admin Only</span>
                    </div>
                </div>
                <div class="info-message">
                    <h3>Role-Based Access Control</h3>
                    <p>
                        This system implements role-based menu access. Users with 'User' role can access Home, Product Inflow, and Product Outflow menus (highlighted in orange).
                        Admins have full access to all menus including Dashboard, Inventory, Sale, Wage, and SETUP (highlighted in blue).
                    </p>
                    <p style="margin-top: 12px;">
                        Use the role switcher in the sidebar to toggle between User and Admin views to see the difference in menu accessibility.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Menu configuration with role-based access
        const menuConfig = [
            {
                id: 'home',
                label: 'Home',
                icon: 'üè†',
                roles: ['user', 'admin'],
                colorClass: 'user-access'
            },
            {
                id: 'dashboard',
                label: 'Dashboard',
                icon: 'üìä',
                roles: ['admin'],
                colorClass: 'admin-access'
            },
            {
                id: 'product-inflow',
                label: 'Product inflow',
                icon: 'üì•',
                roles: ['user', 'admin'],
                colorClass: 'user-access',
                submenu: [
                    { id: 'dumpling-production', label: 'Dumpling production' },
                    { id: 'other-production', label: 'Other production' }
                ]
            },
            {
                id: 'product-outflow',
                label: 'Product outflow',
                icon: 'üì§',
                roles: ['user', 'admin'],
                colorClass: 'user-access'
            },
            {
                id: 'inventory',
                label: 'Inventory',
                icon: 'üì¶',
                roles: ['admin'],
                colorClass: 'admin-access',
                submenu: [
                    { id: 'inflow', label: 'Inflow' },
                    { id: 'outflow', label: 'Outflow' },
                    { id: 'net-change', label: 'Net change' }
                ]
            },
            {
                id: 'sale',
                label: 'Sale',
                icon: 'üí∞',
                roles: ['admin'],
                colorClass: 'admin-access'
            },
            {
                id: 'wage',
                label: 'Wage',
                icon: 'üíµ',
                roles: ['admin'],
                colorClass: 'admin-access'
            },
            {
                id: 'setup',
                label: 'SETUP',
                icon: '‚öôÔ∏è',
                roles: ['admin'],
                colorClass: 'admin-access'
            }
        ];

        // Page content configuration
        const pageContent = {
            'home': {
                title: 'Home',
                breadcrumb: 'Dashboard / Home',
                content: `
                    <h2>Welcome to Wonton Management System</h2>
                    <p style="margin-top: 16px; color: #666; line-height: 1.6;">
                        This is your central hub for managing all aspects of the wonton business.
                        Navigate through the menu to access different modules based on your role.
                    </p>
                `
            },
            'dashboard': {
                title: 'Dashboard',
                breadcrumb: 'Dashboard',
                content: `
                    <h2>Admin Dashboard</h2>
                    <p style="margin-top: 16px; color: #666;">
                        View overall business metrics, sales analytics, and key performance indicators.
                    </p>
                    <div style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666;">Total Sales</div>
                            <div style="font-size: 28px; font-weight: 700; color: #D84315; margin-top: 8px;">$12,847</div>
                        </div>
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666;">Orders Today</div>
                            <div style="font-size: 28px; font-weight: 700; color: #1976D2; margin-top: 8px;">247</div>
                        </div>
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666;">Inventory Items</div>
                            <div style="font-size: 28px; font-weight: 700; color: #388E3C; margin-top: 8px;">1,432</div>
                        </div>
                    </div>
                `
            },
            'product-inflow': {
                title: 'Product Inflow',
                breadcrumb: 'Product Management / Product Inflow',
                content: `
                    <h2>Product Inflow Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Track and manage incoming products from production facilities.
                    </p>
                `
            },
            'dumpling-production': {
                title: 'Dumpling Production Record',
                breadcrumb: 'Product Management / Product Inflow / Dumpling Production',
                content: `
                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchProductionTab('entry')">Entry</button>
                        <button class="tab-btn" onclick="switchProductionTab('reports')">Reports</button>
                        <button class="tab-btn" onclick="switchProductionTab('search')">Search</button>
                    </div>

                    <!-- Entry Tab -->
                    <div id="entry-tab" class="tab-content active">
                        <!-- Production Controls -->
                        <div class="production-controls">
                            <div class="control-group">
                                <label class="control-label">Select Date</label>
                                <input type="date" id="productionDate" class="date-input" onchange="loadProductionDay()">
                            </div>
                            <div class="control-group">
                                <label class="control-label">Day Status</label>
                                <div>
                                    <span id="dayStatusBadge" class="day-status-badge open">
                                        <span>‚óè</span> Open
                                    </span>
                                </div>
                            </div>
                            <div class="control-group">
                                <button class="btn btn-success" onclick="saveAllEntries()">
                                    üíæ Save All
                                </button>
                                <button id="closeDayBtn" class="btn btn-close-day" onclick="closeDayModal()" style="margin-top: 8px;">
                                    üîí Close Day
                                </button>
                                <button id="reopenDayBtn" class="btn btn-reopen-day" onclick="reopenDay()" style="margin-top: 8px; display: none;">
                                    üîì Reopen Day (Admin)
                                </button>
                            </div>
                        </div>

                        <!-- Info Note -->
                        <div class="info-note">
                            ‚ÑπÔ∏è <strong>Note:</strong> Empty counts = zero production or not recorded. Only Dept 01 Active employees and products are shown.
                        </div>

                        <!-- Round Selector -->
                        <div style="margin-bottom: 24px;">
                            <div class="control-label">Select Round</div>
                            <div class="round-selector" id="roundSelector">
                                <!-- Rounds will be rendered here -->
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="summary-cards">
                            <div class="summary-card total">
                                <div class="summary-card-title">Total Packs (Current Round)</div>
                                <div class="summary-card-value" id="totalPacksRound">0</div>
                            </div>
                            <div class="summary-card total">
                                <div class="summary-card-title">Total Packs (Today)</div>
                                <div class="summary-card-value" id="totalPacksDay">0</div>
                            </div>
                            <div class="summary-card employee">
                                <div class="summary-card-title">Active Employees</div>
                                <div class="summary-card-value" id="activeEmployees">0</div>
                            </div>
                            <div class="summary-card product">
                                <div class="summary-card-title">Active Products</div>
                                <div class="summary-card-value" id="activeProducts">0</div>
                            </div>
                        </div>

                        <!-- Entry Grid -->
                        <div class="entry-grid">
                            <h3 style="margin-bottom: 16px;">Production Entry</h3>
                            <div class="entry-grid-header">
                                <div>Row</div>
                                <div>Employee</div>
                                <div>Product</div>
                                <div>Count</div>
                                <div>Notes</div>
                                <div>Action</div>
                            </div>
                            <div id="entryGridBody">
                                <!-- Entry rows will be rendered here -->
                            </div>
                        </div>

                        <!-- Quality Check Section -->
                        <div class="quality-status-section">
                            <h3 style="margin-bottom: 16px;">Quality Check Status (Today)</h3>
                            <div class="info-note">
                                Mark quality status for each employee-product combination. This is for the entire day, not per round.
                            </div>
                            <div id="qualityCheckList">
                                <!-- Quality checks will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="reports-tab" class="tab-content">
                        <!-- Dashboard Navigation -->
                        <div class="dashboard-nav" id="dashboardNav">
                            <div class="nav-chip active" onclick="showReportView('year')">üìÖ Year View</div>
                            <div class="nav-chip" onclick="showReportView('month')">üìÜ Month View</div>
                            <div class="nav-chip" onclick="showReportView('day')">üìã Day View</div>
                        </div>

                        <!-- Year View -->
                        <div id="year-view" class="report-view" style="display: block;">
                            <h3 style="margin-bottom: 16px;">Yearly Summary</h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Year</th>
                                            <th>Total Packs</th>
                                            <th>Days Recorded</th>
                                            <th>Employees</th>
                                            <th>Products</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="yearViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Month View -->
                        <div id="month-view" class="report-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-small" onclick="showReportView('year')">‚Üê Back to Year View</button>
                            </div>
                            <h3 style="margin-bottom: 16px;">Monthly Summary - <span id="selectedYear"></span></h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Total Packs</th>
                                            <th>Days Recorded</th>
                                            <th>Avg per Day</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monthViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Day View -->
                        <div id="day-view" class="report-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary btn-small" onclick="showReportView('month')">‚Üê Back to Month View</button>
                            </div>
                            <h3 style="margin-bottom: 16px;">Daily Summary - <span id="selectedMonth"></span></h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Total Packs</th>
                                            <th>Rounds</th>
                                            <th>Entries</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dayViewBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Search Tab -->
                    <div id="search-tab" class="tab-content">
                        <div class="search-section">
                            <h3 style="margin-bottom: 16px;">Search Production Records</h3>
                            <div class="search-grid">
                                <div class="form-group">
                                    <label class="form-label">Date From</label>
                                    <input type="date" id="searchDateFrom" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date To</label>
                                    <input type="date" id="searchDateTo" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Employee</label>
                                    <select id="searchEmployee" class="form-select">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product</label>
                                    <select id="searchProduct" class="form-select">
                                        <option value="">All Products</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Day Status</label>
                                    <select id="searchDayStatus" class="form-select">
                                        <option value="">All</option>
                                        <option value="Open">Open</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quality Status</label>
                                    <select id="searchQualityStatus" class="form-select">
                                        <option value="">All</option>
                                        <option value="OK">OK</option>
                                        <option value="Not OK">Not OK</option>
                                        <option value="Pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" onclick="performSearch()">üîç Search</button>
                                <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="searchResults" style="display: none;">
                            <h3 style="margin-bottom: 16px;">Search Results</h3>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Round</th>
                                            <th>Employee</th>
                                            <th>Product</th>
                                            <th>Count</th>
                                            <th>Day Status</th>
                                            <th>Quality</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResultsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Modals -->
                    <div id="closeDayModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-title">Close Production Day</div>
                            <div class="modal-body">
                                Are you sure you want to close this production day? Once closed, normal users will not be able to edit entries. Only admins can reopen or edit closed days.
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="hideModal('closeDayModal')">Cancel</button>
                                <button class="btn btn-close-day" onclick="closeDay()">Close Day</button>
                            </div>
                        </div>
                    </div>

                    <div id="upsertModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-title">Duplicate Entry Found</div>
                            <div class="modal-body" id="upsertModalBody">
                                This combination of date, round, employee, and product already exists. How would you like to proceed?
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="handleUpsert('cancel')">Cancel</button>
                                <button class="btn btn-primary" onclick="handleUpsert('add')">Add to Existing</button>
                                <button class="btn btn-success" onclick="handleUpsert('replace')">Replace</button>
                            </div>
                        </div>
                    </div>
                `
            },
            'other-production': {
                title: 'Other Production',
                breadcrumb: 'Product Management / Product Inflow / Other Production',
                content: `
                    <h2>Other Production</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Track production of other items such as sauces, sides, and specialty products.
                    </p>
                `
            },
            'product-outflow': {
                title: 'Product Outflow',
                breadcrumb: 'Product Management / Product Outflow',
                content: `
                    <h2>Product Outflow Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Track products leaving the facility for distribution, sales, or delivery.
                    </p>
                `
            },
            'inventory': {
                title: 'Inventory',
                breadcrumb: 'Inventory Management',
                content: `
                    <h2>Inventory Overview</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Comprehensive view of current inventory levels, stock alerts, and warehouse management.
                    </p>
                `
            },
            'inflow': {
                title: 'Inventory Inflow',
                breadcrumb: 'Inventory Management / Inflow',
                content: `
                    <h2>Inventory Inflow</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Record and track all incoming inventory items and raw materials.
                    </p>
                `
            },
            'outflow': {
                title: 'Inventory Outflow',
                breadcrumb: 'Inventory Management / Outflow',
                content: `
                    <h2>Inventory Outflow</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Track inventory items used in production or sold to customers.
                    </p>
                `
            },
            'net-change': {
                title: 'Net Change',
                breadcrumb: 'Inventory Management / Net Change',
                content: `
                    <h2>Inventory Net Change</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Analyze the net change in inventory levels over time periods.
                    </p>
                `
            },
            'sale': {
                title: 'Sales',
                breadcrumb: 'Sales Management',
                content: `
                    <h2>Sales Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        View sales transactions, generate reports, and analyze sales performance.
                    </p>
                `
            },
            'wage': {
                title: 'Wage Management',
                breadcrumb: 'HR / Wage Management',
                content: `
                    <h2>Wage Management</h2>
                    <p style="margin-top: 16px; color: #666;">
                        Manage employee wages, payroll processing, and compensation records.
                    </p>
                `
            },
            'setup': {
                title: 'System Setup',
                breadcrumb: 'Administration / Setup',
                content: `
                    <div class="product-section">
                        <div class="section-header">
                            <h2 class="section-title">Product Management</h2>
                            <button class="btn btn-primary" onclick="toggleProductForm()">
                                <span>+</span> Add New Product
                            </button>
                        </div>

                        <!-- Product Form -->
                        <div id="productForm" class="product-form">
                            <h3 style="margin-bottom: 20px; font-size: 18px;" id="formTitle">Add New Product</h3>
                            <form onsubmit="saveProduct(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Product ID<span class="required">*</span></label>
                                        <input type="number" id="productId" class="form-input" disabled required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Product Name (Thai)<span class="required">*</span></label>
                                        <input type="text" id="productNameThai" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Product Name (English)<span class="required">*</span></label>
                                        <input type="text" id="productNameEn" class="form-input" placeholder="Product name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Unit<span class="required">*</span></label>
                                        <input type="text" id="productUnit" class="form-input" placeholder="e.g., pieces, kg, boxes" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Department<span class="required">*</span></label>
                                        <select id="productDepartment" class="form-select" required>
                                            <option value="">Select Department</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status<span class="required">*</span></label>
                                        <select id="productStatus" class="form-select" required>
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="cancelProductForm()">Cancel</button>
                                    <button type="submit" class="btn btn-success" id="saveBtn">Save Product</button>
                                </div>
                            </form>
                        </div>

                        <!-- Product List -->
                        <div id="productListContainer">
                            <table class="product-table" id="productTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Product Name (Thai)</th>
                                        <th>Product Name (English)</th>
                                        <th>Unit</th>
                                        <th>Department</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <!-- Products will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Department Management Section -->
                    <div class="product-section">
                        <div class="section-header">
                            <h2 class="section-title">Department Management</h2>
                            <button class="btn btn-primary" onclick="toggleDepartmentForm()">
                                <span>+</span> Add New Department
                            </button>
                        </div>

                        <!-- Department Form -->
                        <div id="departmentForm" class="product-form">
                            <h3 style="margin-bottom: 20px; font-size: 18px;" id="departmentFormTitle">Add New Department</h3>
                            <form onsubmit="saveDepartment(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Department ID<span class="required">*</span></label>
                                        <input type="number" id="departmentId" class="form-input" disabled required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Department Name<span class="required">*</span></label>
                                        <input type="text" id="departmentName" class="form-input" placeholder="Department name" required>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="cancelDepartmentForm()">Cancel</button>
                                    <button type="submit" class="btn btn-success" id="departmentSaveBtn">Save Department</button>
                                </div>
                            </form>
                        </div>

                        <!-- Department List -->
                        <div id="departmentListContainer">
                            <table class="product-table" id="departmentTable">
                                <thead>
                                    <tr>
                                        <th>Department ID</th>
                                        <th>Department Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="departmentTableBody">
                                    <!-- Departments will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Employee Management Section -->
                    <div class="product-section">
                        <div class="section-header">
                            <h2 class="section-title">Employee Management</h2>
                            <button class="btn btn-primary" onclick="toggleEmployeeForm()">
                                <span>+</span> Add New Employee
                            </button>
                        </div>

                        <!-- Employee Form -->
                        <div id="employeeForm" class="product-form">
                            <h3 style="margin-bottom: 20px; font-size: 18px;" id="employeeFormTitle">Add New Employee</h3>
                            <form onsubmit="saveEmployee(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Employee ID<span class="required">*</span></label>
                                        <input type="number" id="employeeId" class="form-input" disabled required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Name in Thai<span class="required">*</span></label>
                                        <input type="text" id="employeeNameThai" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Name in Other Language<span class="required">*</span></label>
                                        <input type="text" id="employeeNameOther" class="form-input" placeholder="Employee name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Department<span class="required">*</span></label>
                                        <select id="employeeDepartment" class="form-select" required>
                                            <option value="">Select Department</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status<span class="required">*</span></label>
                                        <select id="employeeStatus" class="form-select" required>
                                            <option value="Active">Active</option>
                                            <option value="On leave">On leave</option>
                                            <option value="Resigned">Resigned</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="cancelEmployeeForm()">Cancel</button>
                                    <button type="submit" class="btn btn-success" id="employeeSaveBtn">Save Employee</button>
                                </div>
                            </form>
                        </div>

                        <!-- Employee List -->
                        <div id="employeeListContainer">
                            <table class="product-table" id="employeeTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name (Thai)</th>
                                        <th>Name (Other Language)</th>
                                        <th>Department ID</th>
                                        <th>Department</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeTableBody">
                                    <!-- Employees will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `
            }
        };

        // State management
        let currentRole = 'user';
        let currentPage = 'home';
        let expandedMenus = new Set();

        // Initialize the application
        function init() {
            renderMenu();
            navigateToPage('home');
        }

        // Handle role change
        function handleRoleChange() {
            currentRole = document.getElementById('roleSelect').value;
            renderMenu();

            // If current page is not accessible in new role, navigate to home
            const currentMenuItem = menuConfig.find(item => item.id === currentPage);
            if (currentMenuItem && !currentMenuItem.roles.includes(currentRole)) {
                navigateToPage('home');
            }
        }

        // Render menu based on current role
        function renderMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.innerHTML = '';

            menuConfig.forEach(item => {
                // Check if user has access to this menu item
                if (!item.roles.includes(currentRole)) {
                    return;
                }

                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';

                const hasSubmenu = item.submenu && item.submenu.length > 0;
                const isExpanded = expandedMenus.has(item.id);

                // Create main menu item
                const mainItem = document.createElement('div');
                mainItem.className = `menu-item-main ${item.colorClass}`;
                if (currentPage === item.id) {
                    mainItem.classList.add(item.roles.includes('admin') && !item.roles.includes('user') ? 'active-admin' : 'active');
                }

                mainItem.innerHTML = `
                    <div class="menu-label">
                        <span class="menu-icon">${item.icon}</span>
                        <span>${item.label}</span>
                    </div>
                    ${hasSubmenu ? '<span class="submenu-toggle ' + (isExpanded ? 'expanded' : '') + '">‚ñº</span>' : ''}
                `;

                mainItem.onclick = () => {
                    if (hasSubmenu) {
                        toggleSubmenu(item.id);
                    } else {
                        navigateToPage(item.id);
                    }
                };

                menuItem.appendChild(mainItem);

                // Create submenu if exists
                if (hasSubmenu) {
                    const submenu = document.createElement('div');
                    submenu.className = 'submenu' + (isExpanded ? ' show' : '');

                    item.submenu.forEach(subItem => {
                        const submenuItem = document.createElement('div');
                        submenuItem.className = 'submenu-item';
                        if (currentPage === subItem.id) {
                            submenuItem.classList.add('active');
                        }
                        submenuItem.textContent = subItem.label;
                        submenuItem.onclick = (e) => {
                            e.stopPropagation();
                            navigateToPage(subItem.id);
                        };
                        submenu.appendChild(submenuItem);
                    });

                    menuItem.appendChild(submenu);
                }

                navMenu.appendChild(menuItem);
            });
        }

        // Toggle submenu
        function toggleSubmenu(menuId) {
            if (expandedMenus.has(menuId)) {
                expandedMenus.delete(menuId);
            } else {
                expandedMenus.add(menuId);
            }
            renderMenu();
        }

        // Navigate to page
        function navigateToPage(pageId) {
            currentPage = pageId;

            const page = pageContent[pageId];
            if (page) {
                document.getElementById('pageTitle').textContent = page.title;
                document.getElementById('breadcrumb').textContent = page.breadcrumb;
                document.getElementById('mainContent').innerHTML = page.content;
            }

            // Expand parent menu if navigating to submenu item
            menuConfig.forEach(item => {
                if (item.submenu && item.submenu.some(sub => sub.id === pageId)) {
                    expandedMenus.add(item.id);
                }
            });

            renderMenu();
        }

        // Product Management Functions
        let products = [];
        let editingProductId = null;

        // Load products from localStorage
        function loadProducts() {
            const stored = localStorage.getItem('wontonProducts');
            if (stored) {
                products = JSON.parse(stored);
            }
        }

        // Save products to localStorage
        function saveProductsToStorage() {
            localStorage.setItem('wontonProducts', JSON.stringify(products));
        }

        // Get next product ID
        function getNextProductId() {
            if (products.length === 0) return 11;
            return Math.max(...products.map(p => p.id)) + 1;
        }

        // Format product ID as 2-digit string
        function formatProductId(id) {
            return String(id).padStart(2, '0');
        }

        // Toggle product form
        function toggleProductForm() {
            const form = document.getElementById('productForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetProductForm();
                updateProductDepartmentDropdown();
                form.classList.add('show');
                editingProductId = null;
                document.getElementById('formTitle').textContent = 'Add New Product';
                document.getElementById('saveBtn').textContent = 'Save Product';
                document.getElementById('productId').value = formatProductId(getNextProductId());
            }
        }

        // Reset product form
        function resetProductForm() {
            document.getElementById('productId').value = '';
            document.getElementById('productNameThai').value = '';
            document.getElementById('productNameEn').value = '';
            document.getElementById('productUnit').value = '';
            document.getElementById('productDepartment').value = '';
            document.getElementById('productStatus').value = 'Active';
        }

        // Cancel product form
        function cancelProductForm() {
            document.getElementById('productForm').classList.remove('show');
            resetProductForm();
            editingProductId = null;
        }

        // Save product
        function saveProduct(event) {
            event.preventDefault();

            const departmentId = parseInt(document.getElementById('productDepartment').value);

            const product = {
                id: parseInt(document.getElementById('productId').value),
                nameThai: document.getElementById('productNameThai').value,
                nameEn: document.getElementById('productNameEn').value,
                unit: document.getElementById('productUnit').value,
                departmentId: departmentId,
                departmentName: getDepartmentNameById(departmentId),
                status: document.getElementById('productStatus').value
            };

            if (editingProductId !== null) {
                // Update existing product
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    products[index] = product;
                }
            } else {
                // Add new product
                products.push(product);
            }

            saveProductsToStorage();
            renderProductTable();
            cancelProductForm();
        }

        // Edit product
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('saveBtn').textContent = 'Update Product';

            document.getElementById('productId').value = formatProductId(product.id);
            document.getElementById('productNameThai').value = product.nameThai;
            document.getElementById('productNameEn').value = product.nameEn;
            document.getElementById('productUnit').value = product.unit;
            updateProductDepartmentDropdown();
            document.getElementById('productDepartment').value = product.departmentId;
            document.getElementById('productStatus').value = product.status;

            document.getElementById('productForm').classList.add('show');

            // Scroll to form
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Update product department dropdown
        function updateProductDepartmentDropdown() {
            const select = document.getElementById('productDepartment');
            if (!select) return;

            const currentValue = select.value;

            // Clear and rebuild options
            select.innerHTML = '<option value="">Select Department</option>';

            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = `${formatDepartmentId(dept.id)} - ${dept.name}`;
                select.appendChild(option);
            });

            // Restore selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Render product table
        function renderProductTable() {
            const tbody = document.getElementById('productTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <div class="empty-state-text">No products yet. Click "Add New Product" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${formatProductId(product.id)}</td>
                    <td>${product.nameThai}</td>
                    <td>${product.nameEn}</td>
                    <td>${product.unit}</td>
                    <td>${product.departmentName || 'N/A'}</td>
                    <td>
                        <span class="status-badge status-${product.status.toLowerCase()}">
                            ${product.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editProduct(${product.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Department Management Functions
        let departments = [];
        let editingDepartmentId = null;

        // Load departments from localStorage
        function loadDepartments() {
            const stored = localStorage.getItem('wontonDepartments');
            if (stored) {
                departments = JSON.parse(stored);
            }
        }

        // Save departments to localStorage
        function saveDepartmentsToStorage() {
            localStorage.setItem('wontonDepartments', JSON.stringify(departments));
        }

        // Get next department ID
        function getNextDepartmentId() {
            if (departments.length === 0) return 1;
            return Math.max(...departments.map(d => d.id)) + 1;
        }

        // Format department ID as 2-digit string
        function formatDepartmentId(id) {
            return String(id).padStart(2, '0');
        }

        // Toggle department form
        function toggleDepartmentForm() {
            const form = document.getElementById('departmentForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetDepartmentForm();
                form.classList.add('show');
                editingDepartmentId = null;
                document.getElementById('departmentFormTitle').textContent = 'Add New Department';
                document.getElementById('departmentSaveBtn').textContent = 'Save Department';
                document.getElementById('departmentId').value = formatDepartmentId(getNextDepartmentId());
            }
        }

        // Reset department form
        function resetDepartmentForm() {
            document.getElementById('departmentId').value = '';
            document.getElementById('departmentName').value = '';
        }

        // Cancel department form
        function cancelDepartmentForm() {
            document.getElementById('departmentForm').classList.remove('show');
            resetDepartmentForm();
            editingDepartmentId = null;
        }

        // Save department
        function saveDepartment(event) {
            event.preventDefault();

            const department = {
                id: parseInt(document.getElementById('departmentId').value),
                name: document.getElementById('departmentName').value
            };

            if (editingDepartmentId !== null) {
                // Update existing department
                const index = departments.findIndex(d => d.id === editingDepartmentId);
                if (index !== -1) {
                    departments[index] = department;
                }
            } else {
                // Add new department
                departments.push(department);
            }

            saveDepartmentsToStorage();
            renderDepartmentTable();
            updateEmployeeDepartmentDropdown();
            updateProductDepartmentDropdown();
            cancelDepartmentForm();
        }

        // Edit department
        function editDepartment(departmentId) {
            const department = departments.find(d => d.id === departmentId);
            if (!department) return;

            editingDepartmentId = departmentId;
            document.getElementById('departmentFormTitle').textContent = 'Edit Department';
            document.getElementById('departmentSaveBtn').textContent = 'Update Department';

            document.getElementById('departmentId').value = formatDepartmentId(department.id);
            document.getElementById('departmentName').value = department.name;

            document.getElementById('departmentForm').classList.add('show');

            // Scroll to form
            document.getElementById('departmentForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Render department table
        function renderDepartmentTable() {
            const tbody = document.getElementById('departmentTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (departments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3">
                            <div class="empty-state">
                                <div class="empty-state-icon">üè¢</div>
                                <div class="empty-state-text">No departments yet. Click "Add New Department" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = departments.map(department => `
                <tr>
                    <td>${formatDepartmentId(department.id)}</td>
                    <td>${department.name}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editDepartment(${department.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Employee Management Functions
        let employees = [];
        let editingEmployeeId = null;

        // Load employees from localStorage
        function loadEmployees() {
            const stored = localStorage.getItem('wontonEmployees');
            if (stored) {
                employees = JSON.parse(stored);
            }
        }

        // Save employees to localStorage
        function saveEmployeesToStorage() {
            localStorage.setItem('wontonEmployees', JSON.stringify(employees));
        }

        // Get next employee ID
        function getNextEmployeeId() {
            if (employees.length === 0) return 1;
            return Math.max(...employees.map(e => e.id)) + 1;
        }

        // Format employee ID as 2-digit string
        function formatEmployeeId(id) {
            return String(id).padStart(2, '0');
        }

        // Update employee department dropdown
        function updateEmployeeDepartmentDropdown() {
            const select = document.getElementById('employeeDepartment');
            if (!select) return;

            const currentValue = select.value;

            // Clear and rebuild options
            select.innerHTML = '<option value="">Select Department</option>';

            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = `${formatDepartmentId(dept.id)} - ${dept.name}`;
                select.appendChild(option);
            });

            // Restore selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Get department name by ID
        function getDepartmentNameById(deptId) {
            const dept = departments.find(d => d.id === deptId);
            return dept ? dept.name : 'N/A';
        }

        // Toggle employee form
        function toggleEmployeeForm() {
            const form = document.getElementById('employeeForm');
            const isVisible = form.classList.contains('show');

            if (isVisible) {
                form.classList.remove('show');
            } else {
                resetEmployeeForm();
                updateEmployeeDepartmentDropdown();
                form.classList.add('show');
                editingEmployeeId = null;
                document.getElementById('employeeFormTitle').textContent = 'Add New Employee';
                document.getElementById('employeeSaveBtn').textContent = 'Save Employee';
                document.getElementById('employeeId').value = formatEmployeeId(getNextEmployeeId());
            }
        }

        // Reset employee form
        function resetEmployeeForm() {
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeNameThai').value = '';
            document.getElementById('employeeNameOther').value = '';
            document.getElementById('employeeDepartment').value = '';
            document.getElementById('employeeStatus').value = 'Active';
        }

        // Cancel employee form
        function cancelEmployeeForm() {
            document.getElementById('employeeForm').classList.remove('show');
            resetEmployeeForm();
            editingEmployeeId = null;
        }

        // Save employee
        function saveEmployee(event) {
            event.preventDefault();

            const departmentId = parseInt(document.getElementById('employeeDepartment').value);

            const employee = {
                id: parseInt(document.getElementById('employeeId').value),
                nameThai: document.getElementById('employeeNameThai').value,
                nameOther: document.getElementById('employeeNameOther').value,
                departmentId: departmentId,
                departmentName: getDepartmentNameById(departmentId),
                status: document.getElementById('employeeStatus').value
            };

            if (editingEmployeeId !== null) {
                // Update existing employee
                const index = employees.findIndex(e => e.id === editingEmployeeId);
                if (index !== -1) {
                    employees[index] = employee;
                }
            } else {
                // Add new employee
                employees.push(employee);
            }

            saveEmployeesToStorage();
            renderEmployeeTable();
            cancelEmployeeForm();
        }

        // Edit employee
        function editEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            editingEmployeeId = employeeId;
            document.getElementById('employeeFormTitle').textContent = 'Edit Employee';
            document.getElementById('employeeSaveBtn').textContent = 'Update Employee';

            document.getElementById('employeeId').value = formatEmployeeId(employee.id);
            document.getElementById('employeeNameThai').value = employee.nameThai;
            document.getElementById('employeeNameOther').value = employee.nameOther;
            updateEmployeeDepartmentDropdown();
            document.getElementById('employeeDepartment').value = employee.departmentId;
            document.getElementById('employeeStatus').value = employee.status;

            document.getElementById('employeeForm').classList.add('show');

            // Scroll to form
            document.getElementById('employeeForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Render employee table
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');

            if (!tbody) return; // Guard clause if not on setup page

            if (employees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div class="empty-state-text">No employees yet. Click "Add New Employee" to get started.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = employees.map(employee => `
                <tr>
                    <td>${formatEmployeeId(employee.id)}</td>
                    <td>${employee.nameThai}</td>
                    <td>${employee.nameOther}</td>
                    <td>${formatDepartmentId(employee.departmentId)}</td>
                    <td>${employee.departmentName}</td>
                    <td>
                        <span class="status-badge status-${employee.status.toLowerCase().replace(' ', '-')}">
                            ${employee.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-small" onclick="editEmployee(${employee.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Modified navigateToPage function to render products when navigating to setup
        const originalNavigateToPage = navigateToPage;
        navigateToPage = function(pageId) {
            originalNavigateToPage(pageId);

            // If navigating to setup page, render the product table
            if (pageId === 'setup') {
                setTimeout(() => {
                    renderProductTable();
                    renderDepartmentTable();
                    renderEmployeeTable();
                }, 10);
            }

            // If navigating to dumpling production page, initialize it
            if (pageId === 'dumpling-production') {
                setTimeout(() => {
                    initProductionPage();
                }, 10);
            }
        };

        // ========== DUMPLING PRODUCTION FEATURE ==========

        // Production state
        let productionRecords = [];
        let dayStatus = {};
        let auditLog = [];
        let qualityStatus = [];
        let currentProductionDate = '';
        let currentRound = 1;
        let pendingUpsertData = null;
        let reportContext = { selectedYear: null, selectedMonth: null };

        // Load production data from localStorage
        function loadProductionData() {
            const storedRecords = localStorage.getItem('wontonProductionRecords');
            if (storedRecords) {
                productionRecords = JSON.parse(storedRecords);
            }

            const storedDayStatus = localStorage.getItem('wontonDayStatus');
            if (storedDayStatus) {
                dayStatus = JSON.parse(storedDayStatus);
            }

            const storedAudit = localStorage.getItem('wontonProductionAudit');
            if (storedAudit) {
                auditLog = JSON.parse(storedAudit);
            }

            const storedQuality = localStorage.getItem('wontonQualityStatus');
            if (storedQuality) {
                qualityStatus = JSON.parse(storedQuality);
            }
        }

        // Save production data to localStorage
        function saveProductionRecords() {
            localStorage.setItem('wontonProductionRecords', JSON.stringify(productionRecords));
        }

        function saveDayStatus() {
            localStorage.setItem('wontonDayStatus', JSON.stringify(dayStatus));
        }

        function saveAuditLog() {
            localStorage.setItem('wontonProductionAudit', JSON.stringify(auditLog));
        }

        function saveQualityStatus() {
            localStorage.setItem('wontonQualityStatus', JSON.stringify(qualityStatus));
        }

        // Initialize production page
        function initProductionPage() {
            loadProductionData();

            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('productionDate').value = today;
            currentProductionDate = today;

            // Load the production day
            loadProductionDay();

            // Initialize search dropdowns
            populateSearchDropdowns();

            // Load year view for reports
            loadYearView();
        }

        // Get eligible employees (Dept 01 + Active)
        function getEligibleEmployees() {
            return employees.filter(e => e.departmentId === 1 && e.status === 'Active');
        }

        // Get eligible products (Dept 01 + Active)
        function getEligibleProducts() {
            return products.filter(p => p.departmentId === 1 && p.status === 'Active');
        }

        // Get employee by ID (including historical)
        function getEmployeeById(id) {
            return employees.find(e => e.id === id);
        }

        // Get product by ID (including historical)
        function getProductById(id) {
            return products.find(p => p.id === id);
        }

        // Load production day
        function loadProductionDay() {
            const date = document.getElementById('productionDate').value;
            currentProductionDate = date;

            // Get rounds for this date
            const rounds = getDateRounds(date);
            if (rounds.length === 0) {
                currentRound = 1;
            } else {
                currentRound = rounds[rounds.length - 1]; // Latest round
            }

            // Render rounds
            renderRounds(rounds);

            // Update day status
            updateDayStatusUI();

            // Render entry grid
            renderEntryGrid();

            // Update summaries
            updateSummaries();

            // Render quality checks
            renderQualityChecks();
        }

        // Get rounds for a specific date
        function getDateRounds(date) {
            const dateRecords = productionRecords.filter(r => r.date === date);
            const uniqueRounds = [...new Set(dateRecords.map(r => r.round))];
            return uniqueRounds.sort((a, b) => a - b);
        }

        // Render rounds selector
        function renderRounds(rounds) {
            const container = document.getElementById('roundSelector');
            if (!container) return;

            container.innerHTML = '';

            // Render existing rounds
            rounds.forEach(round => {
                const btn = document.createElement('button');
                btn.className = 'round-btn' + (round === currentRound ? ' active' : '');
                btn.textContent = `Round ${round}`;
                btn.onclick = () => selectRound(round);
                container.appendChild(btn);
            });

            // Add new round button
            const status = dayStatus[currentProductionDate] || 'Open';
            if (status === 'Open' || currentRole === 'admin') {
                const newBtn = document.createElement('button');
                newBtn.className = 'round-btn new-round';
                newBtn.textContent = '+ Add Round';
                newBtn.onclick = () => addNewRound();
                container.appendChild(newBtn);
            }
        }

        // Select a round
        function selectRound(round) {
            currentRound = round;
            loadProductionDay();
        }

        // Add new round
        function addNewRound() {
            const rounds = getDateRounds(currentProductionDate);
            const nextRound = rounds.length > 0 ? Math.max(...rounds) + 1 : 1;
            currentRound = nextRound;
            loadProductionDay();
        }

        // Update day status UI
        function updateDayStatusUI() {
            const status = dayStatus[currentProductionDate] || 'Open';
            const badge = document.getElementById('dayStatusBadge');
            const closeDayBtn = document.getElementById('closeDayBtn');
            const reopenDayBtn = document.getElementById('reopenDayBtn');

            if (!badge) return;

            badge.className = `day-status-badge ${status.toLowerCase()}`;
            badge.innerHTML = status === 'Open'
                ? '<span>‚óè</span> Open'
                : '<span>‚óè</span> Closed';

            if (status === 'Open') {
                closeDayBtn.style.display = 'block';
                reopenDayBtn.style.display = 'none';
            } else {
                closeDayBtn.style.display = 'none';
                reopenDayBtn.style.display = currentRole === 'admin' ? 'block' : 'none';
            }
        }

        // Render entry grid
        function renderEntryGrid() {
            const container = document.getElementById('entryGridBody');
            if (!container) return;

            container.innerHTML = '';

            const eligibleEmployees = getEligibleEmployees();
            const eligibleProducts = getEligibleProducts();

            // Get existing entries for current date and round
            const existingEntries = productionRecords.filter(
                r => r.date === currentProductionDate && r.round === currentRound
            );

            // Check if day is closed
            const status = dayStatus[currentProductionDate] || 'Open';
            const isEditable = status === 'Open' || currentRole === 'admin';

            // Create entry rows
            let rowNum = 1;
            eligibleEmployees.forEach(emp => {
                eligibleProducts.forEach(prod => {
                    const existing = existingEntries.find(
                        e => e.employeeId === emp.id && e.productId === prod.id
                    );

                    const row = document.createElement('div');
                    row.className = 'entry-row';
                    row.innerHTML = `
                        <div>${rowNum}</div>
                        <div>${emp.nameThai}</div>
                        <div>${prod.nameThai}</div>
                        <div>
                            <input type="number"
                                class="entry-input"
                                id="count_${emp.id}_${prod.id}"
                                value="${existing ? existing.count : ''}"
                                min="0"
                                ${!isEditable ? 'disabled' : ''}
                                placeholder="0">
                        </div>
                        <div>
                            <input type="text"
                                class="entry-input"
                                id="notes_${emp.id}_${prod.id}"
                                value="${existing ? existing.notes || '' : ''}"
                                ${!isEditable ? 'disabled' : ''}
                                placeholder="Optional notes">
                        </div>
                        <div>
                            ${existing ? '<span style="color: #4CAF50;">‚úì</span>' : ''}
                        </div>
                    `;

                    container.appendChild(row);
                    rowNum++;
                });
            });

            // Update active counts
            document.getElementById('activeEmployees').textContent = eligibleEmployees.length;
            document.getElementById('activeProducts').textContent = eligibleProducts.length;
        }

        // Save all entries
        function saveAllEntries() {
            const status = dayStatus[currentProductionDate] || 'Open';
            if (status === 'Closed' && currentRole !== 'admin') {
                alert('This day is closed. Only admins can edit closed days.');
                return;
            }

            const eligibleEmployees = getEligibleEmployees();
            const eligibleProducts = getEligibleProducts();

            eligibleEmployees.forEach(emp => {
                eligibleProducts.forEach(prod => {
                    const countInput = document.getElementById(`count_${emp.id}_${prod.id}`);
                    const notesInput = document.getElementById(`notes_${emp.id}_${prod.id}`);

                    if (countInput && countInput.value !== '') {
                        const count = parseInt(countInput.value) || 0;
                        const notes = notesInput ? notesInput.value : '';

                        saveEntry(emp.id, prod.id, count, notes);
                    }
                });
            });

            saveProductionRecords();
            alert('All entries saved successfully!');
            loadProductionDay();
        }

        // Save individual entry
        function saveEntry(employeeId, productId, count, notes) {
            const key = {
                date: currentProductionDate,
                round: currentRound,
                employeeId: employeeId,
                productId: productId
            };

            // Find existing entry
            const existingIndex = productionRecords.findIndex(r =>
                r.date === key.date &&
                r.round === key.round &&
                r.employeeId === key.employeeId &&
                r.productId === key.productId
            );

            const now = Date.now();

            if (existingIndex !== -1) {
                // Update existing entry
                const oldEntry = { ...productionRecords[existingIndex] };
                productionRecords[existingIndex].count = count;
                productionRecords[existingIndex].notes = notes;
                productionRecords[existingIndex].updatedAt = now;

                // Add audit log
                addAuditLog(key, oldEntry.count, count, 'Updated');
            } else {
                // Create new entry
                const entry = {
                    id: Date.now() + Math.random(),
                    ...key,
                    count: count,
                    notes: notes,
                    createdAt: now,
                    updatedAt: now
                };
                productionRecords.push(entry);

                // Add audit log
                addAuditLog(key, null, count, 'Created');
            }
        }

        // Add audit log entry
        function addAuditLog(key, oldValue, newValue, action) {
            const status = dayStatus[key.date] || 'Open';

            auditLog.push({
                id: Date.now() + Math.random(),
                date: key.date,
                round: key.round,
                employeeId: key.employeeId,
                productId: key.productId,
                oldValue: oldValue,
                newValue: newValue,
                action: action,
                dayStatus: status,
                editedBy: currentRole,
                timestamp: Date.now()
            });

            saveAuditLog();
        }

        // Update summaries
        function updateSummaries() {
            // Total packs for current round
            const roundRecords = productionRecords.filter(
                r => r.date === currentProductionDate && r.round === currentRound
            );
            const roundTotal = roundRecords.reduce((sum, r) => sum + r.count, 0);
            document.getElementById('totalPacksRound').textContent = roundTotal;

            // Total packs for today (all rounds)
            const dayRecords = productionRecords.filter(r => r.date === currentProductionDate);
            const dayTotal = dayRecords.reduce((sum, r) => sum + r.count, 0);
            document.getElementById('totalPacksDay').textContent = dayTotal;
        }

        // Render quality checks
        function renderQualityChecks() {
            const container = document.getElementById('qualityCheckList');
            if (!container) return;

            container.innerHTML = '';

            // Get unique employee-product combinations for today
            const dayRecords = productionRecords.filter(r => r.date === currentProductionDate);
            const combinations = new Map();

            dayRecords.forEach(r => {
                const key = `${r.employeeId}_${r.productId}`;
                if (!combinations.has(key)) {
                    combinations.set(key, { employeeId: r.employeeId, productId: r.productId });
                }
            });

            if (combinations.size === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No production entries for today yet.</div>';
                return;
            }

            // Add header
            const header = document.createElement('div');
            header.className = 'quality-row';
            header.style.fontWeight = '600';
            header.style.background = '#f5f5f5';
            header.innerHTML = `
                <div>Employee</div>
                <div>Product</div>
                <div>Total Packs</div>
                <div>Quality Status</div>
                <div>Notes</div>
            `;
            container.appendChild(header);

            // Render quality check rows
            combinations.forEach(combo => {
                const emp = getEmployeeById(combo.employeeId);
                const prod = getProductById(combo.productId);

                if (!emp || !prod) return;

                // Calculate total for this combination
                const total = dayRecords
                    .filter(r => r.employeeId === combo.employeeId && r.productId === combo.productId)
                    .reduce((sum, r) => sum + r.count, 0);

                // Get existing quality status
                const existing = qualityStatus.find(
                    q => q.date === currentProductionDate &&
                         q.employeeId === combo.employeeId &&
                         q.productId === combo.productId
                );

                const status = existing ? existing.status : 'Pending';
                const notes = existing ? existing.notes || '' : '';

                const row = document.createElement('div');
                row.className = 'quality-row';
                row.innerHTML = `
                    <div>${emp.nameThai}</div>
                    <div>${prod.nameThai}</div>
                    <div><strong>${total}</strong> packs</div>
                    <div>
                        <select class="entry-select" id="qstatus_${combo.employeeId}_${combo.productId}" onchange="saveQualityStatus(${combo.employeeId}, ${combo.productId})">
                            <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="OK" ${status === 'OK' ? 'selected' : ''}>OK</option>
                            <option value="Not OK" ${status === 'Not OK' ? 'selected' : ''}>Not OK</option>
                        </select>
                    </div>
                    <div>
                        <input type="text" class="entry-input" id="qnotes_${combo.employeeId}_${combo.productId}" value="${notes}" placeholder="Optional notes" onchange="saveQualityStatus(${combo.employeeId}, ${combo.productId})">
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // Save quality status
        function saveQualityStatus(employeeId, productId) {
            const statusSelect = document.getElementById(`qstatus_${employeeId}_${productId}`);
            const notesInput = document.getElementById(`qnotes_${employeeId}_${productId}`);

            if (!statusSelect) return;

            const status = statusSelect.value;
            const notes = notesInput ? notesInput.value : '';

            // Find existing quality status
            const existingIndex = qualityStatus.findIndex(
                q => q.date === currentProductionDate &&
                     q.employeeId === employeeId &&
                     q.productId === productId
            );

            const qualityData = {
                date: currentProductionDate,
                employeeId: employeeId,
                productId: productId,
                status: status,
                notes: notes,
                updatedAt: Date.now()
            };

            if (existingIndex !== -1) {
                qualityStatus[existingIndex] = qualityData;
            } else {
                qualityStatus.push(qualityData);
            }

            // Save to localStorage
            localStorage.setItem('wontonQualityStatus', JSON.stringify(qualityStatus));
        }

        // Close day modal
        function closeDayModal() {
            showModal('closeDayModal');
        }

        // Close day
        function closeDay() {
            dayStatus[currentProductionDate] = 'Closed';
            saveDayStatus();

            // Add audit log
            auditLog.push({
                id: Date.now() + Math.random(),
                date: currentProductionDate,
                action: 'Day Closed',
                editedBy: currentRole,
                timestamp: Date.now()
            });
            saveAuditLog();

            hideModal('closeDayModal');
            updateDayStatusUI();
            renderEntryGrid();
            renderRounds(getDateRounds(currentProductionDate));

            alert(`Production day ${currentProductionDate} has been closed.`);
        }

        // Reopen day
        function reopenDay() {
            if (currentRole !== 'admin') {
                alert('Only admins can reopen closed days.');
                return;
            }

            dayStatus[currentProductionDate] = 'Open';
            saveDayStatus();

            // Add audit log
            auditLog.push({
                id: Date.now() + Math.random(),
                date: currentProductionDate,
                action: 'Day Reopened',
                editedBy: currentRole,
                timestamp: Date.now()
            });
            saveAuditLog();

            updateDayStatusUI();
            renderEntryGrid();
            renderRounds(getDateRounds(currentProductionDate));

            alert(`Production day ${currentProductionDate} has been reopened.`);
        }

        // Show modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
            }
        }

        // Hide modal
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Switch production tab
        function switchProductionTab(tabName) {
            // Update tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'reports') {
                loadYearView();
            } else if (tabName === 'search') {
                populateSearchDropdowns();
            }
        }

        // ========== REPORTS ==========

        // Show report view
        function showReportView(view) {
            // Update nav
            document.querySelectorAll('.nav-chip').forEach(chip => chip.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all views
            document.querySelectorAll('.report-view').forEach(v => v.style.display = 'none');

            // Show selected view
            document.getElementById(`${view}-view`).style.display = 'block';

            // Load data
            if (view === 'year') {
                loadYearView();
            } else if (view === 'month') {
                loadMonthView(reportContext.selectedYear);
            } else if (view === 'day') {
                loadDayView(reportContext.selectedYear, reportContext.selectedMonth);
            }
        }

        // Load year view
        function loadYearView() {
            const tbody = document.getElementById('yearViewBody');
            if (!tbody) return;

            // Group records by year
            const yearData = {};
            productionRecords.forEach(r => {
                const year = r.date.substring(0, 4);
                if (!yearData[year]) {
                    yearData[year] = {
                        totalPacks: 0,
                        dates: new Set(),
                        employees: new Set(),
                        products: new Set()
                    };
                }
                yearData[year].totalPacks += r.count;
                yearData[year].dates.add(r.date);
                yearData[year].employees.add(r.employeeId);
                yearData[year].products.add(r.productId);
            });

            // Render table
            const years = Object.keys(yearData).sort((a, b) => b - a);

            if (years.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No production records yet.</td></tr>';
                return;
            }

            tbody.innerHTML = years.map(year => `
                <tr class="clickable-row" onclick="drillDownToMonth('${year}')">
                    <td><strong>${year}</strong></td>
                    <td>${yearData[year].totalPacks.toLocaleString()} packs</td>
                    <td>${yearData[year].dates.size} days</td>
                    <td>${yearData[year].employees.size} employees</td>
                    <td>${yearData[year].products.size} products</td>
                    <td><button class="btn btn-primary btn-small" onclick="event.stopPropagation(); drillDownToMonth('${year}')">View Details ‚Üí</button></td>
                </tr>
            `).join('');
        }

        // Drill down to month view
        function drillDownToMonth(year) {
            reportContext.selectedYear = year;
            document.getElementById('selectedYear').textContent = year;
            showReportView('month');
            loadMonthView(year);
        }

        // Load month view
        function loadMonthView(year) {
            const tbody = document.getElementById('monthViewBody');
            if (!tbody) return;

            // Group records by month
            const monthData = {};
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            productionRecords
                .filter(r => r.date.startsWith(year))
                .forEach(r => {
                    const month = r.date.substring(5, 7);
                    if (!monthData[month]) {
                        monthData[month] = {
                            totalPacks: 0,
                            dates: new Set()
                        };
                    }
                    monthData[month].totalPacks += r.count;
                    monthData[month].dates.add(r.date);
                });

            // Render table
            const months = Object.keys(monthData).sort();

            if (months.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No production records for this year.</td></tr>';
                return;
            }

            tbody.innerHTML = months.map(month => {
                const monthNum = parseInt(month);
                const avgPerDay = (monthData[month].totalPacks / monthData[month].dates.size).toFixed(0);
                return `
                    <tr class="clickable-row" onclick="drillDownToDay('${year}', '${month}')">
                        <td><strong>${monthNames[monthNum - 1]} ${year}</strong></td>
                        <td>${monthData[month].totalPacks.toLocaleString()} packs</td>
                        <td>${monthData[month].dates.size} days</td>
                        <td>${avgPerDay} packs/day</td>
                        <td><button class="btn btn-primary btn-small" onclick="event.stopPropagation(); drillDownToDay('${year}', '${month}')">View Details ‚Üí</button></td>
                    </tr>
                `;
            }).join('');
        }

        // Drill down to day view
        function drillDownToDay(year, month) {
            reportContext.selectedYear = year;
            reportContext.selectedMonth = month;
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('selectedMonth').textContent = `${monthNames[parseInt(month) - 1]} ${year}`;
            showReportView('day');
            loadDayView(year, month);
        }

        // Load day view
        function loadDayView(year, month) {
            const tbody = document.getElementById('dayViewBody');
            if (!tbody) return;

            // Group records by date
            const dayData = {};

            productionRecords
                .filter(r => r.date.startsWith(`${year}-${month}`))
                .forEach(r => {
                    if (!dayData[r.date]) {
                        dayData[r.date] = {
                            totalPacks: 0,
                            rounds: new Set(),
                            entries: 0
                        };
                    }
                    dayData[r.date].totalPacks += r.count;
                    dayData[r.date].rounds.add(r.round);
                    dayData[r.date].entries++;
                });

            // Render table
            const dates = Object.keys(dayData).sort((a, b) => b.localeCompare(a));

            if (dates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No production records for this month.</td></tr>';
                return;
            }

            tbody.innerHTML = dates.map(date => {
                const status = dayStatus[date] || 'Open';
                const statusBadge = status === 'Open'
                    ? '<span class="status-badge status-active">Open</span>'
                    : '<span class="status-badge status-inactive">Closed</span>';

                return `
                    <tr class="clickable-row" onclick="viewDayDetails('${date}')">
                        <td><strong>${date}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${dayData[date].totalPacks.toLocaleString()} packs</td>
                        <td>${dayData[date].rounds.size} rounds</td>
                        <td>${dayData[date].entries} entries</td>
                        <td><button class="btn btn-primary btn-small" onclick="event.stopPropagation(); viewDayDetails('${date}')">View ‚Üí</button></td>
                    </tr>
                `;
            }).join('');
        }

        // View day details
        function viewDayDetails(date) {
            // Switch to entry tab and load that date
            document.getElementById('productionDate').value = date;
            currentProductionDate = date;
            loadProductionDay();
            switchProductionTab('entry');

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'Entry') {
                    btn.classList.add('active');
                }
            });
        }

        // ========== SEARCH ==========

        // Populate search dropdowns
        function populateSearchDropdowns() {
            // Employee dropdown
            const empSelect = document.getElementById('searchEmployee');
            if (empSelect) {
                empSelect.innerHTML = '<option value="">All Employees</option>';
                employees
                    .filter(e => e.departmentId === 1)
                    .forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.nameThai} (${emp.nameOther})`;
                        empSelect.appendChild(option);
                    });
            }

            // Product dropdown
            const prodSelect = document.getElementById('searchProduct');
            if (prodSelect) {
                prodSelect.innerHTML = '<option value="">All Products</option>';
                products
                    .filter(p => p.departmentId === 1)
                    .forEach(prod => {
                        const option = document.createElement('option');
                        option.value = prod.id;
                        option.textContent = `${prod.nameThai} (${prod.nameEn})`;
                        prodSelect.appendChild(option);
                    });
            }
        }

        // Perform search
        function performSearch() {
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;
            const employeeId = document.getElementById('searchEmployee').value;
            const productId = document.getElementById('searchProduct').value;
            const dayStatusFilter = document.getElementById('searchDayStatus').value;
            const qualityStatusFilter = document.getElementById('searchQualityStatus').value;

            // Filter records
            let results = productionRecords.filter(r => {
                // Date range
                if (dateFrom && r.date < dateFrom) return false;
                if (dateTo && r.date > dateTo) return false;

                // Employee
                if (employeeId && r.employeeId !== parseInt(employeeId)) return false;

                // Product
                if (productId && r.productId !== parseInt(productId)) return false;

                // Day status
                if (dayStatusFilter) {
                    const status = dayStatus[r.date] || 'Open';
                    if (status !== dayStatusFilter) return false;
                }

                return true;
            });

            // Filter by quality status if selected
            if (qualityStatusFilter) {
                results = results.filter(r => {
                    const quality = qualityStatus.find(
                        q => q.date === r.date &&
                             q.employeeId === r.employeeId &&
                             q.productId === r.productId
                    );
                    const status = quality ? quality.status : 'Pending';
                    return status === qualityStatusFilter;
                });
            }

            // Render results
            renderSearchResults(results);
        }

        // Render search results
        function renderSearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            const tbody = document.getElementById('searchResultsBody');

            if (!tbody || !resultsDiv) return;

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No records found matching your search criteria.</td></tr>';
                resultsDiv.style.display = 'block';
                return;
            }

            tbody.innerHTML = results.map(r => {
                const emp = getEmployeeById(r.employeeId);
                const prod = getProductById(r.productId);
                const status = dayStatus[r.date] || 'Open';

                // Get quality status
                const quality = qualityStatus.find(
                    q => q.date === r.date &&
                         q.employeeId === r.employeeId &&
                         q.productId === r.productId
                );
                const qualityBadge = quality
                    ? `<span class="quality-badge quality-${quality.status.toLowerCase().replace(' ', '-')}">${quality.status}</span>`
                    : '<span class="quality-badge quality-pending">Pending</span>';

                const statusBadge = status === 'Open'
                    ? '<span class="status-badge status-active">Open</span>'
                    : '<span class="status-badge status-inactive">Closed</span>';

                return `
                    <tr>
                        <td>${r.date}</td>
                        <td>Round ${r.round}</td>
                        <td>${emp ? emp.nameThai : 'N/A'}</td>
                        <td>${prod ? prod.nameThai : 'N/A'}</td>
                        <td><strong>${r.count}</strong> packs</td>
                        <td>${statusBadge}</td>
                        <td>${qualityBadge}</td>
                    </tr>
                `;
            }).join('');

            resultsDiv.style.display = 'block';
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchDateFrom').value = '';
            document.getElementById('searchDateTo').value = '';
            document.getElementById('searchEmployee').value = '';
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchDayStatus').value = '';
            document.getElementById('searchQualityStatus').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        // ========== END DUMPLING PRODUCTION FEATURE ==========

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadDepartments();
            loadEmployees();
            init();
        });
    </script>
</body>
</html>
